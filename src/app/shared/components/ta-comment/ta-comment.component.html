@let avatar = commentCardsDataDropdown?.companyUser?.avatar;
<!-- Comments for cards -->
@if (commentCardsDataDropdown) {
    @if (editingCardComment) {
        <div class="comments-dropdown editable">
            <div class="d-grid">
                <div class="d-flex align-items-center top-comment-body">
                    @if (!commentCardsDataDropdown.userAvatar) {
                        <div class="d-flex">
                            <span
                                class="user-image d-flex align-items-center justify-content-center ta-font-extra-bold"
                                [style]="{
                                    background:
                                        commentCardsDataDropdown?.avatarColor
                                            ?.background,
                                    color: commentCardsDataDropdown?.avatarColor
                                        ?.color,
                                }"
                                >{{
                                    commentCardsDataDropdown.textShortName
                                }}</span
                            >
                        </div>
                    }

                    @if (avatar) {
                        {{ avatar }}
                        <img
                            src="{{ 'data:image/jpg;base64,' + avatar }}"
                            alt=""
                        />
                    }

                    <div class="d-grid title-holder">
                        <div
                            class="d-flex justify-content-between title-svg-holder"
                        >
                            <div class="d-flex">
                                <span class="title ta-font-semi-bold">{{
                                    commentCardsDataDropdown.companyUser
                                        .fullName
                                }}</span>
                            </div>

                            <span
                                class="title ta-font-semi-bold"
                                [innerHTML]="
                                    commentCardsDataDropdown.fullName
                                        | taCommentHighlistComponentPipe
                                            : commentHighlight
                                "
                            ></span>

                            <!-- if card is edited -->
                            @if (commentCardsDataDropdown.edited) {
                                <span class="card-user-edited ta-font-medium"
                                    >• Edited</span
                                >
                            }
                            <div class="user-icons d-flex">
                                <span
                                    ngbTooltip
                                    mainTooltip="Confirm"
                                    type="button"
                                    tooltipBackground="#CCCCCC"
                                    tooltipColor="#2F2F2F"
                                    customClass="mb-2"
                                    position="top"
                                    (click)="
                                        editComment(commentCardsDataDropdown.id)
                                    "
                                    class="confirm-tooltip d-flex align-items-center justify-content-center"
                                    [tooltipClass]="customClass"
                                >
                                    <svg-icon
                                        class="confirm-icon d-flex align-items-center justify-content-center svg-size-12"
                                        [src]="'assets/svg/applicant/check.svg'"
                                    ></svg-icon>
                                </span>

                                <span
                                    ngbTooltip
                                    mainTooltip="Cancel"
                                    tooltipBackground="#CCCCCC"
                                    tooltipColor="#2F2F2F"
                                    customClass="mb-2"
                                    position="top"
                                    type="button"
                                    (click)="openEditComment(false)"
                                    class="cancel-tooltip d-flex align-items-center justify-content-center"
                                >
                                    <svg-icon
                                        class="cancel-icon d-flex align-items-center justify-content-center svg-size-10"
                                        [src]="
                                            'assets/svg/applicant/invalid-review-x.svg'
                                        "
                                    ></svg-icon>
                                </span>
                            </div>
                        </div>

                        <span class="ta-font-medium muted-text"
                            >Edit Comment</span
                        >
                    </div>
                </div>

                <div
                    #editCommentEl
                    [contentEditable]="true"
                    spellcheck="false"
                    class="edit-textarea"
                    (paste)="onPaste($event)"
                ></div>
            </div>
        </div>
    } @else {
        <div class="comments-dropdown hoverable">
            <div class="d-grid">
                <div class="d-flex align-items-center top-comment-body">
                    @if (!avatar) {
                        <div class="d-flex">
                            <span
                                class="user-image d-flex align-items-center justify-content-center ta-font-extra-bold"
                                [style]="{
                                    background:
                                        commentCardsDataDropdown.avatarColor
                                            ?.background,
                                    color: commentCardsDataDropdown.avatarColor
                                        ?.color,
                                }"
                                >{{
                                    commentCardsDataDropdown?.textShortName
                                }}</span
                            >
                        </div>
                    }

                    <div class="d-grid title-holder">
                        <div
                            class="d-flex justify-content-between title-svg-holder"
                        >
                            <div class="d-flex align-items-center creds-holder">
                                @if (loggedUserCommented) {
                                    <span
                                        class="text-white ta-font-semi-bold"
                                        (click)="
                                            toggleComment(
                                                commentCardsDataDropdown
                                            )
                                        "
                                        [innerHTML]="
                                            commentCardsDataDropdown.companyUser
                                                .fullName
                                                | abbreviateFullname
                                                | taCommentHighlistComponentPipe
                                                    : commentHighlight
                                        "
                                    ></span>
                                } @else {
                                    @if (!loggedUserCommented) {
                                        <span
                                            class="text-white ta-font-semi-bold"
                                            (click)="
                                                toogleComment(
                                                    commentCardsDataDropdown
                                                )
                                            "
                                            [innerHTML]="
                                                commentCardsDataDropdown
                                                    .companyUser.fullName
                                                    | taCommentHighlistComponentPipe
                                                        : commentHighlight
                                            "
                                        ></span>
                                    }
                                }

                                <!-- if owner of the card -->

                                @if (loggedUserCommented) {
                                    <span class="card-user-me ta-font-bold"
                                        >(Me)</span
                                    >
                                }
                                @if (commentCardsDataDropdown.liked) {
                                    <svg-icon
                                        class="like-icon svg-size-13"
                                        [src]="'assets/svg/common/ic_like.svg'"
                                    ></svg-icon>
                                }
                                @if (commentCardsDataDropdown.disliked) {
                                    <svg-icon
                                        class="dislike-icon svg-size-13"
                                        [src]="
                                            'assets/svg/common/ic_dislike.svg'
                                        "
                                    ></svg-icon>
                                }
                            </div>

                            <div class="user-icons d-flex align-items-center">
                                @if (loggedUserCommented) {
                                    <span
                                        ngbTooltip
                                        mainTooltip="Edit"
                                        type="button"
                                        tooltipBackground="#CCCCCC"
                                        tooltipColor="#2F2F2F"
                                        customClass="mb-2"
                                        position="top"
                                        (click)="openEditComment(true)"
                                        class="edit-tooltip d-flex align-items-center justify-content-center"
                                    >
                                        <svg-icon
                                            class="edit-icon svg-size-13"
                                            [src]="
                                                'assets/svg/truckassist-table/dropdown/content/edit.svg'
                                            "
                                        ></svg-icon>
                                    </span>

                                    <span
                                        ngbTooltip
                                        mainTooltip="Delete"
                                        tooltipBackground="#CCCCCC"
                                        tooltipColor="#2F2F2F"
                                        customClass="mb-2"
                                        position="top"
                                        type="button"
                                        class="edit-tooltip d-flex align-items-center justify-content-center"
                                        (click)="
                                            deleteComment(
                                                commentCardsDataDropdown.id
                                            )
                                        "
                                    >
                                        <svg-icon
                                            class="delete-icon svg-size-13"
                                            [src]="
                                                'assets/svg/truckassist-table/dropdown/content/delete.svg'
                                            "
                                        ></svg-icon>
                                    </span>
                                }
                                @if (commentCardsDataDropdown.commentContent) {
                                    <span
                                        class="open-dropdown-icon d-flex align-items-center justify-content-center"
                                    >
                                        @if (
                                            commentCardsDataDropdown
                                                .commentContent.length >= 42
                                        ) {
                                            <svg-icon
                                                [src]="
                                                    'assets/svg/common/fill_arrow_down.svg'
                                                "
                                                [ngClass]="{
                                                    'rotate-svg':
                                                        commentCardsDataDropdown.isOpen,
                                                    'rotate-back':
                                                        !commentCardsDataDropdown.isOpen,
                                                }"
                                                class="arrow-svg-icon"
                                                [svgStyle]="{
                                                    'width.px': 10,
                                                    'height.px': 10,
                                                }"
                                            >
                                            </svg-icon>
                                        }
                                    </span>
                                }
                            </div>
                        </div>

                        <div class="d-flex">
                            <span
                                class="ta-font-medium muted-text"
                                (click)="
                                    toggleComment(commentCardsDataDropdown)
                                "
                                >{{ commentCardsDataDropdown.createdAt }}</span
                            >

                            <!-- if card is edited -->
                            @if (commentCardsDataDropdown?.edited) {
                                <span class="card-user-edited ta-font-medium"
                                    >• Edited</span
                                >
                            }
                        </div>
                    </div>
                </div>
                @if (commentCardsDataDropdown.commentContent) {
                    <span
                        class="text-white comment-text"
                        [ngClass]="{
                            'show-comment': commentCardsDataDropdown.isOpen,
                        }"
                        [@dropdownAnimationComment]="
                            commentCardsDataDropdown.isOpen ? 'true' : 'false'
                        "
                        [innerHTML]="
                            commentCardsDataDropdown.commentContent
                                | taCommentHighlistComponentPipe
                                    : commentHighlight
                        "
                    ></span>
                }
            </div>
        </div>
    }
} @else {
    <div
        class="d-flex flex-column comment-container"
        [ngClass]="{ inactive: !isCommenting }"
    >
        <!-- Comment Header -->

        <div
            class="d-flex align-items-start justify-content-between comment-header"
        >
            <div class="d-flex align-items-center comment-header-left">
                <!-- Regular Layout -->

                @if (isDetailsCommentLayout) {
                    <div class="d-flex align-items-center details-container">
                        <img
                            [ngStyle]="{ 'margin-bottom': !isMe ? '6px' : 0 }"
                            [src]="
                                commentAvatar ??
                                'assets/svg/truckassist-table/user-avatar-no-profile.svg'
                            "
                            alt="User Profile Image"
                        />

                        <div class="d-flex flex-column justify-content-center">
                            <div class="d-flex align-items-center">
                                <p
                                    class="m-0 ta-font-semi-bold"
                                    [innerHTML]="
                                        commentData.companyUser.name
                                            | highlightCommentPart
                                    "
                                ></p>

                                @if (!isCommenting && isMe) {
                                    <div class="me-container">
                                        <span class="m-0 ta-font-bold">
                                            (Me)
                                        </span>
                                    </div>
                                }
                            </div>

                            @if (!isCommenting) {
                                <div class="d-flex align-items-center">
                                    @if (commentDate) {
                                        <div
                                            class="date-container"
                                            [ngStyle]="{
                                                'margin-top': isMe
                                                    ? '-12px'
                                                    : '-6px',
                                            }"
                                        >
                                            <span class="m-0 ta-font-medium">
                                                {{ commentDate }}
                                            </span>
                                        </div>
                                    }

                                    @if (isEdited) {
                                        <div
                                            class="edited-container"
                                            [ngStyle]="{
                                                'margin-top': isMe
                                                    ? '-12px'
                                                    : '-6px',
                                            }"
                                        >
                                            <span class="m-0 ta-font-medium">
                                                • Edited
                                            </span>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                } @else {
                    <img
                        [src]="
                            commentAvatar ??
                            'assets/svg/truckassist-table/user-avatar-no-profile.svg'
                        "
                        alt="User Profile Image"
                    />

                    <p class="m-0 ta-font-semi-bold">
                        {{ commentData.companyUser.name }}
                    </p>

                    @if (!isCommenting) {
                        @if (isMe) {
                            <div class="me-container">
                                <span class="m-0 ta-font-bold">(Me)</span>
                            </div>
                        }

                        @if (commentDate) {
                            <div class="date-container">
                                <span class="m-0 ta-font-medium">
                                    • {{ commentDate }}
                                </span>
                            </div>
                        }

                        @if (isEdited) {
                            <div class="edited-container">
                                <span class="m-0 ta-font-medium">• Edited</span>
                            </div>
                        }
                    }
                }
            </div>

            <div
                class="d-flex align-items-center justify-content-center comment-header-right"
            >
                @if (isCommenting) {
                    <div
                        ngbTooltip
                        [mainTooltip]="isEditing ? 'Confirm Edit' : 'Confirm'"
                        tooltipBackground="#424242"
                        position="top"
                    >
                        <svg-icon
                            class="confirm-icon svg-size-18"
                            [ngClass]="{
                                disabled: isDisabled,
                            }"
                            src="assets/svg/ic_spec-confirm.svg"
                            (click)="handleBtnActionClick('Confirm')"
                        ></svg-icon>
                    </div>

                    <div
                        ngbTooltip
                        mainTooltip="Cancel"
                        tooltipBackground="#424242"
                        position="top"
                    >
                        <svg-icon
                            class="cancel-icon svg-size-18"
                            src="assets/svg/ic_x.svg"
                            (click)="handleBtnActionClick('Cancel')"
                        ></svg-icon>
                    </div>
                } @else {
                    @if (!isEditButtonDisabled) {
                        <div
                            class="d-flex justify-content-center align-items-center edit-icon-container"
                            ngbTooltip
                            mainTooltip="Edit"
                            tooltipBackground="#424242"
                            position="top"
                        >
                            <svg-icon
                                class="icon svg-size-13"
                                src="assets/svg/truckassist-table/dropdown/content/edit-hover.svg"
                                (click)="handleBtnActionClick('Edit')"
                            ></svg-icon>
                        </div>
                    }

                    <div
                        class="d-flex justify-content-center align-items-center delete-icon-container"
                        ngbTooltip
                        mainTooltip="Delete"
                        tooltipBackground="#DF3C3C"
                        position="top"
                    >
                        <svg-icon
                            class="icon svg-size-13"
                            src="assets/svg/truckassist-table/dropdown/content/delete-hover-new.svg"
                            (click)="handleBtnActionClick('Delete')"
                        ></svg-icon>
                    </div>
                }
            </div>
        </div>

        <!-- Comment Body -->

        <div class="d-flex align-items-center comment-body">
            <div
                #commentInput
                class="comment-input"
                [ngClass]="{
                    'no-value':
                        commentInput?.textContent === 'Write Comment...',
                    details: isDetailsCommentLayout,
                }"
                [ngStyle]="{
                    'margin-top':
                        isDetailsCommentLayout && !isCommenting
                            ? isMe
                                ? '-8px'
                                : '-6px'
                            : '0',
                }"
                [attr.contenteditable]="isCommenting"
                [innerHTML]="commentData.commentContent | highlightCommentPart"
                spellcheck="false"
                (focus)="handleCommentChange()"
                (input)="handleCommentChange()"
                (blur)="handleCommentBlur()"
                (paste)="onPaste($event)"
            ></div>
        </div>
    </div>
}
