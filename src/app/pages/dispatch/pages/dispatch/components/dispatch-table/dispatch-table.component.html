<div
    class="dispatch-table"
    [ngClass]="{
        unlocked: !isDispatchBoardLocked && showAddAddressFieldIndex === -1,
        'unlocked-skip-location':
            !isDispatchBoardLocked && showAddAddressFieldIndex !== -1
    }"
    cdkDropList
    (cdkDropListDropped)="dropList($event)"
>
    <ng-container *ngIf="isDispatchBoardChangeInProgress">
        <div
            @dispatchBackgroundAnimation
            class="change-in-progress-background-cover"
        ></div>
    </ng-container>

    <table>
        <thead>
            <tr>
                <th>TRUCK</th>
                <th>TRAILER</th>
                <th>DRIVER</th>
                <th class="empty"></th>
                <th class="empty"></th>
                <th
                    class="icon d-flex justify-content-center align-items-center"
                >
                    <svg-icon
                        src="assets/svg/common/ic_pre_trip_inspenction.svg"
                    >
                    </svg-icon>
                </th>

                <th>LAST LOCATION</th>
                <th class="text-center p-0">STATUS</th>
                <th class="pick-delivery">
                    <div>PICKUP</div>
                    <div>DELIVERY</div>
                </th>
                <th>PROGRESS</th>
                <th>PARKING</th>
                <th
                    class="icon d-flex justify-content-center align-items-center"
                >
                    <svg-icon
                        src="assets/svg/common/ic_dispatch_board_dispatcher_icon.svg"
                    >
                    </svg-icon>
                </th>
                <th>NOTE</th>
                <th class="empty"></th>
            </tr>
        </thead>

        <tbody>
            <ng-container
                *ngFor="
                    let item of dispatchData.dispatches;
                    let rowIndex = index;
                    trackBy: trackByIdentity
                "
            >
                <tr
                    class="reorder-row"
                    cdkDrag
                    cdkDragLockAxis="y"
                    cdkDragPreviewContainer="parent"
                    cdkDragBoundary=".dispatch-table"
                    [cdkDragDisabled]="isDispatchBoardLocked || !item.truck"
                >
                    <td
                        cdkDragHandle
                        class="truck-field"
                        [ngStyle]="{
                            width: hasAdditionalFieldTruck ? '160px' : '120px'
                        }"
                    >
                        <app-dispatch-table-truck-trailer
                            [type]="'truck'"
                            [hasAdditionalFieldTruck]="hasAdditionalFieldTruck"
                            [truck]="item?.truck"
                            [truckList]="truckList"
                            [rowIndex]="rowIndex"
                            [isBoardLocked]="isDispatchBoardLocked"
                            [isDrag]="isDrag"
                            [isActiveLoad]="!!item.activeLoad"
                            (addTruckTrailerEmitter)="
                                handleAddTruckTrailerClick($event)
                            "
                            (removeTruckTrailerEmitter)="
                                handleRemoveTruckTrailerClick($event)
                            "
                        >
                        </app-dispatch-table-truck-trailer>
                    </td>

                    <td
                        class="trailer-field"
                        [ngStyle]="{
                            width: hasAdditionalFieldTrailer ? '160px' : '120px'
                        }"
                    >
                        <div
                            [class.dragging]="
                                isDrag && draggingType == 'trailer'
                            "
                            cdkDropList
                            [cdkDropListSortPredicate]="
                                trailerPositionPrediction
                            "
                            (cdkDropListDropped)="dropTrailer($event, rowIndex)"
                            id="{{ rowIndex | cdkid : gridIndex : 'trailer' }}"
                            [cdkDropListData]="dispatchData"
                            [cdkDropListConnectedTo]="
                                rowIndex
                                    | cdkconnect
                                        : dispatchData.dispatches.length
                                        : gridIndex
                                        : 'trailer'
                            "
                        >
                            <div
                                class="drag-hold-between"
                                cdkDrag
                                (cdkDragStarted)="
                                    cdkDragStartedTrailer($event, rowIndex)
                                "
                                (cdkDragEnded)="dragEnd()"
                                [cdkDragDisabled]="
                                    isDispatchBoardLocked || !item.trailer
                                "
                                cdkDragLockAxis="y"
                                cdkDragPreviewContainer="parent"
                                cdkDragBoundary=".dispatch-table table tbody"
                            >
                                <div
                                    *cdkDragPlaceholder
                                    class="custom-dispatch-placeholder"
                                ></div>

                                <app-dispatch-table-truck-trailer
                                    [type]="'trailer'"
                                    [hasAdditionalFieldTrailer]="
                                        hasAdditionalFieldTrailer
                                    "
                                    [trailer]="item?.trailer"
                                    [trailerList]="trailerList"
                                    [rowIndex]="rowIndex"
                                    [isBoardLocked]="isDispatchBoardLocked"
                                    [isDrag]="isDrag"
                                    [isActiveLoad]="!!item.activeLoad"
                                    (addTruckTrailerEmitter)="
                                        handleAddTruckTrailerClick($event)
                                    "
                                    (removeTruckTrailerEmitter)="
                                        handleRemoveTruckTrailerClick($event)
                                    "
                                >
                                </app-dispatch-table-truck-trailer>
                            </div>
                        </div>
                    </td>

                    <td class="driver-field">
                        <div
                            class="main_inside"
                            [class.filled]="item?.driver"
                            [class.default]="
                                !item.driver &&
                                !driverList.length &&
                                !isDispatchBoardLocked
                            "
                            [class.dragging]="
                                isDrag && draggingType == 'driver'
                            "
                            cdkDropList
                            (cdkDropListDropped)="dropDriver($event, rowIndex)"
                            id="{{ rowIndex | cdkid : gridIndex : 'driver' }}"
                            [cdkDropListData]="dispatchData"
                            [cdkDropListConnectedTo]="
                                rowIndex
                                    | cdkconnect
                                        : dispatchData.dispatches.length
                                        : gridIndex
                                        : 'driver'
                            "
                        >
                            <div
                                class="drag-hold-between"
                                cdkDrag
                                (cdkDragStarted)="
                                    cdkDragStartedDriver($event, rowIndex)
                                "
                                (cdkDragEnded)="dragEnd()"
                                [cdkDragDisabled]="
                                    isDispatchBoardLocked || !item.driver
                                "
                                cdkDragLockAxis="y"
                                [cdkDragPreviewClass]="'trailer_3074D3'"
                                cdkDragPreviewContainer="parent"
                                cdkDragBoundary=".dispatch-table table tbody"
                            >
                                <div
                                    *cdkDragPlaceholder
                                    class="custom-dispatch-placeholder"
                                ></div>
                                <app-dispatch-table-driver
                                    [driver]="item?.driver"
                                    [driverList]="driverList"
                                    [rowIndex]="rowIndex"
                                    [isBoardLocked]="isDispatchBoardLocked"
                                    [isDrag]="isDrag"
                                    [phone]="item?.phone"
                                    [email]="item?.email"
                                    [draggingType]="draggingType"
                                    [openedDriverDropdown]="
                                        openedDriverDropdown
                                    "
                                    [isActiveLoad]="!!item?.activeLoad"
                                    [statusOpenedIndex]="statusOpenedIndex"
                                    [hoursOfService]="item?.hoursOfService"
                                    [dispatchId]="item.id"
                                    (addDriverEmitter)="
                                        handleAddDriverClick($event)
                                    "
                                    (removeDriverEmitter)="
                                        handleRemoveDriverClick($event)
                                    "
                                >
                                </app-dispatch-table-driver>
                            </div>
                        </div>
                    </td>

                    <td class="box-item">
                        <div class="main_inside" [class.filled]="item?.driver">
                            <div class="padding-inside">
                                <div
                                    *ngIf="item?.driver"
                                    class="info-item c-pointer"
                                    [class.driver-on-vacation]="
                                        item?.driver.vacation
                                    "
                                    (click)="changeDriverVacation(item)"
                                    [mainTooltip]="
                                        item?.driver.vacation
                                            ? 'Remove from Vacation'
                                            : 'Send to Vacation'
                                    "
                                    [tooltipBackground]="
                                        item?.driver.vacation
                                            ? '#EF5350'
                                            : '#2F2F2F'
                                    "
                                    ngbTooltip
                                    position="right"
                                >
                                    <svg-icon
                                        [src]="
                                            'assets/svg/dispatchboard/vacation.svg'
                                        "
                                    ></svg-icon>
                                </div>
                            </div>
                        </div>
                    </td>

                    <td class="box-item">
                        <div class="main_inside filled">
                            <div class="padding-inside">
                                <div
                                    #t1="ngbPopover"
                                    (click)="
                                        toggleHos(
                                            t1,
                                            item.hoursOfService,
                                            item.id
                                        )
                                    "
                                    (hidden)="
                                        saveHosData(
                                            item.hoursOfService,
                                            rowIndex
                                        )
                                    "
                                    [class.statusOpened]="
                                        statusOpenedIndex > -1
                                    "
                                    [class.empty-box-field]="true"
                                    [ngbPopover]="hos"
                                    autoClose="outside"
                                    class="hos-column"
                                    [ngClass]="
                                        item.hoursOfService &&
                                        item.hoursOfService[
                                            item.hoursOfService.length - 1
                                        ]?.flag.name === 'On'
                                            ? 'active_hos'
                                            : 'innactive_hos'
                                    "
                                    placement="bottom"
                                    triggers="manual"
                                    container="body"
                                    popoverClass="hos-ngb-popover"
                                >
                                    <div class="hos-img">
                                        <svg-icon
                                            [src]="
                                                'assets/svg/dispatchboard/hos-arrow.svg'
                                            "
                                        ></svg-icon>
                                    </div>
                                    <div class="hos-number">
                                        {{
                                            (item.hoursOfService !== null
                                                ? item.hoursOfService
                                                : []
                                            ) | hosTime
                                        }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="pre-trip">
                        <app-pri-trip-inspection
                            [dispatchId]="item.id"
                            [dispatchBoardId]="item.dispatchBoardId"
                            [status]="item.preTripInspection"
                        ></app-pri-trip-inspection>
                    </td>
                    <td class="location-field">
                        <app-dispatch-table-last-location
                            [address]="item.location"
                            [rowIndex]="rowIndex"
                            [showAddAddressField]="showAddAddressFieldIndex"
                            [parkingList]="parkingList"
                            (updateLastLocationEmit)="
                                handleUpdateLastLocationEmit($event)
                            "
                            (isDropdownHidden)="onHideDropdown()"
                        >
                        </app-dispatch-table-last-location>
                    </td>

                    <td class="status-field">
                        <div
                            class="main_inside"
                            [class.filled]="
                                item?.driver &&
                                item.trailer &&
                                item.location.address
                            "
                        >
                            <div class="padding-inside">
                                <app-ta-status-switch
                                    *ngIf="
                                        item?.driver &&
                                        item.trailer &&
                                        item.location.address
                                    "
                                    (changeStatus)="addStatus($event)"
                                    (openIndex)="openIndex($event)"
                                    [openedStatus]="statusOpenedIndex"
                                    [dispatchboardId]="item.id"
                                    [statusHeight]="32"
                                    [status]="item.status"
                                    [dispatchId]="item.id"
                                    [statusMainIndex]="rowIndex"
                                    [statusTypes]="'dispatch'"
                                    [withStatusAgo]="true"
                                    [pickupCount]="item.activeLoad?.pickupCount"
                                    [deliveryCount]="
                                        item.activeLoad?.deliveryCount
                                    "
                                    [possibleNextStatuses]="
                                        item.possibleNextStatuses
                                    "
                                    [nextStopType]="item.nextStopType"
                                    [currentStopType]="item.currentStopType"
                                ></app-ta-status-switch>
                            </div>
                        </div>
                    </td>

                    <td class="pickup-delivery-field">
                        <!--   <div
                    class="main_inside"
                    [class.filled]="
                        item.driver &&
                        item.trailer &&
                        item.truck &&
                        item.location.address
                    "
                >
                    <div class="padding-inside">
                        <div
                            class="info-item pickup-dev-popover-hold"
                            *ngIf="
                                item.driver && item.trailer && item.truck
                            "
                            #t3="ngbPopover"
                            [ngbPopover]="pickupPopover"
                            [autoClose]="'outside'"
                            container="body"
                            [placement]="'bottom'"
                            popoverClass="pickup-delivery-popover"
                            triggers="manual"
                            (click)="showPickupDelivery(t3)"
                        >
                            <div
                                class="no-delpickup"
                                *ngIf="!item.activeLoad"
                            >
                                No Active or Pending Load
                            </div>

                            <div
                                class="load-items-hold"
                                *ngIf="item.activeLoad"
                            >
                                <div class="pick-load-box pickup-box">
                                    <svg-icon
                                        *ngIf="
                                            item.activeLoad.pickupCount < 9
                                        "
                                        src="
                                            assets/svg/svg_numbers/olddash/svg_num_box_{{
                                            item.activeLoad.pickupCount
                                        }}.svg
                                        "
                                    ></svg-icon>
                                    <svg-icon
                                        *ngIf="
                                            item.activeLoad.pickupCount > 9
                                        "
                                        src="assets/svg/svg_numbers/svg_num_over.svg
                                    "
                                    ></svg-icon>
                                    <div class="pick-load-info">
                                        <div class="pick-load-info-address">
                                            {{
                                                item.activeLoad.pickup
                                                    .shipper.address.city
                                            }},
                                            {{
                                                item.activeLoad.pickup
                                                    .shipper.address
                                                    .stateShortName
                                            }}
                                        </div>
                                        <div class="pick-load-info-time">
                                            05/09/21
                                        </div>
                                    </div>
                                </div>
                                <div class="pick-load-box delivery-box">
                                    <svg-icon
                                        *ngIf="
                                            item.activeLoad.deliveryCount <
                                            9
                                        "
                                        src="
                                            assets/svg/svg_numbers/olddash/svg_num_box_{{
                                            item.activeLoad.deliveryCount
                                        }}.svg
                                        "
                                    ></svg-icon>
                                    <svg-icon
                                        *ngIf="
                                            item.activeLoad.deliveryCount >
                                            9
                                        "
                                        src="assets/svg/svg_numbers/svg_num_over.svg
                                    "
                                    ></svg-icon>
                                    <div class="pick-load-info">
                                        <div class="pick-load-info-address">
                                            {{
                                                item.activeLoad.delivery
                                                    .shipper.address.city
                                            }},
                                            {{
                                                item.activeLoad.delivery
                                                    .shipper.address
                                                    .stateShortName
                                            }}
                                        </div>
                                        <div class="pick-load-info-time">
                                            05/09/21
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> -->
                    </td>

                    <td class="progress-field">
                        <div class="main_inside filled">
                            <div class="padding-inside">
                                <div class="info-item p-0 w-100">
                                    <app-ta-gps-progressbar></app-ta-gps-progressbar>
                                </div>
                            </div>
                        </div>
                    </td>

                    <td
                        class="parking-field"
                        [ngClass]="{
                            'parking-field-large': parkingList?.length > 1
                        }"
                    >
                        <app-dispatch-table-parking
                            [parkingList]="parkingList"
                            [parkingSlot]="item.parkingSlot"
                            [isWideTable]="parkingList?.length > 1"
                            [truckId]="item.truck?.id"
                            [trailerId]="item.trailer?.id"
                            (updateParking)="updateParking($event, item.id)"
                        ></app-dispatch-table-parking>
                    </td>

                    <td class="box-item">
                        <div class="main_inside filled">
                            <div class="padding-inside">
                                <div class="info-item justify-content-center">
                                    <app-ta-profile-images
                                        [indx]="rowIndex"
                                        [name]="'Slavisa Markovic'"
                                        [size]="'small'"
                                        [type]="'user'"
                                        [withTooltip]="true"
                                    >
                                    </app-ta-profile-images>
                                </div>
                            </div>
                        </div>
                    </td>

                    <td class="note-field">
                        <div class="main_inside" [class.filled]="item.truck">
                            <div
                                class="dispatcher-table-cell-container note-container"
                                [class.empty-box-field]="!item.note"
                            >
                                <app-ta-note
                                    [note]="item.note"
                                    [openedAll]="true"
                                    [dispatchIndex]="rowIndex"
                                    [parking]="false"
                                    [noteWidth]="213"
                                    [parentWidth]="'.note-field'"
                                    [type]="'dark'"
                                    [isDispatch]="true"
                                    (saveNoteValue)="saveNoteValue($event)"
                                >
                                </app-ta-note>
                            </div>
                        </div>
                    </td>

                    <td class="box-item">
                        <div
                            class="main_inside"
                            [class.filled]="item.driver && item.truck"
                        >
                            <div class="padding-inside p-0">
                                <app-dispatch-table-assign-load
                                    [driver]="item.driver"
                                    [truck]="item.truck"
                                    [trailer]="item.driver"
                                    [isActiveLoad]="item.activeLoad"
                                ></app-dispatch-table-assign-load>
                            </div>
                        </div>
                    </td>
                </tr>
            </ng-container>

            <tr *ngIf="!isDispatchBoardLocked">
                <td
                    class="truck-field"
                    [ngStyle]="{
                        width: hasAdditionalFieldTruck ? '160px' : '120px'
                    }"
                >
                    <app-dispatch-table-truck-trailer
                        [type]="'truck'"
                        [truck]="addNewTruckData"
                        [hasAdditionalFieldTruck]="hasAdditionalFieldTruck"
                        [truckList]="truckList"
                        [rowIndex]="rowIndex"
                        [isBoardLocked]="isDispatchBoardLocked"
                        [isDrag]="isDrag"
                        (addTruckTrailerEmitter)="
                            handleAddTruckTrailerClick($event)
                        "
                        (removeTruckTrailerEmitter)="
                            handleRemoveTruckTrailerClick($event)
                        "
                    >
                    </app-dispatch-table-truck-trailer>
                </td>

                <td
                    class="trailer-field"
                    [ngStyle]="{
                        width: hasAdditionalFieldTrailer ? '160px' : '120px'
                    }"
                >
                    <app-dispatch-table-truck-trailer
                        [type]="'trailer'"
                        [hasAdditionalFieldTrailer]="hasAdditionalFieldTrailer"
                        [trailerList]="trailerList"
                        [rowIndex]="rowIndex"
                        [isBoardLocked]="isDispatchBoardLocked"
                        [isDrag]="isDrag"
                        (addTruckTrailerEmitter)="
                            handleAddTruckTrailerClick($event)
                        "
                        (removeTruckTrailerEmitter)="
                            handleRemoveTruckTrailerClick($event)
                        "
                    >
                    </app-dispatch-table-truck-trailer>
                </td>

                <td class="driver-field">
                    <app-dispatch-table-driver
                        [driverList]="driverList"
                        [rowIndex]="rowIndex"
                        [isBoardLocked]="isDispatchBoardLocked"
                        [isDrag]="isDrag"
                        [draggingType]="draggingType"
                        [openedDriverDropdown]="openedDriverDropdown"
                        [statusOpenedIndex]="statusOpenedIndex"
                        (addDriverEmitter)="handleAddDriverClick($event)"
                        (removeDriverEmitter)="handleRemoveDriverClick($event)"
                    >
                    </app-dispatch-table-driver>
                </td>

                <td class="box-item">
                    <div class="main_inside" [class.filled]="item?.driver">
                        <div class="padding-inside">
                            <div
                                *ngIf="item?.driver"
                                class="info-item c-pointer"
                                [class.driver-on-vacation]="
                                    item?.driver.vacation
                                "
                                (click)="changeDriverVacation(item)"
                                [mainTooltip]="
                                    item?.driver.vacation
                                        ? 'Remove from Vacation'
                                        : 'Send to Vacation'
                                "
                                [tooltipBackground]="
                                    item?.driver.vacation
                                        ? '#EF5350'
                                        : '#2F2F2F'
                                "
                                ngbTooltip
                                position="right"
                            >
                                <svg-icon
                                    [src]="
                                        'assets/svg/dispatchboard/vacation.svg'
                                    "
                                ></svg-icon>
                            </div>
                        </div>
                    </div>
                </td>

                <td class="box-item">
                    <div class="main_inside filled">
                        <div class="padding-inside">
                            <div
                                #t1="ngbPopover"
                                (click)="
                                    toggleHos(t1, item.hoursOfService, item.id)
                                "
                                (hidden)="
                                    saveHosData(item.hoursOfService, rowIndex)
                                "
                                [class.statusOpened]="statusOpenedIndex > -1"
                                [class.empty-box-field]="true"
                                [ngbPopover]="hos"
                                autoClose="outside"
                                class="hos-column"
                                [ngClass]="
                                    item.hoursOfService &&
                                    item.hoursOfService[
                                        item.hoursOfService.length - 1
                                    ]?.flag.name === 'On'
                                        ? 'active_hos'
                                        : 'innactive_hos'
                                "
                                placement="bottom"
                                triggers="manual"
                                container="body"
                                popoverClass="hos-ngb-popover"
                            >
                                <div class="hos-img">
                                    <svg-icon
                                        [src]="
                                            'assets/svg/dispatchboard/hos-arrow.svg'
                                        "
                                    ></svg-icon>
                                </div>
                                <div class="hos-number">
                                    {{
                                        (item.hoursOfService !== null
                                            ? item.hoursOfService
                                            : []
                                        ) | hosTime
                                    }}
                                </div>
                            </div>
                        </div>
                    </div>
                </td>
                <td class="pre-trip">
                    <app-pri-trip-inspection
                        [dispatchId]="item.id"
                        [dispatchBoardId]="item.dispatchBoardId"
                        [status]="item.preTripInspection"
                    ></app-pri-trip-inspection>
                </td>
                <td class="location-field">
                    <ng-container *ngIf="showAddAddressFieldIndex === -2">
                        <app-dispatch-table-last-location
                            [rowIndex]="showAddAddressFieldIndex"
                            [showAddAddressField]="showAddAddressFieldIndex"
                            [parkingList]="parkingList"
                            (updateLastLocationEmit)="
                                handleUpdateLastLocationEmit($event)
                            "
                            (isDropdownHidden)="onHideDropdown()"
                        >
                        </app-dispatch-table-last-location>
                    </ng-container>
                </td>

                <td class="status-field">
                    <div class="main_inside">
                        <div class="padding-inside"></div>
                    </div>
                </td>

                <td class="pickup-delivery-field">
                    <div class="main_inside">
                        <div class="padding-inside"></div>
                    </div>
                </td>

                <td class="progress-field">
                    <div class="main_inside">
                        <div class="padding-inside"></div>
                    </div>
                </td>

                <td class="parking-field">
                    <div class="main_inside">
                        <div class="padding-inside"></div>
                    </div>
                </td>

                <td class="box-item">
                    <div class="main_inside">
                        <div class="padding-inside"></div>
                    </div>
                </td>

                <td class="note-field">
                    <div class="main_inside">
                        <div class="padding-inside"></div>
                    </div>
                </td>

                <td class="box-item">
                    <div class="main_inside">
                        <div class="padding-inside"></div>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>

    <div
        class="d-flex justify-content-between table-info"
        [ngStyle]="{ 'width.px': toolbarWidth }"
    >
        <div class="d-flex align-items-center table-inside-info">
            <div
                class="table-info-field truck-field"
                [ngStyle]="{
                    width: hasAdditionalFieldTruck ? '160px' : '120px'
                }"
            >
                <span class="ta-font-bold">
                    {{ dispatchData.truckCount }}
                    {{ dispatchData.truckCount === 1 ? 'TRUCK' : 'TRUCKS' }}
                </span>
            </div>

            <div
                class="table-info-field trailer-field"
                [ngStyle]="{
                    width: hasAdditionalFieldTrailer ? '160px' : '120px'
                }"
            >
                <span class="ta-font-bold">
                    {{ dispatchData.trailerCount }}
                    {{
                        dispatchData.trailerCount === 1 ? 'TRAILER' : 'TRAILERS'
                    }}
                </span>
            </div>

            <div class="table-info-field driver-field">
                <span class="ta-font-bold">
                    {{ dispatchData.driverCount }}
                    {{ dispatchData.driverCount === 1 ? 'DRIVER' : 'DRIVERS' }}
                </span>
            </div>
        </div>

        <div class="d-flex align-items-center table-inside-info">
            <div class="table-info-field">
                <span class="ta-font-bold">2 of 24</span>
            </div>

            <div class="table-info-field dispatcher-field">
                <span class="ta-font-bold">
                    {{ dispatchData?.dispatcher?.fullName ?? 'Team Board' }}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Pickup and Delivery popover -->

<ng-template #pickupPopover let-data="data">
    <app-ta-pickup-delivery [customWidth]="340"></app-ta-pickup-delivery>
</ng-template>
