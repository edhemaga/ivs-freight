<div
    class="dispatch-table"
    [ngClass]="{
        unlocked: !isDispatchBoardLocked && showAddAddressFieldIndex === -1,
        'unlocked-skip-location':
            !isDispatchBoardLocked && showAddAddressFieldIndex !== -1
    }"
    cdkDropList
    (cdkDropListDropped)="dropList($event)"
>
    <ng-container *ngIf="isDispatchBoardChangeInProgress">
        <div
            @dispatchBackgroundAnimation
            class="change-in-progress-background-cover"
        ></div>
    </ng-container>

    <table>
        <!-- Table Header -->

        <thead>
            <ng-container
                *ngIf="
                    !isAllBoardsList ||
                    (isAllBoardsList && dispatchData?.teamBoard)
                "
            >
                <tr>
                    <ng-container
                        *ngFor="
                            let tableHeaderItem of dispatchTableHeaderItems;
                            let headerItemIndex = index;
                            trackBy: trackByIdentity
                        "
                    >
                        <th
                            class="ta-font-bold"
                            [ngClass]="{
                                'd-flex justify-content-center align-items-center':
                                    !tableHeaderItem?.title &&
                                    tableHeaderItem?.icon,
                                'd-flex align-items-center pickup-delivery':
                                    tableHeaderItem?.secondTitle
                            }"
                        >
                            <div>
                                <svg-icon
                                    class="icon"
                                    [svgStyle]="{
                                        'width.px': '14',
                                        'height.px': '14'
                                    }"
                                    [src]="tableHeaderItem?.icon"
                                ></svg-icon>

                                {{ tableHeaderItem?.title }}
                            </div>

                            <ng-container *ngIf="tableHeaderItem?.secondIcon">
                                <div>
                                    <svg-icon
                                        class="icon delivery"
                                        [svgStyle]="{
                                            'width.px': '14',
                                            'height.px': '14'
                                        }"
                                        [src]="tableHeaderItem?.secondIcon"
                                    ></svg-icon>

                                    {{ tableHeaderItem?.secondTitle }}
                                </div>
                            </ng-container>
                        </th>
                    </ng-container>
                </tr></ng-container
            >
        </thead>

        <!-- Locked Table -->

        <tbody>
            <ng-container
                *ngIf="
                    dispatchData?.dispatches?.length;
                    else emptyRowPlaceholderTemplate
                "
            >
                <ng-container
                    *ngFor="
                        let item of dispatchData.dispatches;
                        let rowIndex = index;
                        trackBy: trackByIdentity
                    "
                >
                    <tr
                        class="reorder-row"
                        cdkDrag
                        cdkDragLockAxis="y"
                        cdkDragPreviewContainer="parent"
                        cdkDragBoundary=".dispatch-table"
                        [cdkDragDisabled]="isDispatchBoardLocked || !item.truck"
                        (mouseenter)="isHoveringRowIndex = rowIndex"
                        (mouseleave)="isHoveringRowIndex = -1"
                    >
                        <td
                            cdkDragHandle
                            class="truck-field"
                            [ngStyle]="{
                                width: hasAdditionalFieldTruck
                                    ? '160px'
                                    : '120px'
                            }"
                        >
                            <app-dispatch-table-truck-trailer
                                [type]="'truck'"
                                [hasAdditionalFieldTruck]="
                                    hasAdditionalFieldTruck
                                "
                                [truck]="item?.truck"
                                [truckList]="truckList"
                                [rowIndex]="rowIndex"
                                [isBoardLocked]="isDispatchBoardLocked"
                                [isDrag]="isDrag"
                                [isActiveLoad]="!!item.activeLoad"
                                [isHoveringRow]="
                                    isDispatchBoardLocked &&
                                    isHoveringRowIndex === rowIndex
                                "
                                (addTruckTrailerEmitter)="
                                    handleAddTruckTrailerClick($event)
                                "
                                (removeTruckTrailerEmitter)="
                                    handleRemoveTruckTrailerClick($event)
                                "
                            >
                            </app-dispatch-table-truck-trailer>
                        </td>

                        <td
                            class="trailer-field"
                            [ngStyle]="{
                                width: hasAdditionalFieldTrailer
                                    ? '160px'
                                    : '120px'
                            }"
                        >
                            <div
                                [class.dragging]="
                                    isDrag && draggingType == 'trailer'
                                "
                                cdkDropList
                                [cdkDropListSortPredicate]="
                                    trailerPositionPrediction
                                "
                                (cdkDropListDropped)="
                                    dropTrailer($event, rowIndex)
                                "
                                id="{{
                                    rowIndex | cdkid : gridIndex : 'trailer'
                                }}"
                                [cdkDropListData]="dispatchData"
                                [cdkDropListConnectedTo]="
                                    rowIndex
                                        | cdkconnect
                                            : dispatchData.dispatches.length
                                            : gridIndex
                                            : 'trailer'
                                "
                            >
                                <div
                                    class="drag-hold-between"
                                    cdkDrag
                                    (cdkDragStarted)="
                                        cdkDragStartedTrailer($event, rowIndex)
                                    "
                                    (cdkDragEnded)="dragEnd()"
                                    [cdkDragDisabled]="
                                        isDispatchBoardLocked || !item.trailer
                                    "
                                    cdkDragLockAxis="y"
                                    cdkDragPreviewContainer="parent"
                                    cdkDragBoundary=".dispatch-table table tbody"
                                >
                                    <div
                                        *cdkDragPlaceholder
                                        class="custom-dispatch-placeholder"
                                    ></div>

                                    <app-dispatch-table-truck-trailer
                                        [type]="'trailer'"
                                        [hasAdditionalFieldTrailer]="
                                            hasAdditionalFieldTrailer
                                        "
                                        [trailer]="item?.trailer"
                                        [trailerList]="trailerList"
                                        [rowIndex]="rowIndex"
                                        [isBoardLocked]="isDispatchBoardLocked"
                                        [isDrag]="isDrag"
                                        [isActiveLoad]="!!item.activeLoad"
                                        [isHoveringRow]="
                                            isDispatchBoardLocked &&
                                            isHoveringRowIndex === rowIndex
                                        "
                                        (addTruckTrailerEmitter)="
                                            handleAddTruckTrailerClick($event)
                                        "
                                        (removeTruckTrailerEmitter)="
                                            handleRemoveTruckTrailerClick(
                                                $event
                                            )
                                        "
                                    >
                                    </app-dispatch-table-truck-trailer>
                                </div>
                            </div>
                        </td>

                        <td class="driver-field">
                            <div
                                class="main_inside"
                                [class.filled]="item?.driver"
                                [class.default]="
                                    !item.driver &&
                                    !driverList.length &&
                                    !isDispatchBoardLocked
                                "
                                [class.dragging]="
                                    isDrag && draggingType == 'driver'
                                "
                                cdkDropList
                                (cdkDropListDropped)="
                                    dropDriver($event, rowIndex)
                                "
                                id="{{
                                    rowIndex | cdkid : gridIndex : 'driver'
                                }}"
                                [cdkDropListData]="dispatchData"
                                [cdkDropListConnectedTo]="
                                    rowIndex
                                        | cdkconnect
                                            : dispatchData.dispatches.length
                                            : gridIndex
                                            : 'driver'
                                "
                            >
                                <div
                                    class="drag-hold-between"
                                    cdkDrag
                                    (cdkDragStarted)="
                                        cdkDragStartedDriver($event, rowIndex)
                                    "
                                    (cdkDragEnded)="dragEnd()"
                                    [cdkDragDisabled]="
                                        isDispatchBoardLocked || !item.driver
                                    "
                                    cdkDragLockAxis="y"
                                    [cdkDragPreviewClass]="'trailer_3074D3'"
                                    cdkDragPreviewContainer="parent"
                                    cdkDragBoundary=".dispatch-table table tbody"
                                >
                                    <div
                                        *cdkDragPlaceholder
                                        class="custom-dispatch-placeholder"
                                    ></div>

                                    <app-dispatch-table-driver
                                        [driver]="item?.driver"
                                        [driverList]="driverList"
                                        [rowIndex]="rowIndex"
                                        [isBoardLocked]="isDispatchBoardLocked"
                                        [isDrag]="isDrag"
                                        [phone]="item?.phone"
                                        [email]="item?.email"
                                        [draggingType]="draggingType"
                                        [openedDriverDropdown]="
                                            openedDriverDropdown
                                        "
                                        [isActiveLoad]="!!item?.activeLoad"
                                        [hoursOfService]="item?.hoursOfService"
                                        [dispatchId]="item.id"
                                        [isHoveringRow]="
                                            isDispatchBoardLocked &&
                                            isHoveringRowIndex === rowIndex
                                        "
                                        (addDriverEmitter)="
                                            handleAddDriverClick($event)
                                        "
                                        (removeDriverEmitter)="
                                            handleRemoveDriverClick($event)
                                        "
                                        (driverVacationEmitter)="
                                            changeDriverVacation(item)
                                        "
                                    >
                                    </app-dispatch-table-driver>
                                </div>
                            </div>
                        </td>

                        <td class="pre-trip">
                            <app-dispatch-table-pre-trip-inspection
                                [dispatchId]="item?.id"
                                [dispatchBoardId]="item?.dispatchBoardId"
                                [status]="item?.preTripInspection"
                                [isHoveringRow]="
                                    isDispatchBoardLocked &&
                                    isHoveringRowIndex === rowIndex
                                "
                            ></app-dispatch-table-pre-trip-inspection>
                        </td>

                        <td class="location-field">
                            <app-dispatch-table-last-location
                                [address]="item.location"
                                [rowIndex]="rowIndex"
                                [showAddAddressField]="showAddAddressFieldIndex"
                                [parkingList]="parkingList"
                                [isHoveringRow]="
                                    isDispatchBoardLocked &&
                                    isHoveringRowIndex === rowIndex
                                "
                                (updateLastLocationEmit)="
                                    handleUpdateLastLocationEmit($event)
                                "
                                (isDropdownHidden)="onHideDropdown()"
                            >
                            </app-dispatch-table-last-location>
                        </td>

                        <td class="status-field">
                            <app-dispatch-table-status
                                [time]="item.lastStatusDateTime"
                                [status]="item.status"
                                [dispatchId]="item.id"
                                [dispatchBoardId]="item?.dispatchBoardId"
                                [dispatcher]="item"
                                [isHoveringRow]="
                                    isDispatchBoardLocked &&
                                    isHoveringRowIndex === rowIndex
                                "
                            >
                            </app-dispatch-table-status>
                        </td>

                        <td class="pickup-delivery-field"></td>

                        <td class="progress-field">
                            <div class="main_inside filled">
                                <div class="padding-inside">
                                    <div class="info-item p-0 w-100">
                                        <app-ta-gps-progressbar></app-ta-gps-progressbar>
                                    </div>
                                </div>
                            </div>
                        </td>

                        <td
                            class="parking-field"
                            [ngClass]="{
                                'parking-field-large': parkingList?.length > 1
                            }"
                        >
                            <app-dispatch-table-parking
                                [parkingList]="parkingList"
                                [parkingSlot]="item.parkingSlot"
                                [isWideTable]="parkingList?.length > 1"
                                [truckId]="item.truck?.id"
                                [trailerId]="item.trailer?.id"
                                [isHoveringRow]="
                                    isDispatchBoardLocked &&
                                    isHoveringRowIndex === rowIndex
                                "
                                (updateParking)="updateParking($event, item.id)"
                            ></app-dispatch-table-parking>
                        </td>

                        <td class="box-item">
                            <div class="main_inside filled">
                                <div
                                    class="padding-inside"
                                    [ngClass]="{
                                        hovering:
                                            isDispatchBoardLocked &&
                                            item.dispatcher?.fullName &&
                                            isHoveringRowIndex === rowIndex
                                    }"
                                >
                                    <div
                                        class="info-item justify-content-center"
                                    >
                                        <ng-container
                                            *ngIf="item.dispatcher?.fullName"
                                        >
                                            <app-ta-profile-images
                                                [indx]="rowIndex"
                                                [name]="
                                                    item.dispatcher?.fullName
                                                "
                                                [size]="'small'"
                                                [type]="'user'"
                                                [withTooltip]="true"
                                                [isDispatch]="true"
                                            >
                                            </app-ta-profile-images>
                                        </ng-container>
                                    </div>
                                </div>
                            </div>
                        </td>

                        <td class="note-field">
                            <div
                                class="main_inside"
                                [class.filled]="item.truck"
                            >
                                <div
                                    class="dispatcher-table-cell-container note-container"
                                    [class.empty-box-field]="!item.note"
                                >
                                    <app-ta-note
                                        [note]="item.note"
                                        [openedAll]="true"
                                        [dispatchIndex]="rowIndex"
                                        [parking]="false"
                                        [noteWidth]="213"
                                        [parentWidth]="'.note-field'"
                                        [type]="'dark'"
                                        [isDispatch]="true"
                                        (saveNoteValue)="saveNoteValue($event)"
                                    >
                                    </app-ta-note>
                                </div>
                            </div>
                        </td>

                        <td class="box-item">
                            <div
                                class="main_inside"
                                [class.filled]="item.driver && item.truck"
                            >
                                <div class="padding-inside p-0">
                                    <app-dispatch-table-assign-load
                                        [driver]="item.driver"
                                        [truck]="item.truck"
                                        [trailer]="item.driver"
                                        [isActiveLoad]="item.activeLoad"
                                        [dispatchId]="item.id"
                                        [isHoveringRow]="
                                            isDispatchBoardLocked &&
                                            isHoveringRowIndex === rowIndex
                                        "
                                    ></app-dispatch-table-assign-load>
                                </div>
                            </div>
                        </td>
                    </tr>
                </ng-container>
            </ng-container>

            <!-- Unlocked Table -->

            <tr *ngIf="!isDispatchBoardLocked">
                <td
                    class="truck-field"
                    [ngStyle]="{
                        width: hasAdditionalFieldTruck ? '160px' : '120px'
                    }"
                >
                    <app-dispatch-table-truck-trailer
                        [type]="'truck'"
                        [truck]="addNewTruckData"
                        [hasAdditionalFieldTruck]="hasAdditionalFieldTruck"
                        [truckList]="truckList"
                        [rowIndex]="rowIndex"
                        [isBoardLocked]="isDispatchBoardLocked"
                        [isDrag]="isDrag"
                        [isHoveringRow]="isHoveringRowIndex === rowIndex"
                        (addTruckTrailerEmitter)="
                            handleAddTruckTrailerClick($event)
                        "
                        (removeTruckTrailerEmitter)="
                            handleRemoveTruckTrailerClick($event)
                        "
                    >
                    </app-dispatch-table-truck-trailer>
                </td>

                <td
                    class="trailer-field"
                    [ngStyle]="{
                        width: hasAdditionalFieldTrailer ? '160px' : '120px'
                    }"
                >
                    <app-dispatch-table-truck-trailer
                        [type]="'trailer'"
                        [hasAdditionalFieldTrailer]="hasAdditionalFieldTrailer"
                        [trailerList]="trailerList"
                        [rowIndex]="rowIndex"
                        [isBoardLocked]="isDispatchBoardLocked"
                        [isDrag]="isDrag"
                        [isHoveringRow]="isHoveringRowIndex === rowIndex"
                        (addTruckTrailerEmitter)="
                            handleAddTruckTrailerClick($event)
                        "
                        (removeTruckTrailerEmitter)="
                            handleRemoveTruckTrailerClick($event)
                        "
                    >
                    </app-dispatch-table-truck-trailer>
                </td>

                <td class="driver-field">
                    <app-dispatch-table-driver
                        [driverList]="driverList"
                        [rowIndex]="rowIndex"
                        [isBoardLocked]="isDispatchBoardLocked"
                        [isDrag]="isDrag"
                        [draggingType]="draggingType"
                        [openedDriverDropdown]="openedDriverDropdown"
                        [isHoveringRow]="isHoveringRowIndex === rowIndex"
                        (addDriverEmitter)="handleAddDriverClick($event)"
                        (removeDriverEmitter)="handleRemoveDriverClick($event)"
                        (driverVacationEmitter)="changeDriverVacation($event)"
                    >
                    </app-dispatch-table-driver>
                </td>

                <td class="pre-trip">
                    <app-dispatch-table-pre-trip-inspection></app-dispatch-table-pre-trip-inspection>
                </td>
                <td class="location-field">
                    <ng-container *ngIf="showAddAddressFieldIndex === -2">
                        <app-dispatch-table-last-location
                            [rowIndex]="showAddAddressFieldIndex"
                            [showAddAddressField]="showAddAddressFieldIndex"
                            [parkingList]="parkingList"
                            (updateLastLocationEmit)="
                                handleUpdateLastLocationEmit($event)
                            "
                            (isDropdownHidden)="onHideDropdown()"
                        >
                        </app-dispatch-table-last-location>
                    </ng-container>
                </td>

                <td class="status-field">
                    <div class="main_inside">
                        <div class="padding-inside"></div>
                    </div>
                </td>

                <td class="pickup-delivery-field">
                    <div class="main_inside">
                        <div class="padding-inside"></div>
                    </div>
                </td>

                <td class="progress-field">
                    <div class="main_inside">
                        <div class="padding-inside"></div>
                    </div>
                </td>

                <td class="parking-field">
                    <div class="main_inside">
                        <div class="padding-inside"></div>
                    </div>
                </td>

                <td class="box-item">
                    <div class="main_inside">
                        <div class="padding-inside"></div>
                    </div>
                </td>

                <td class="note-field">
                    <div class="main_inside">
                        <div class="padding-inside"></div>
                    </div>
                </td>

                <td class="box-item">
                    <div class="main_inside">
                        <div class="padding-inside"></div>
                    </div>
                </td>
            </tr>

            <!-- Empty Rows Placeholders -->

            <ng-template #emptyRowPlaceholderTemplate>
                <ng-container
                    *ngIf="
                        isAllBoardsList;
                        else multipleEmptyRowsPlaceholderTemplate
                    "
                >
                    <tr class="reorder-row fake-row">
                        <td
                            class="truck-field"
                            [ngStyle]="{
                                width: hasAdditionalFieldTruck
                                    ? '160px'
                                    : '120px'
                            }"
                        >
                            <div class="main_inside"></div>
                        </td>

                        <td
                            class="trailer-field"
                            [ngStyle]="{
                                width: hasAdditionalFieldTrailer
                                    ? '160px'
                                    : '120px'
                            }"
                        >
                            <div class="main_inside"></div>
                        </td>

                        <td class="driver-field">
                            <div class="main_inside"></div>
                        </td>

                        <td class="pre-trip">
                            <div class="main_inside"></div>
                        </td>
                        <td class="location-field">
                            <div class="main_inside"></div>
                        </td>

                        <td class="status-field">
                            <div class="main_inside"></div>
                        </td>

                        <td class="pickup-delivery-field">
                            <div class="main_inside"></div>
                        </td>

                        <td class="progress-field">
                            <div class="main_inside"></div>
                        </td>

                        <td
                            class="parking-field"
                            [ngClass]="{
                                'parking-field-large': hasLargeFieldParking
                            }"
                        >
                            <div class="main_inside"></div>
                        </td>

                        <td class="box-item">
                            <div class="main_inside"></div>
                        </td>

                        <td class="note-field">
                            <div class="main_inside"></div>
                        </td>

                        <td class="box-item">
                            <div class="main_inside"></div>
                        </td>
                    </tr>
                </ng-container>
            </ng-template>

            <ng-template #multipleEmptyRowsPlaceholderTemplate>
                <ng-container *ngIf="isDispatchBoardLocked">
                    <ng-container
                        *ngFor="
                            let row of [].constructor(3);
                            let i = index;
                            trackBy: trackByIdentity
                        "
                    >
                        <tr
                            class="no-data-table-row"
                            [ngClass]="{
                                'first-row': i === 0,
                                'second-row': i === 1,
                                'third-row': i === 2
                            }"
                        >
                            <ng-container
                                *ngFor="let field of [].constructor(12)"
                            >
                                <td>
                                    <div></div>
                                </td>
                            </ng-container>
                        </tr>
                    </ng-container>
                </ng-container>
            </ng-template>
        </tbody>

        <!-- Table Info -->

        <ng-container
            *ngIf="isAllBoardsList || dispatchData?.dispatches?.length"
        >
            <tfoot>
                <tr>
                    <td>
                        <app-dispatch-table-info
                            [type]="'truck'"
                            [count]="dispatchData.truckCount"
                        ></app-dispatch-table-info>
                    </td>

                    <td>
                        <app-dispatch-table-info
                            [type]="'trailer'"
                            [count]="dispatchData.trailerCount"
                        ></app-dispatch-table-info>
                    </td>

                    <td>
                        <app-dispatch-table-info
                            [type]="'driver'"
                            [count]="dispatchData.driverCount"
                        ></app-dispatch-table-info>
                    </td>

                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>

                    <td>
                        <app-dispatch-table-info
                            [type]="'parking'"
                            [count]="parkingCount"
                            [totalCount]="dispatchData.dispatches.length"
                        ></app-dispatch-table-info>
                    </td>

                    <td colspan="3">
                        <ng-container *ngIf="isAllBoardsList">
                            <app-dispatch-table-info
                                [type]="'board'"
                                [name]="
                                    dispatchData?.teamBoard
                                        ? 'Team Board'
                                        : dispatchData?.dispatcher?.fullName
                                "
                                [hasAlignRight]="true"
                            ></app-dispatch-table-info>
                        </ng-container>
                    </td>
                </tr>
            </tfoot>
        </ng-container>
    </table>

    <!-- No Data -->

    <ng-container
        *ngIf="
            !dispatchData?.dispatches?.length &&
            !isAllBoardsList &&
            isDispatchBoardLocked
        "
    >
        <div class="d-flex align-items-center justify-content-center">
            <div
                class="no-data-container d-flex flex-column align-items-center"
            >
                <svg-icon [src]="dispatchTableSvgRoutes.noDispatchDataRoute">
                </svg-icon>

                <div
                    class="no-data-text-container d-flex flex-column align-items-center"
                >
                    <div class="no-data-text ta-font-extra-bold">
                        No Data Found
                    </div>

                    <div class="no-data-description ta-font-medium text-center">
                        There are no entries. To manage your board, unlock the
                        table and start <br />
                        adding new records.
                    </div>
                </div>

                <div>
                    <button
                        type="button"
                        class="d-flex justify-content-center align-items-center unlock-table-button"
                        (click)="unlockTable()"
                    >
                        <p class="m-0 ta-font-bold">Unlock Table</p>
                    </button>
                </div>
            </div>
        </div>
    </ng-container>
</div>

<!-- Pickup and Delivery popover -->

<ng-template #pickupPopover let-data="data">
    <app-ta-pickup-delivery [customWidth]="340"></app-ta-pickup-delivery>
</ng-template>
