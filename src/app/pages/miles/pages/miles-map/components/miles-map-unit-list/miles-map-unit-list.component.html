@let details = milesStoreService.detailsSelector$ | async;
@let stops = milesStoreService.stopsSelector$ | async;
@let minimalList = milesStoreService.minimalListSelector$ | async;
@let isPreviousButtonDisabled = true;
@let isNextButtonDisabled = true;

@if (details) {
    <div class="position-relative z-2">
        <div
            class="background-white br-3 p-x-6 mb-2"
            [ngClass]="isStopListWidthExpanded ? 'w-442' : 'w-334'"
        >
            <div class="h-42 d-flex align-items-center justify-content-between">
                @let title = 'UNIT ' + details?.truck?.truckNumber;
                <app-ca-details-title-card
                    #detailsTitleCard
                    [detailsTitleCardConfig]="{
                        title: title,
                        tooltip: 'Search Truck',
                        placeholder: title,
                        width: isStopListWidthExpanded ? 398 : 270,
                        tooltipNext: 'Next Truck',
                        tooltipPrevious: 'Previous Truck',
                        disableNext: isNextButtonDisabled,
                        disablePrevious: isPreviousButtonDisabled,
                    }"
                    [dropdownTemplate]="titleDropdown"
                    [titleRightIconTemplate]="titleRightIconTemplate"
                    (onNextAction)="getTruckUnit(ArrowActionsStringEnum.NEXT)"
                    (onPreviousAction)="
                        getTruckUnit(ArrowActionsStringEnum.PREV)
                    "
                    (onSearchTextChange)="onSearchTextChange($event)"
                >
                    <ng-template #titleDropdown>
                        <cdk-virtual-scroll-viewport
                            #minimalListViewport
                            [itemSize]="26"
                            style="height: 190px"
                            (scroll)="onMinimalListScroll()"
                        >
                            <div *cdkVirtualFor="let unit of minimalList">
                                <ng-container
                                    *ngTemplateOutlet="
                                        mileUnits;
                                        context: {
                                            unit,
                                        }
                                    "
                                >
                                </ng-container>
                            </div>
                        </cdk-virtual-scroll-viewport>
                    </ng-template>

                    <ng-template #titleRightIconTemplate>
                        <svg-icon
                            class="svg-size-42-18 d-flex align-items-center"
                            [src]="
                                sharedSvgRoutes.TRUCK_PATH_BASE +
                                details?.truck?.truckType?.logoName
                            "
                        ></svg-icon>
                    </ng-template>
                </app-ca-details-title-card>
            </div>
        </div>
        <div
            class="background-white br-3 p-l-6 p-y-6 miles-unit-list overflow-hidden"
            [ngClass]="isStopListWidthExpanded ? 'w-442' : 'w-334'"
        >
            <div class="p-r-6">
                <form [formGroup]="searchForm">
                    <app-ca-input
                        formControlName="search"
                        [inputConfig]="searchField"
                        (clear)="onClearInputEvent()"
                    ></app-ca-input>
                </form>

                <div
                    class="h-22 d-grid align-items-center p-r-6 gap-1 m-t-4"
                    [ngClass]="
                        isStopListWidthExpanded
                            ? 'stops-container-large'
                            : 'stops-container-small'
                    "
                >
                    @for (item of stopsConfig; let i = $index; track i) {
                        @if (!item.isExpandable || isStopListWidthExpanded) {
                            <div
                                class="text-color-muted text-size-11 ta-font-bold"
                                [ngClass]="{
                                    'text-right': item.isAlignedRight,
                                    'text-center': item.isAlignedCenter,
                                }"
                            >
                                {{ item.label }}
                            </div>
                        }
                    }
                </div>

                <div class="divider mt-1 mb-1"></div>
            </div>
            @let listHeight =
                {
                    height: isStopListHeightExpanded
                        ? 'calc(100vh - 188px)'
                        : '396px',
                };
            <div
                #stopListViewport
                class="gap-1 d-flex flex-column scrollable-element overflow-scroll p-r-4"
                [ngStyle]="listHeight"
                (scroll)="onScrollEvent()"
            >
                @for (stop of stops; track stop.id; let index = $index) {
                    <ng-container
                        *ngTemplateOutlet="
                            stopRows;
                            context: {
                                stop,
                                index,
                            }
                        "
                    >
                    </ng-container>
                }
            </div>

            <div
                (click)="toogleStopListHeight()"
                class="position-absolute z-2 arrow arrow-bottom"
                [class.arrow-bottom-opened]="!isStopListHeightExpanded"
            >
                <ng-container *ngTemplateOutlet="resizeButton"> </ng-container>
            </div>

            <div
                (click)="toogleStopListWidth()"
                class="position-absolute z-2 arrow arrow-right"
                [class.arrow-right-opened]="isStopListWidthExpanded"
            >
                <ng-container *ngTemplateOutlet="resizeButton"> </ng-container>
            </div>
        </div>
    </div>
}

<ng-template #stopRows let-stop="stop" let-index="index">
    @let widthClass =
        isStopListWidthExpanded
            ? 'stops-container-large'
            : 'stops-container-small';
    <div
        class="stops-container h-26 br-2 background-white background-hover-light-grey d-grid align-items-center p-r-6 gap-1 c-pointer m-b-2"
        [ngClass]="widthClass"
    >
        <div class="text-color-muted text-size-11 text-center">
            {{ index + 1 }}
        </div>
        <div
            class="text-color-black text-size-11 ta-font-bold text-truncate d-flex"
        >
            @let location = stop.location;
            <svg-icon
                [src]="(stop.type.name | milesIcon).icon"
                [ngClass]="(stop.type.name | milesIcon).color"
                class="svg-size-14 d-flex m-r-4"
            ></svg-icon>
            {{ location.city }}, {{ location.stateShortName }}
            {{ location.zipCode }}
        </div>
        <div class="text-color-black text-size-11 text-right">
            {{ (stop.legMiles | thousandSeparator) ?? '0.0' }}
        </div>
        @if (isStopListWidthExpanded) {
            <div class="text-color-black text-size-11 text-right">
                {{ (stop.loadedMiles | thousandSeparator) ?? '0.0' }}
            </div>
            <div class="text-color-black text-size-11 text-right">
                {{ (stop.emptyMiles | thousandSeparator) ?? '0.0' }}
            </div>
        }
        <div class="text-color-black text-size-11 ta-font-medium text-right">
            {{ (stop.totalMiles | thousandSeparator) ?? '0.0' }}
        </div>
    </div>
</ng-template>

<ng-template #resizeButton>
    <!-- TODO:  Inside virtual sroll ticket -->
    <div
        class="h-26 w-26 background-white rounded-circle d-flex align-items-center justify-content-center svg-fill-muted svg-hover-black c-pointer shadow-100"
    >
        <svg-icon
            [src]="sharedSvgRoutes.PRIMARY_ARROW_UP"
            class="svg-size-14 d-flex"
        ></svg-icon>
    </div>
</ng-template>

<ng-template #mileUnits let-unit="unit">
    @let truckId = details?.truck?.id;

    <div
        class="h-26 br-2 p-y-4 p-x-6 background-hover-black d-grid c-pointer miles-unit-dropdown gap-1"
        [class.miles-unit-dropdown-large]="isStopListWidthExpanded"
        (click)="selectUnit(unit.truck.id)"
    >
        <p
            class="text-size-14 text-color-white text-ellipsis"
            [class.ta-font-bold]="unit.truck.id === truckId"
        >
            {{ unit.truck.truckNumber }}
        </p>

        <div class="d-flex align-items-center gap-1 m-l-auto">
            <span
                class="m-r-4 text-color-muted text-size-11 miles-unit-dropdown-owner text-ellipsis"
                [class.ta-font-bold]="unit.truck.id === truckId"
                [class.text-color-blue-19]="unit.truck.id === truckId"
            >
                {{ unit.truck.owner }}
            </span>

            <span
                class="m-r-4 text-color-muted text-size-11 miles-unit-dropdown-vin text-ellipsis"
            >
                {{ unit.vin }}
            </span>

            <div class="w-42 h-18 d-flex">
                @let truckPath =
                    sharedSvgRoutes.TRUCK_PATH_BASE +
                    unit.truck.truckType.logoName;

                <svg-icon
                    class="svg-size-42-18 d-flex"
                    [src]="truckPath"
                ></svg-icon>
            </div>
        </div>
    </div>
</ng-template>
