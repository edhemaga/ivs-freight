@let details = milesStoreService.detailsSelector$ | async;
@let pagination = milesStoreService.unitsPaginationSelector$ | async;
@let isPreviousButtonDisabled = pagination.isFirstUnit;
@let isNextButtonDisabled = pagination.isLastUnit;

@if (details) {
    <div class="position-relative z-2">
        <div
            class="background-white br-3 p-x-6 mb-2"
            [ngClass]="isStopListExpanded ? 'w-442' : 'w-334'"
        >
            <!-- TODO:  UroÅ¡ will replace all of this with component once it is done -->
            <div
                class="h-42 d-flex align-items-center p-l-8 justify-content-between"
            >
                <span
                    class="d-flex align-items-center text-size-20 text-color-black ta-font-bold"
                >
                    @if (!details?.truck?.status) {
                        <svg-icon
                            [src]="sharedSvgRoutes.DEACTIVATE_ICON"
                            class="svg-fill-muted svg-size-18 m-r-6 d-flex"
                        ></svg-icon>
                    }
                    UNIT {{ details?.truck?.truckNumber }}
                </span>

                <div class="d-flex gap-1">
                    <div
                        class="d-flex align-items-center justify-content-center h-26 w-26 br-2 background-white svg-fill-muted"
                        [ngClass]="
                            !isPreviousButtonDisabled &&
                            'c-pointer background-hover-bw2 svg-hover-black'
                        "
                    >
                        <svg-icon
                            class="svg-size-18"
                            [src]="sharedSvgRoutes.ARROW_LEFT_ICON"
                            (click)="
                                !isPreviousButtonDisabled &&
                                    getTruckUnit(
                                        ArrowActionsStringEnum.PREVIOUS
                                    )
                            "
                        ></svg-icon>
                    </div>
                    <div
                        class="d-flex align-items-center justify-content-center h-26 w-26 br-2 background-white svg-fill-muted"
                        [ngClass]="
                            !isNextButtonDisabled &&
                            'c-pointer background-hover-bw2 svg-hover-black'
                        "
                    >
                        <svg-icon
                            [src]="sharedSvgRoutes.ARROW_RIGHT_ICON"
                            class="svg-size-18"
                            (click)="
                                !isNextButtonDisabled &&
                                    getTruckUnit(ArrowActionsStringEnum.NEXT)
                            "
                        ></svg-icon>
                    </div>
                </div>
            </div>
        </div>
        <div
            class="background-white br-3 p-x-6 p-y-6 miles-unit-list"
            [ngClass]="isStopListExpanded ? 'w-442' : 'w-334'"
        >
            <form [formGroup]="searchForm">
                <app-ca-input
                    formControlName="search"
                    [inputConfig]="searchField"
                ></app-ca-input>
            </form>

            <div
                class="h-22 d-grid align-items-center p-r-6 gap-1 m-t-6"
                [ngClass]="
                    isStopListExpanded
                        ? 'stops-container-large'
                        : 'stops-container-small'
                "
            >
                @for (item of stopsConfig; let i = $index; track i) {
                    @if (!item.isExpandable || isStopListExpanded) {
                        <div
                            class="text-color-muted text-size-11 ta-font-bold"
                            [ngClass]="{
                                'text-right': item.isAlignedRight,
                                'text-center': item.isAlignedCenter,
                            }"
                        >
                            {{ item.label }}
                        </div>
                    }
                }
            </div>

            <div class="divider mt-1 mb-1"></div>

            <!-- TODO:  Virtaul scroll is inside new ticket -->
            <div class="scrollable-element">
                <cdk-virtual-scroll-viewport
                    #viewport
                    (scroll)="onScrollEvent()"
                    [itemSize]="26"
                    style="height: calc(100vh - 188px)"
                >
                    <div *cdkVirtualFor="let stop of details?.stops?.data">
                        <ng-container
                            *ngTemplateOutlet="
                                stopRows;
                                context: {
                                    stop,
                                }
                            "
                        >
                        </ng-container>
                    </div>
                </cdk-virtual-scroll-viewport>
            </div>

            <div (click)="toogleStopList()">
                <ng-container *ngTemplateOutlet="resizeButton"> </ng-container>
            </div>
        </div>
    </div>
}

<ng-template #resizeButton>
    <!-- TODO:  Inside virtual sroll ticket -->
    <!-- <div class="h-26 w-26 background-white">></div> -->
</ng-template>

<ng-template #stopRows let-stop="stop">
    <div
        class="h-26 br-2 background-white background-hover-light-grey d-grid align-items-center p-r-6 gap-1 c-pointer"
        [ngClass]="
            isStopListExpanded
                ? 'stops-container-large'
                : 'stops-container-small'
        "
    >
        <div class="text-color-muted text-size-11 text-center">
            {{ stop.order }}
        </div>
        <div
            class="text-color-black text-size-11 ta-font-bold text-truncate d-flex"
        >
            @let location = stop.location;
            <svg-icon
                [src]="(stop.type.name | milesIcon).icon"
                [ngClass]="(stop.type.name | milesIcon).color"
                class="svg-size-14 d-flex m-r-4"
            ></svg-icon>
            {{ location.city }}, {{ location.stateShortName }}
            {{ location.zipCode }}
        </div>
        <div class="text-color-black text-size-11 text-right">
            {{ (stop.legMiles | thousandSeparator) ?? '0.0' }}
        </div>
        @if (isStopListExpanded) {
            <div class="text-color-black text-size-11 text-right">
                {{ (stop.loadedMiles | thousandSeparator) ?? '0.0' }}
            </div>
            <div class="text-color-black text-size-11 text-right">
                {{ (stop.emptyMiles | thousandSeparator) ?? '0.0' }}
            </div>
        }
        <div class="text-color-black text-size-11 ta-font-medium text-right">
            {{ (stop.totalMiles | thousandSeparator) ?? '0.0' }}
        </div>
    </div>
</ng-template>
