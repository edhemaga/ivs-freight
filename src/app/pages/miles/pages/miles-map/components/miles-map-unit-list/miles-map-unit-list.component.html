@let details = milesStoreService.milesDetailsSelector$ | async;
@let stops = milesStoreService.stopsSelectors$ | async;

@if (details) {
    <div
        class="background-white br-3 p-x-6 p-y-6 mb-2"
        [ngClass]="isStopListExpanded ? 'w-442' : 'w-334'"
    >
        <div class="d-flex align-items-center p-l-8 justify-content-between">
            <span class="text-size-20 text-color-black ta-font-bold">
                UNIT {{ details?.truck?.truckNumber }}
            </span>

            <div class="d-flex gap-1">
                <div
                    class="d-flex align-items-center justify-content-center h-26 w-26 br-2 background-white background-hover-bw2 svg-fill-muted svg-hover-black c-pointer"
                >
                    <svg-icon
                        [src]="sharedSvgRoutes.ARROW_LEFT_ICON"
                        class="svg-size-18"
                    ></svg-icon>
                </div>
                <div
                    class="d-flex align-items-center justify-content-center h-26 w-26 br-2 background-hover-bw2 background-white svg-fill-muted svg-hover-black c-pointer"
                >
                    <svg-icon
                        [src]="sharedSvgRoutes.ARROW_RIGHT_ICON"
                        class="svg-size-18"
                    ></svg-icon>
                </div>
            </div>
        </div>
    </div>
    <div
        class="background-white br-3 p-x-6 p-y-6"
        [ngClass]="isStopListExpanded ? 'w-442' : 'w-334'"
    >
        <form [formGroup]="searchForm">
            <app-ca-input
                formControlName="search"
                [inputConfig]="{
                    name: 'search',
                    type: 'text',
                    label: 'Find Stop',
                    placeholderIcon: 'ic_search',
                    placeholderInsteadOfLabel: true,
                }"
            ></app-ca-input>
        </form>

        <div
            class="h-22 d-grid align-items-center p-r-6 gap-1 m-t-6"
            [ngClass]="
                isStopListExpanded
                    ? 'stops-container-large'
                    : 'stops-container-small'
            "
        >
            <div class="text-color-muted text-size-11 ta-font-bold text-center">
                #
            </div>
            <div class="text-color-muted text-size-11 ta-font-bold">STOP</div>
            <div class="text-color-muted text-size-11 ta-font-bold text-right">
                LEG
            </div>
            @if (isStopListExpanded) {
                <div
                    class="text-color-muted text-size-11 ta-font-bold text-right"
                >
                    LOADED
                </div>
                <div
                    class="text-color-muted text-size-11 ta-font-bold text-right"
                >
                    EMPTY
                </div>
            }
            <div class="text-color-muted text-size-11 ta-font-bold text-right">
                TOTAL
            </div>
        </div>

        <div class="divider mt-1 mb-1"></div>

        <div class="scrollable-element">
            <cdk-virtual-scroll-viewport
                #viewport
                (scroll)="onScrollEvent()"
                [itemSize]="26"
                style="height: 700px"
            >
                <div *cdkVirtualFor="let stop of stops">
                    <ng-container
                        *ngTemplateOutlet="
                            stopRows;
                            context: {
                                stop,
                            }
                        "
                    >
                    </ng-container>
                </div>
            </cdk-virtual-scroll-viewport>
        </div>

        <div (click)="toogleStopList()">
            <ng-container *ngTemplateOutlet="resizeButton"> </ng-container>
        </div>
    </div>
}

<ng-template #resizeButton>
    <div class="h-26 w-26 background-white">></div>
</ng-template>

<ng-template #stopRows let-stop="stop">
    <div
        class="h-26 br-2 background-white background-hover-light-grey d-grid align-items-center p-r-6 gap-1 c-pointer"
        [ngClass]="
            isStopListExpanded
                ? 'stops-container-large'
                : 'stops-container-small'
        "
    >
        <div class="text-color-muted text-size-11 text-center">
            {{ stop.order }}
        </div>
        <div
            class="text-color-black text-size-11 ta-font-bold text-truncate d-flex"
        >
            @let location = stop.location;
            <svg-icon
                [src]="(stop.type.name | milesIcon).icon"
                [ngClass]="(stop.type.name | milesIcon).color"
                class="svg-size-14 d-flex m-r-4"
            ></svg-icon>
            {{ location.city }}, {{ location.stateShortName }}
            {{ location.zipCode }}
        </div>
        <div class="text-color-black text-size-11 text-right">
            {{ (stop.legMiles | thousandSeparator) ?? '0.0' }}
        </div>
        @if (isStopListExpanded) {
            <div class="text-color-black text-size-11 text-right">
                {{ (stop.legMiles | thousandSeparator) ?? '0.0' }}
            </div>
            <div class="text-color-black text-size-11 text-right">
                {{ (stop.legMiles | thousandSeparator) ?? '0.0' }}
            </div>
        }
        <div class="text-color-black text-size-11 ta-font-medium text-right">
            {{ (stop.totalMiles | thousandSeparator) ?? '0.0' }}
        </div>
    </div>
</ng-template>
