@let store = milesStoreService.miles$ | async;
@let cardsFlipType = milesStoreService.cardFlipViewModeSelector$ | async;

@if (store) {
    <ca-table-card-view
        [viewData]="store"
        [frontSide]="frontSide"
        [backSide]="backSide"
        [cardTitle]="'unit'"
        [isDropdownMenuHidden]="true"
        [cardsFlipType]="cardsFlipType"
    ></ca-table-card-view>

    <ng-template #frontSide let-data="data">
        @for (item of frontSideData; track $index) {
            <ng-container
                *ngTemplateOutlet="
                    cardTemplate;
                    context: { item: item, data: data }
                "
            ></ng-container>
        }
    </ng-template>

    <ng-template #backSide let-data="data">
        @for (item of backSideData; track $index) {
            <ng-container
                *ngTemplateOutlet="
                    cardTemplate;
                    context: { item: item, data: data }
                "
            ></ng-container>
        }
    </ng-template>

    <ng-template #cardTemplate let-item="item" let-data="data">
        <ng-container
            *ngTemplateOutlet="
                item.template === 'doubleTextPercent'
                    ? doubleTextPercent
                    : textWithTitle;
                context: {
                    title: item.title,
                    text:
                        item.format === 'currency'
                            ? ((data
                                  | getNestedValue: item.key
                                  | formatCurrency) ?? 0)
                            : ((data
                                  | getNestedValue: item.key
                                  | thousandSeparator) ?? 0),
                    percent: item.percentKey
                        ? (data | getNestedValue: item.percentKey)
                        : null,
                }
            "
        ></ng-container>
    </ng-template>

    <ng-template #textWithTitle let-title="title" let-text="text">
        <div class="d-flex flex-column px-1 gap-1">
            <div class="text-size-11 text-color-black ta-font-bold">
                {{ title }}
            </div>
            <div class="text-size-14 text-color-black-2">{{ text }}</div>
        </div>
    </ng-template>

    <ng-template #textWithImage let-title="title" let-text="text" let-image="image">
        <div class="d-flex flex-column px-1 gap-1">
            <div class="text-size-11 text-color-black ta-font-bold">
                {{ title }}
            </div>
            <div class="text-size-14 text-color-black-2">{{ text }}</div>
        </div>
    </ng-template>

    <ng-template
        #doubleTextPercent
        let-title="title"
        let-text="text"
        let-percent="percent"
    >
        <div class="d-flex flex-column px-1 gap-1">
            <div class="text-size-11 text-color-black ta-font-bold">
                {{ title }}
            </div>
            <div class="text-size-14 text-color-black-2">
                {{ text }}
                <span class="text-size-11 text-color-grey ta-font-semi-bold"
                    >{{ percent }}%</span
                >
            </div>
        </div>
    </ng-template>
}
