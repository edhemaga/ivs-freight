<!-- <ng-template #loading>
  <span class="d-flex justify-content-center"> LOADING... </span>
</ng-template> -->

<div class="d-flex flex-column justify-content-center step-container">
  <!-- *ngIf="
    !(loadingApplicant$ | async) ||
      !(loadingBankData$ | async) ||
      !(loadingPersonalInfo$ | async);
    else loading
  " -->
  <h1 class="text-center step-title ta-font-bold">Driver Application</h1>

  <!-- TOP SECTION -->

  <div
    class="d-flex flex-column text-center top-section"
    *ngIf="!personalInfoForm.get('isAgreement').value"
  >
    <p class="ta-font-regular">
      In compliance with Federal and State equal opportunity laws, qualified
      applicants are considered for all positions<br />without regard to race,
      religion, sex national origin, age marital status, or non-job related
      disability.
    </p>
    <p class="ta-font-regular">
      I understand that information I provide regarding current and/or previous
      employers may be used, and those<br />employer(s) will be contacted, for
      the purpose of investigation my safety performance history as required by
      49 CFR<br />391.23(d) and (e).
    </p>
  </div>

  <!-- MID SECTION -->

  <div
    class="d-flex flex-column text-center mid-section"
    [formGroup]="personalInfoForm"
    [ngStyle]="{
      'margin-top': !personalInfoForm.get('isAgreement').value ? '25px' : '22px'
    }"
  >
    <app-ta-checkbox
      formControlName="isAgreement"
      [name]="'isAgreement'"
      [label]="'I also understand that JD Freight have the right to:'"
      [customClass]="'bold-12'"
    ></app-ta-checkbox>
  </div>

  <!-- BOTTOM SECTION -->

  <div class="d-flex flex-column text-center bottom-section">
    <p
      class="ta-font-regular"
      [ngStyle]="{
        color: !personalInfoForm.get('isAgreement').value
          ? '#3551B7'
          : '#6C6C6C'
      }"
    >
      Review information provided by previous employers. Have errors in the
      information corrected by<br />previous employers and for those previous
      employers to re-send the corrected
    </p>

    <p class="ta-font-regular">
      Information to the prospective employer, and. Have a rebuttal statement
      attached to the alleged erroneous<br />
      information, if the previous employer(s) and I cannot agree on the
      accuracy of the information
    </p>
  </div>

  <!-- FORM SECTION -->

  <div
    class="d-flex justify-content-center form-section"
    *ngIf="personalInfoForm.get('isAgreement').value"
  >
    <form [formGroup]="personalInfoForm">
      <!-- FIRST NAME, LAST NAME, DOB -->

      <div class="d-flex form-input-container">
        <div class="group first-name-group">
          <app-ta-input
            formControlName="firstName"
            [inputConfig]="{
              name: 'First Name',
              type: 'text',
              label: 'First Name',
              isRequired: true,
              textTransform: 'capitalize',
              autoFocus: true
            }"
          ></app-ta-input>
        </div>
        <div class="group last-name-group">
          <app-ta-input
            formControlName="lastName"
            [inputConfig]="{
              name: 'Last Name',
              type: 'text',
              label: 'Last Name',
              isRequired: true,
              textTransform: 'capitalize'
            }"
          ></app-ta-input>
        </div>
        <div class="group date-group">
          <app-ta-input
            formControlName="dateOfBirth"
            [inputConfig]="{
              name: 'datepicker',
              type: 'text',
              label: 'DOB',
              placeholderIcon: 'date',
              isRequired: true,
              customClass: 'datetimeclass'
            }"
          ></app-ta-input>
        </div>

        <!-- REVIEW AND FEEDBACK -->

        <div class="review-feedback" *ngIf="selectedMode === 'REVIEW_MODE'">
          <app-applicant-review-feedback
            [index]="0"
            [reviewFeedbackData]="reviewFeedback[0]"
            (sendReview)="onSubmitReview($event)"
          ></app-applicant-review-feedback>
        </div>
      </div>

      <!--  PHONE, EMAIL-->

      <div class="d-flex form-input-container">
        <div class="group phone-group">
          <app-ta-input
            formControlName="phone"
            [inputConfig]="{
              name: 'Phone',
              type: 'text',
              label: 'Phone',
              isRequired: true,
              placeholderIcon: 'phone',
              mask: '(000) 000-0000'
            }"
          ></app-ta-input>
        </div>
        <div class="group email-group">
          <app-ta-input
            formControlName="email"
            [inputConfig]="{
              name: 'Email',
              type: 'text',
              label: 'Email',
              isRequired: true,
              placeholderIcon: 'email',
              isDisabled: true
            }"
          ></app-ta-input>
        </div>

        <!-- REVIEW AND FEEDBACK -->

        <div class="review-feedback" *ngIf="selectedMode === 'REVIEW_MODE'">
          <app-applicant-review-feedback
            [index]="1"
            [reviewFeedbackData]="reviewFeedback[1]"
            (sendReview)="onSubmitReview($event)"
          ></app-applicant-review-feedback>
        </div>
      </div>

      <!-- PREVIOUS ADDRESSES -->

      <div
        class="d-flex flex-column justify-content-center previous-addresses"
        formArrayName="previousAddresses"
      >
        <div class="d-flex flex-column justify-content-center">
          <div
            class="d-flex flex-column justify-content-center dets-container"
            *ngFor="
              let address of previousAddresses?.controls;
              let i = index;
              let last = last;
              let first = first;
              trackBy: trackByIdentity
            "
            [ngStyle]="{
              'margin-top':
                (isEditingArray[i]?.isEditing &&
                  isEditingMiddlePositionAddress) ||
                (isEditingArray[i]?.isEditing &&
                  isEditingMiddlePositionAddress &&
                  last)
                  ? '36px'
                  : '0',
              'margin-bottom':
                isEditingArray[i]?.isEditing &&
                isEditingMiddlePositionAddress &&
                !last
                  ? '22px'
                  : isEditingArray[i]?.isEditing &&
                    !isEditingMiddlePositionAddress &&
                    first &&
                    previousAddresses?.controls.length > 1
                  ? '22px'
                  : '2px'
            }"
          >
            <div
              class="d-flex align-items-center title-container"
              *ngIf="
                (previousAddresses.controls.length > 1 &&
                  helperIndex !== 0 &&
                  i === 0) ||
                (helperIndex === 0 && i === 1)
              "
            >
              <div class="address-title-container">
                <p class="m-0 ta-font-bold">
                  Address, City, State Zip <span>*</span>
                </p>
              </div>
              <div class="address-unit-title-container">
                <p class="m-0 ta-font-bold">Unit #</p>
              </div>
            </div>

            <div
              class="d-flex align-items-center"
              [formGroupName]="i"
              [ngStyle]="{
                'margin-top':
                  previousAddresses?.controls.length > 1 &&
                  last &&
                  isEditingArray[i].isEditing &&
                  !isLastInputDeleted
                    ? '32px'
                    : '0'
              }"
            >
              <div
                class="d-flex align-items-center right-container"
                [ngStyle]="{
                  'background-color': isEditingArray[i]?.isEditing
                    ? '#ffffff'
                    : '#F3F3F3',
                  padding: isEditingArray[i]?.isEditing ? '0' : '4px 6px'
                }"
              >
                <div
                  class="d-flex align-items-center input-container"
                  *ngIf="isEditingArray[i]?.isEditing"
                >
                  <div class="d-flex align-items-center">
                    <div
                      class="address-container"
                      [ngStyle]="{
                        width:
                          isEditingArray[i]?.isEditing &&
                          !isEditingArray[i]?.isEditingAddress &&
                          !isLastInputDeleted &&
                          !isEditingArray[i]?.isFirstAddress
                            ? '442px'
                            : isEditingArray[i]?.isEditing &&
                              !isEditingArray[i]?.isEditingAddress &&
                              isEditingArray[i]?.isFirstAddress &&
                              previousAddresses.controls.length === 1
                            ? '480px'
                            : '412px'
                      }"
                    >
                      <app-ta-input-address
                        formControlName="address"
                        [inputConfig]="{
                          name: 'Address',
                          type: 'text',
                          label: 'Address, City, State Zip',
                          isRequired: true,
                          placeholderIcon: 'address',
                          textTransform: 'capitalize'
                        }"
                        (selectedAddress)="
                          handleInputSelect($event, 'PREVIOUS-ADDRESS', i)
                        "
                      ></app-ta-input-address>
                    </div>

                    <div class="address-unit-container">
                      <app-ta-input
                        formControlName="addressUnit"
                        [inputConfig]="{
                          name: 'Address Unit',
                          type: 'text',
                          label: 'Unit #',
                          maxLength: 6
                        }"
                      ></app-ta-input>
                    </div>

                    <div
                      class="d-flex align-items-center justify-content-center confirm-cancel-btn-container"
                      *ngIf="
                        isEditingArray[i]?.isEditing &&
                        isEditingArray[i]?.isEditingAddress
                      "
                    >
                      <div
                        ngbTooltip
                        mainTooltip="Confirm"
                        tooltipBackground="#536BC2"
                        position="top"
                      >
                        <svg-icon
                          class="confirm-icon"
                          src="assets/svg/ic_spec-confirm.svg"
                          [svgStyle]="{
                            'width.px': 26,
                            'height.px': 26
                          }"
                          (click)="onConfirmEditedNewAddress(i)"
                        ></svg-icon>
                      </div>

                      <div
                        ngbTooltip
                        mainTooltip="Cancel"
                        tooltipBackground="#6C6C6C"
                        position="top"
                      >
                        <svg-icon
                          class="cancel-icon"
                          src="assets/svg/ic_x.svg"
                          [svgStyle]="{
                            'width.px': 26,
                            'height.px': 26
                          }"
                          (click)="onCancelEditingNewAddress(i)"
                        ></svg-icon>
                      </div>
                    </div>

                    <div
                      class="d-flex align-items-center justify-content-center delete-btn-container"
                      *ngIf="
                        isEditingArray[i]?.isEditing &&
                        !isEditingArray[i]?.isEditingAddress &&
                        i === previousAddresses?.controls.length - 1 &&
                        !isLastInputDeleted &&
                        !isEditingArray[i].isFirstAddress
                      "
                    >
                      <div
                        ngbTooltip
                        mainTooltip="Delete"
                        tooltipBackground="#EF5350"
                        position="top"
                      >
                        <svg-icon
                          class="delete-icon"
                          src="assets/svg/truckassist-table/dropdown/content/delete.svg"
                          [svgStyle]="{
                            'width.px': 18,
                            'height.px': 18
                          }"
                          (click)="onRemoveNewAddress(i)"
                        ></svg-icon>
                      </div>
                    </div>
                  </div>
                </div>

                <div
                  class="d-flex align-items-center info-container"
                  *ngIf="
                    !isEditingArray[i]?.isEditing &&
                    !isEditingArray[i]?.isEditingAddress
                  "
                >
                  <div
                    class="d-flex align-items-center text-truncate address-container"
                  >
                    <svg-icon
                      class="address-icon"
                      src="assets/svg/common/ic_address.svg"
                      [svgStyle]="{
                        'width.px': 18,
                        'height.px': 18
                      }"
                    ></svg-icon>

                    <div class="d-flex pipe"></div>

                    <p class="m-0 ta-font-regular">
                      {{ address.value?.address }}
                    </p>
                  </div>

                  <div class="d-flex align-items-center address-unit-container">
                    <p
                      class="d-inline-block text-truncate m-0 ta-font-regular"
                      style="max-width: 300px"
                    >
                      {{ address.value?.addressUnit }}
                    </p>
                  </div>
                </div>

                <div
                  class="d-flex align-items-center btn-container"
                  *ngIf="!isEditingArray[i]?.isEditing"
                >
                  <div
                    ngbTooltip
                    mainTooltip="Edit"
                    tooltipBackground="#6C6C6C"
                    position="top"
                  >
                    <svg-icon
                      class="edit-icon"
                      src="assets/svg/truckassist-table/dropdown/content/edit-hover.svg"
                      [svgStyle]="{
                        'width.px': 18,
                        'height.px': 18
                      }"
                      (click)="onEditNewAddress(i)"
                    ></svg-icon>
                  </div>

                  <div
                    ngbTooltip
                    mainTooltip="Delete"
                    tooltipBackground="#EF5350"
                    position="top"
                  >
                    <svg-icon
                      class="delete-icon"
                      src="assets/svg/truckassist-table/dropdown/content/delete.svg"
                      [svgStyle]="{
                        'width.px': 18,
                        'height.px': 18
                      }"
                      (click)="onRemoveNewAddress(i)"
                    ></svg-icon>
                  </div>
                </div>
              </div>

              <!-- REVIEW AND FEEDBACK -->

              <div
                class="review-feedback"
                *ngIf="selectedMode === 'REVIEW_MODE'"
              >
                <app-applicant-review-feedback
                  [index]="11 + i"
                  [reviewFeedbackData]="reviewFeedback[11 + i]"
                  (sendReview)="onSubmitReview($event)"
                ></app-applicant-review-feedback>
              </div>
            </div>
          </div>
        </div>

        <div
          class="d-flex align-items-center previous-address-btn-container"
          [ngStyle]="{
            'margin-top': previousAddresses?.controls.length > 0 ? '22px' : '0'
          }"
          *ngIf="previousAddresses.controls?.length < 5"
        >
          <h5 class="m-0 ta-font-bold previous-address-title">
            Previous addresses for the past 3 years?
          </h5>
          <button
            type="button"
            class="d-flex justify-content-center align-items-center ta-font-bold add-btn"
            (click)="onAddNewAddress()"
            [ngClass]="{
              disabled:
                previousAddresses.controls.length !== 0 &&
                !isLastAddedPreviousAddressValid &&
                !isLastInputDeleted
            }"
          >
            <svg-icon
              class="plus-icon"
              src="assets/svg/common/ic_plus.svg
        "
              [svgStyle]="{
                'width.px': 18,
                'height.px': 18
              }"
            ></svg-icon>

            Add Address
          </button>
        </div>
      </div>

      <!-- SSN, BANK NAME -->

      <div class="d-flex form-input-container">
        <div class="group ssn-group">
          <app-ta-input
            formControlName="ssn"
            [inputConfig]="{
              name: 'SSN',
              type: 'text',
              label: 'SSN',
              isRequired: true,
              mask: '000-00-0000'
            }"
          ></app-ta-input>
        </div>
        <div class="group bank-group">
          <app-ta-input-dropdown
            formControlName="bankId"
            [template]="'svg-template'"
            [inputConfig]="{
              name: 'Input Dropdown',
              type: 'text',
              label: 'Bank Name',
              isDropdown: true,
              dropdownWidthClass: 'w-col-applicant-bank'
            }"
            [options]="banksDropdownList"
            (selectedItem)="handleInputSelect($event, 'BANK')"
          ></app-ta-input-dropdown>
        </div>

        <!-- REVIEW AND FEEDBACK -->

        <div class="review-feedback" *ngIf="selectedMode === 'REVIEW_MODE'">
          <app-applicant-review-feedback
            [index]="3"
            [reviewFeedbackData]="reviewFeedback[3]"
            (sendReview)="onSubmitReview($event)"
          ></app-applicant-review-feedback>
        </div>
      </div>

      <!-- ACCOUNT NUMBER, ROUTING NUMBER -->

      <div class="d-flex form-input-container">
        <div class="group account-number-group">
          <app-ta-input
            formControlName="accountNumber"
            [inputConfig]="{
              name: 'Account Number',
              type: 'text',
              label: 'Account number',
              isDisabled: !isBankSelected,
              isRequired: isBankSelected,
              maxLength: 17,
              minLength: 4
            }"
          ></app-ta-input>
        </div>
        <div class="group routing-number-group">
          <app-ta-input
            formControlName="routingNumber"
            [inputConfig]="{
              name: 'Routing Number',
              type: 'text',
              label: 'Routing number',
              isDisabled: !isBankSelected,
              isRequired: isBankSelected,
              minLength: 9,
              maxLength: 9
            }"
          ></app-ta-input>
        </div>

        <!-- REVIEW AND FEEDBACK -->

        <div class="review-feedback" *ngIf="selectedMode === 'REVIEW_MODE'">
          <app-applicant-review-feedback
            [index]="4"
            [reviewFeedbackData]="reviewFeedback[4]"
            (sendReview)="onSubmitReview($event)"
          ></app-applicant-review-feedback>
        </div>
      </div>

      <!-- QUESTIONS SECTION -->

      <ng-container *ngIf="questions">
        <div class="questions-section">
          <div
            class="d-flex flex-column question-container"
            *ngFor="
              let question of questions;
              let i = index;
              trackBy: trackByIdentity
            "
          >
            <div class="d-flex align-items-center justify-content-between">
              <div class="question-title-box">
                <p class="m-0 question-title ta-font-regular">
                  {{ question.title }}

                  <span class="required-star">*</span>
                </p>
              </div>

              <div class="question-radios-box">
                <app-ta-input-radiobuttons
                  [buttons]="question.answerChoices"
                  (changedValue)="handleInputSelect($event, 'ANSWER-CHOICE')"
                ></app-ta-input-radiobuttons>
              </div>

              <!-- REVIEW AND FEEDBACK -->

              <div
                class="review-feedback"
                *ngIf="selectedMode === 'REVIEW_MODE'"
              >
                <app-applicant-review-feedback
                  [index]="5 + i"
                  [reviewFeedbackData]="reviewFeedback[5 + i]"
                  (sendReview)="onSubmitReview($event)"
                ></app-applicant-review-feedback>
              </div>
            </div>

            <span
              class="required-note ta-font-semi-bold"
              *ngIf="
                personalInfoForm.controls[question.formControlNameExplain]
                  .status !== 'DISABLED' &&
                !personalInfoForm.controls[question.formControlNameExplain]
                  ?.valid &&
                personalInfoForm.controls[question.formControlNameExplain]
                  ?.touched &&
                !personalInfoForm.controls[question.formControlNameExplain]
              "
              >Required</span
            >

            <!-- EXPLAIN -->

            <div
              class="d-flex explain-container"
              *ngIf="
                personalInfoForm.get(question.formControlName)?.value === 'YES'
              "
              [ngStyle]="{
                'margin-bottom':
                  personalInfoForm.get(question.formControlName)?.value ===
                  'YES'
                    ? '20px'
                    : '0'
              }"
            >
              <div class="w-100">
                <app-ta-input
                  [formControlName]="question.formControlNameExplain"
                  [inputConfig]="{
                    name: 'Explain',
                    type: 'text',
                    label: 'Please explain',
                    isRequired: true,
                    textTransform: 'capitalize',
                    placeholder: 'Please explain',
                    placeholderInsteadOfLabel: true
                  }"
                ></app-ta-input>
              </div>
            </div>
          </div>
        </div>
      </ng-container>
    </form>
  </div>
</div>

<!-- NEXT BTN -->

<div
  class="d-flex justify-content-center align-items-center next-btn-container"
>
  <app-applicant-next-back-btn
    [nextStep]="true"
    (stepEvent)="onStepAction($event)"
  ></app-applicant-next-back-btn>
</div>

<!-- CONFIRM ALL REVIEW -->

<app-applicant-confirm-all-review
  *ngIf="selectedMode === 'REVIEW_MODE'"
></app-applicant-confirm-all-review>
