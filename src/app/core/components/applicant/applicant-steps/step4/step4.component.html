<div class="d-flex flex-column align-items-center step-container">
    <h1 class="m-0 step-title text-center ta-font-bold">Accident record</h1>

    <!-- TOP SECTION -->

    <div class="d-flex text-center top-section">
        <p
            class="m-0 ta-font-regular"
            [ngStyle]="{
                color: selectedMode === 'FEEDBACK_MODE' ? '#919191' : '#2F2F2F'
            }"
        >
            Please list all motor vehicle collisions in which you were
            involved<br />
            (both commercial and private vehicle) during the past 3 years prior
            to the application date.
        </p>
    </div>

    <!-- MID SECTION -->

    <div
        class="d-flex justify-content-center text-center mid-section"
        [formGroup]="accidentForm"
    >
        <app-ta-checkbox
            formControlName="hasPastAccident"
            [name]="'hasPastAccident'"
            [label]="'No accidents for past 3 years'"
            [customClass]="'bold-12'"
            [disabledStillCheckMark]="selectedMode !== 'APPLICANT_MODE'"
        ></app-ta-checkbox>
    </div>

    <ng-container *ngIf="!accidentForm.get('hasPastAccident').value">
        <div class="d-flex flex-column form-section">
            <!--  CREATED ACCIDENT DATA -->

            <ng-container *ngIf="accidentArray.length">
                <div
                    class="d-flex flex-column justify-content-center accidents-container"
                    [formGroup]="accidentForm"
                >
                    <div class="align-items-center title-container">
                        <div class="align-items-center date-state-title-box">
                            <p class="m-0 ta-font-bold">STATE & DATE</p>
                        </div>

                        <div class="align-items-center statistics-title-box">
                            <p class="m-0 ta-font-bold">STATISTICS</p>
                        </div>

                        <div
                            class="align-items-center hazmat-description-title-box"
                        >
                            <p class="m-0 ta-font-bold">
                                H. SPILL & DESCRIPTION
                            </p>
                        </div>
                    </div>

                    <ng-container
                        *ngFor="
                            let accident of accidentArray;
                            let i = index;
                            trackBy: trackByIdentity
                        "
                    >
                        <ng-container *ngIf="!accident.isEditingAccident">
                            <div
                                class="d-flex align-items-center accident-info-container line-container"
                            >
                                <div
                                    class="align-items-center info-btn-container"
                                    (click)="
                                        selectedMode === 'REVIEW_MODE'
                                            ? onCardReview(i)
                                            : onEditAccident(i)
                                    "
                                >
                                    <div
                                        class="d-flex flex-column justify-content-center"
                                    >
                                        <div
                                            class="d-flex align-items-center state-box"
                                        >
                                            <p
                                                class="m-0 ta-font-bold d-inline-block text-truncate"
                                                style="max-width: 126px"
                                                ngbTooltip
                                                [mainTooltip]="
                                                    accident.accidentState +
                                                    ' ' +
                                                    '(' +
                                                    accident.accidentStateShort +
                                                    ')'
                                                "
                                                tooltipBackground="#2F2F2F"
                                                position="bottom-left"
                                            >
                                                {{ accident.accidentState }} ({{
                                                    accident.accidentStateShort
                                                }})
                                            </p>
                                        </div>

                                        <div
                                            class="d-flex align-items-center date-box"
                                        >
                                            <p class="m-0 ta-font-medium">
                                                {{ accident.date }}
                                            </p>
                                        </div>
                                    </div>

                                    <div
                                        class="d-flex flex-column justify-content-center"
                                    >
                                        <div
                                            class="d-flex align-items-center fatalities-box"
                                        >
                                            <div
                                                class="d-flex justify-content-center align-items-center number-box"
                                            >
                                                <p class="m-0 ta-font-bold">
                                                    {{ accident.fatalities }}
                                                </p>
                                            </div>

                                            <p class="m-0 ta-font-regular">
                                                Fatalities
                                            </p>
                                        </div>

                                        <div
                                            class="d-flex align-items-center injuries-box"
                                        >
                                            <div
                                                class="d-flex justify-content-center align-items-center number-box"
                                            >
                                                <p class="m-0 ta-font-bold">
                                                    {{ accident.injuries }}
                                                </p>
                                            </div>

                                            <p class="m-0 ta-font-regular">
                                                Injuries
                                            </p>
                                        </div>
                                    </div>

                                    <div
                                        class="d-flex flex-column justify-content-center"
                                    >
                                        <div
                                            class="d-flex align-items-center hazmat-box"
                                        >
                                            <svg-icon
                                                class="hazmat-icon"
                                                [src]="
                                                    'assets/svg/common/ic_hazmat.svg'
                                                "
                                                [svgStyle]="{
                                                    'width.px': '14',
                                                    'height.px': '12'
                                                }"
                                            ></svg-icon>

                                            <p class="m-0 ta-font-semi-bold">
                                                {{
                                                    accident.hazmatSpill
                                                        ? 'Yes'
                                                        : 'No'
                                                }}
                                            </p>
                                        </div>

                                        <div
                                            class="d-flex align-items-center description-box"
                                        >
                                            <p
                                                class="m-0 ta-font-medium d-inline-block text-truncate"
                                                style="max-width: 250px"
                                                ngbTooltip
                                                [mainTooltip]="
                                                    accident.description
                                                "
                                                tooltipBackground="#2F2F2F"
                                                position="bottom-left"
                                            >
                                                {{ accident.description }}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- REVIEW AND FEEDBACK -->

                                <ng-container
                                    *ngIf="selectedMode !== 'APPLICANT_MODE'"
                                >
                                    <div class="review-feedback-container">
                                        <app-applicant-review-feedback
                                            [formControlName]="
                                                'cardReview' + (i + 1)
                                            "
                                            [displayAnnotationButton]="
                                                selectedMode ===
                                                    'REVIEW_MODE' &&
                                                openAnnotationArray[i]
                                                    .displayAnnotationButton
                                            "
                                            [displayAnnotationTextArea]="
                                                selectedMode ===
                                                    'REVIEW_MODE' &&
                                                openAnnotationArray[i]
                                                    .displayAnnotationTextArea
                                            "
                                            [lineIndex]="i"
                                            [cardsLength]="accidentArray.length"
                                            [cardsType]="'accidentRecord'"
                                            [cardIndex]="i"
                                            [isFeedback]="
                                                selectedMode === 'FEEDBACK_MODE'
                                            "
                                            [feedbackText]="
                                                selectedMode ===
                                                    'FEEDBACK_MODE' &&
                                                stepFeedbackValues[i]
                                                    .commonMessage
                                            "
                                            (annotationBtnClickEvent)="
                                                selectedMode ===
                                                    'REVIEW_MODE' &&
                                                    getAnnotationBtnClickValue(
                                                        $event
                                                    )
                                            "
                                        ></app-applicant-review-feedback>
                                    </div>
                                </ng-container>
                            </div>
                        </ng-container>

                        <ng-container *ngIf="accident.isEditingAccident">
                            <div
                                [ngStyle]="{
                                    'margin-bottom':
                                        accidentArray.length > 1 ? '4px' : 0
                                }"
                            >
                                <app-step4-form
                                    [mode]="selectedMode"
                                    [isEditing]="isEditing"
                                    [formValuesToPatch]="formValuesToPatch"
                                    [isReviewingCard]="isReviewingCard"
                                    [displayRadioRequiredNote]="
                                        displayRadioRequiredNote
                                    "
                                    [checkIsHazmatSpillNotChecked]="
                                        checkIsHazmatSpillNotChecked
                                    "
                                    [stepFeedbackValues]="feedbackValuesToPatch"
                                    (formValuesEmitter)="
                                        getAccidentFormValues($event)
                                    "
                                    (cancelFormEditingEmitter)="
                                        cancelAccidentEditing($event)
                                    "
                                    (saveFormEditingEmitter)="
                                        saveEditedAccident($event)
                                    "
                                    (formStatusEmitter)="
                                        onGetFormStatus($event)
                                    "
                                    (cancelFormReviewingEmitter)="
                                        cancelAccidentReview($event)
                                    "
                                    (cardOpenAnnotationArrayValuesEmitter)="
                                        onGetCardOpenAnnotationArrayValues(
                                            $event
                                        )
                                    "
                                    (radioRequiredNoteEmitter)="
                                        onGetRadioRequiredNoteEmit($event)
                                    "
                                ></app-step4-form>
                            </div>
                        </ng-container>
                    </ng-container>
                </div>
            </ng-container>

            <!--  <div
            class="d-flex flex-column justify-content-center accident-view-container"
            *ngIf="accidentArray.length"
            [formGroup]="accidentForm"
        >
            <div
                class="d-flex flex-column"
                *ngFor="
                    let accident of accidentArray;
                    let i = index;
                    trackBy: trackByIdentity
                "
            >
                <div
                    class="d-flex align-items-center title-container"
                    *ngIf="
                        (accidentArray.length > 0 &&
                            helperIndex !== 0 &&
                            i === 0) ||
                        (helperIndex === 0 && i === 1) ||
                        (i === helperIndex + 1 && selectedAccidentIndex > -1)
                    "
                >
                    <div class="d-flex align-items-center date-title-box">
                        <p class="m-0 ta-font-bold">DATE <span>*</span></p>
                    </div>
                    <div class="d-flex align-items-center state-title-box">
                        <p class="m-0 ta-font-bold">STATE <span>*</span></p>
                    </div>
                    <div class="d-flex align-items-center fatalities-title-box">
                        <p class="m-0 ta-font-bold">FAT.</p>
                    </div>
                    <div class="d-flex align-items-center injuries-title-box">
                        <p class="m-0 ta-font-bold">INJ.</p>
                    </div>
                    <div class="d-flex align-items-center hazmat-title-box">
                        <p class="m-0 ta-font-bold">H. SPILL <span>*</span></p>
                    </div>
                    <div
                        class="d-flex align-items-center description-title-box"
                    >
                        <p class="m-0 ta-font-bold">
                            DESCRIPTION <span>*</span>
                        </p>
                    </div>
                </div>

                <div
                    class="d-flex align-items-center accident-info-container line-container"
                    *ngIf="!accident.isEditingAccident"
                >
                    <div class="d-flex align-items-center info-btn-container">
                        <div
                            class="d-flex align-items-center"
                            [ngStyle]="{
                                cursor:
                                    selectedMode === 'REVIEW_MODE'
                                        ? 'pointer'
                                        : 'auto'
                            }"
                            (click)="
                                selectedMode === 'REVIEW_MODE' &&
                                    onCardReview(i)
                            "
                        >
                            <div class="d-flex align-items-center date-box">
                                <p class="m-0 ta-font-regular">
                                    {{ accident.date }}
                                </p>
                            </div>
                            <div class="d-flex align-items-center state-box">
                                <p class="m-0 ta-font-regular">
                                    {{ accident.accidentState }}
                                </p>
                            </div>
                            <div
                                class="d-flex align-items-center fatalities-box"
                            >
                                <p class="m-0 ta-font-regular">
                                    {{ accident.fatalities }}
                                </p>
                            </div>
                            <div class="d-flex align-items-center injuries-box">
                                <p class="m-0 ta-font-regular">
                                    {{ accident.injuries }}
                                </p>
                            </div>
                            <div class="d-flex align-items-center hazmat-box">
                                <p class="m-0 ta-font-regular">
                                    {{ accident.hazmatSpill ? 'Yes' : 'No' }}
                                </p>
                            </div>
                            <div
                                class="d-flex align-items-center description-box"
                                [ngStyle]="{
                                    width:
                                        selectedMode === 'FEEDBACK_MODE'
                                            ? '190px'
                                            : '209px'
                                }"
                            >
                                <p
                                    class="m-0 ta-font-regular d-inline-block text-truncate"
                                    style="max-width: 207px"
                                    ngbTooltip
                                    [mainTooltip]="accident.description"
                                    tooltipBackground="#6C6C6C"
                                    position="bottom-left"
                                >
                                    {{ accident.description }}
                                </p>
                            </div>
                        </div>
                        <div
                            class="d-flex align-items-center btn-container"
                            [ngClass]="{
                                active: selectedMode === 'REVIEW_MODE'
                            }"
                            [ngStyle]="{
                                'margin-left':
                                    selectedMode === 'FEEDBACK_MODE'
                                        ? '18px'
                                        : 0
                            }"
                        >
                            <ng-container
                                *ngIf="
                                    selectedMode === 'APPLICANT_MODE' ||
                                    (selectedMode === 'FEEDBACK_MODE' &&
                                        stepFeedbackValues[i].hasIncorrectValue)
                                "
                            >
                                <div
                                    ngbTooltip
                                    mainTooltip="Edit"
                                    tooltipBackground="#6C6C6C"
                                    position="top"
                                >
                                    <svg-icon
                                        class="edit-icon"
                                        src="assets/svg/truckassist-table/dropdown/content/edit-hover.svg"
                                        [svgStyle]="{
                                            'width.px': 18,
                                            'height.px': 18
                                        }"
                                        (click)="onEditAccident(i)"
                                    ></svg-icon>
                                </div>
                            </ng-container>

                            <ng-container
                                *ngIf="selectedMode === 'APPLICANT_MODE'"
                            >
                                <div
                                    ngbTooltip
                                    mainTooltip="Delete"
                                    tooltipBackground="#EF5350"
                                    position="top"
                                >
                                    <svg-icon
                                        class="delete-icon"
                                        src="assets/svg/truckassist-table/dropdown/content/delete.svg"
                                        [svgStyle]="{
                                            'width.px': 18,
                                            'height.px': 18
                                        }"
                                        (click)="onDeleteAccident(i)"
                                    ></svg-icon>
                                </div>
                            </ng-container>

                            <ng-container
                                *ngIf="selectedMode === 'REVIEW_MODE'"
                            >
                                <div
                                    class="review-icon-box"
                                    ngbTooltip
                                    mainTooltip="Mark Incorrect"
                                    tooltipBackground="#F44336"
                                    position="top"
                                >
                                    <svg-icon
                                        class="review-icon"
                                        [ngClass]="{
                                            active:
                                                openAnnotationArray[i]
                                                    .displayAnnotationButton ||
                                                openAnnotationArray[i]
                                                    .displayAnnotationTextArea
                                        }"
                                        src="assets/svg/ic_x.svg"
                                        [svgStyle]="{
                                            'width.px': 18,
                                            'height.px': 18
                                        }"
                                        (click)="
                                            openAnnotationArray[i].lineInputs[0]
                                                ? incorrectInput(
                                                      $event,
                                                      0,
                                                      i,
                                                      'card'
                                                  )
                                                : onCardReview(i)
                                        "
                                    ></svg-icon>
                                </div>
                            </ng-container>

                            <ng-container
                                *ngIf="
                                    selectedMode === 'FEEDBACK_MODE' &&
                                    stepFeedbackValues[i].hasIncorrectValue
                                "
                            >
                                <div
                                    class="feedback-icon-box"
                                    ngbTooltip
                                    mainTooltip="Marked Incorrect"
                                    tooltipBackground="#F44336"
                                    position="top"
                                >
                                    <svg-icon
                                        class="feedback-icon"
                                        src="assets/svg/common/ic_danger.svg"
                                        [svgStyle]="{
                                            'width.px': 18,
                                            'height.px': 18
                                        }"
                                    ></svg-icon>
                                </div>
                            </ng-container>
                        </div>
                    </div>

                    REVIEW AND FEEDBACK

                    <div
                        class="review-feedback-container"
                        *ngIf="
                            selectedMode === 'REVIEW_MODE' ||
                            selectedMode === 'FEEDBACK_MODE'
                        "
                    >
                        <app-applicant-review-feedback
                            [formControlName]="'cardReview' + (i + 1)"
                            [displayAnnotationButton]="
                                selectedMode === 'REVIEW_MODE' &&
                                openAnnotationArray[i].displayAnnotationButton
                            "
                            [displayAnnotationTextArea]="
                                selectedMode === 'REVIEW_MODE' &&
                                openAnnotationArray[i].displayAnnotationTextArea
                            "
                            [lineIndex]="i"
                            [cardsLength]="accidentArray.length"
                            [cardsType]="'accidentRecord'"
                            [cardIndex]="i"
                            [isFeedback]="selectedMode === 'FEEDBACK_MODE'"
                            [feedbackText]="
                                selectedMode === 'FEEDBACK_MODE' &&
                                stepFeedbackValues[i].commonMessage
                            "
                            (annotationBtnClickEvent)="
                                selectedMode === 'REVIEW_MODE' &&
                                    getAnnotationBtnClickValue($event)
                            "
                        ></app-applicant-review-feedback>
                    </div>
                </div>

                <div
                    *ngIf="accident.isEditingAccident"
                    class="d-flex flex-column accident-view-form"
                    [ngStyle]="{
                        margin:
                            i !== 0 ? '32px auto 0 auto' : '10px auto 0 auto'
                    }"
                >
                    <app-step4-form
                        [mode]="selectedMode"
                        [isEditing]="isEditing"
                        [formValuesToPatch]="formValuesToPatch"
                        [isReviewingCard]="isReviewingCard"
                        [displayRadioRequiredNote]="displayRadioRequiredNote"
                        [checkIsHazmatSpillNotChecked]="
                            checkIsHazmatSpillNotChecked
                        "
                        [stepFeedbackValues]="feedbackValuesToPatch"
                        (cancelFormEditingEmitter)="
                            cancelAccidentEditing($event)
                        "
                        (formValuesEmitter)="getAccidentFormValues($event)"
                        (saveFormEditingEmitter)="saveEditedAccident($event)"
                        (cancelFormReviewingEmitter)="
                            cancelAccidentReview($event)
                        "
                        (cardOpenAnnotationArrayValuesEmitter)="
                            onGetCardOpenAnnotationArrayValues($event)
                        "
                        (radioRequiredNoteEmitter)="
                            onGetRadioRequiredNoteEmit($event)
                        "
                    ></app-step4-form>
                </div>
            </div>
        </div> -->

            <!-- FORM SECTION -->

            <ng-container
                *ngIf="
                    (selectedMode !== 'REVIEW_MODE' &&
                        !hideFormOnEdit &&
                        !displayButtonInsteadOfForm) ||
                    (selectedMode === 'REVIEW_MODE' && !isReviewingCard)
                "
            >
                <app-step4-form
                    [mode]="selectedMode"
                    [isEditing]="isEditing"
                    [markFormInvalid]="markFormInvalid"
                    [formValuesToPatch]="formValuesToPatch"
                    [isReviewingCard]="isReviewingCard"
                    [displayRadioRequiredNote]="displayRadioRequiredNote"
                    [checkIsHazmatSpillNotChecked]="
                        checkIsHazmatSpillNotChecked
                    "
                    [stepFeedbackValues]="feedbackValuesToPatch"
                    (formValuesEmitter)="getAccidentFormValues($event)"
                    (cancelFormEditingEmitter)="cancelAccidentEditing($event)"
                    (saveFormEditingEmitter)="saveEditedAccident($event)"
                    (formStatusEmitter)="onGetFormStatus($event)"
                    (markInvalidEmitter)="onMarkInvalidEmit($event)"
                    (lastFormValuesEmitter)="onGetLastFormValues($event)"
                    (hasIncorrectFieldsEmitter)="onHasIncorrectFields($event)"
                    (openAnnotationArrayValuesEmitter)="
                        onGetOpenAnnotationArrayValues($event)
                    "
                    (radioRequiredNoteEmitter)="
                        onGetRadioRequiredNoteEmit($event)
                    "
                ></app-step4-form>
            </ng-container>

            <ng-container *ngIf="displayButtonInsteadOfForm">
                <div
                    class="d-flex justify-content-center align-items-center btn-instead-form-container"
                >
                    <app-applicant-add-save-btn
                        [addBtn]="true"
                        [btnText]="'Add Another Accident'"
                        (clickValueEmitter)="onGetBtnClickValue($event)"
                    ></app-applicant-add-save-btn>
                </div>
            </ng-container>
        </div>
    </ng-container>
</div>

<!-- NEXT BTN -->

<div
    class="d-flex justify-content-center align-items-center next-btn-container"
>
    <app-applicant-next-back-btn
        [nextStep]="true"
        [filledCorrectly]="
            formStatus === 'VALID' &&
            !isEditing &&
            (selectedMode === 'APPLICANT_MODE' ||
                (selectedMode === 'FEEDBACK_MODE' && isFeedbackValueUpdated))
        "
        [hasIncorrectFields]="
            selectedMode === 'REVIEW_MODE' &&
            (hasIncorrectFields || cardsWithIncorrectFields)
        "
        [mode]="selectedMode"
        (stepEvent)="onStepAction($event)"
    ></app-applicant-next-back-btn>
</div>

<!-- BACK BTN -->

<div
    class="d-flex justify-content-center align-items-center back-btn-container"
>
    <app-applicant-next-back-btn
        [backStep]="true"
        (stepEvent)="onStepAction($event)"
    ></app-applicant-next-back-btn>
</div>
