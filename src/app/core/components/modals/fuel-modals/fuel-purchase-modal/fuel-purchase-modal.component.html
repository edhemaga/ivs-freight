<app-ta-modal
    [modalTitle]="
        editData?.type !== 'edit'
            ? 'Add Fuel Transaction'
            : 'Edit Fuel Transaction'
    "
    [editData]="editData"
    [editName]="fuelTransactionName"
    [isModalValid]="fuelForm.valid && isFormDirty"
    [disableDelete]="true"
    (action)="onModalAction($event)"
>
    <form
        origin
        [formGroup]="fuelForm"
        class="form-container form-container-without-mb"
    >
        <div
            *ngIf="
                editData?.type === 'edit' &&
                fuelTransactionType?.name !== 'Manual'
            "
            class="row"
        >
            <div class="col-6">
                <app-ta-input
                    formControlName="efsAccount"
                    [inputConfig]="{
                        name: 'EFS Account',
                        type: 'text',
                        label: 'EFS Account',
                        isDisabled: true
                    }"
                ></app-ta-input>
            </div>
            <div class="col-6">
                <app-ta-input
                    formControlName="fuelCard"
                    [inputConfig]="{
                        name: 'Fuel Card',
                        type: 'text',
                        label: 'Fuel Card',
                        isDisabled: true,
                        placeholderIcon: 'fuel-card'
                    }"
                ></app-ta-input>
            </div>
        </div>
        <div class="row">
            <div
                [ngClass]="fuelForm.get('trailerId').value ? 'col-4' : 'col-6'"
            >
                <app-ta-input-dropdown
                    formControlName="truckId"
                    [template]="'svgtext-template'"
                    [inputConfig]="{
                        name: 'Input Dropdown',
                        type: 'text',
                        label: 'Truck',
                        isRequired: true,
                        isDropdown: true,
                        dropdownImageInput: {
                            withText: true,
                            svg: true,
                            image: false,
                            url: selectedTruckType?.logoName,
                            template: 'truck',
                            class: selectedTruckType?.name
                                ?.trim()
                                .replace(' ', '')
                                .toLowerCase()
                        },
                        dropdownWidthClass: 'w-col-216',
                        customClass: 'truck-trailer-dropdown'
                    }"
                    [options]="truckType"
                    [activeItem]="selectedTruckType"
                    (selectedItem)="onSelectDropDown($event, 'truck')"
                ></app-ta-input-dropdown>
            </div>
            <div *ngIf="fuelForm.get('trailerId').value" class="col-4">
                <app-ta-input-dropdown
                    formControlName="trailerId"
                    [template]="'svgtext-template'"
                    [inputConfig]="{
                        name: 'Input Dropdown',
                        type: 'text',
                        label: 'Trailer',
                        isRequired: true,
                        isDropdown: true,
                        dropdownImageInput: {
                            withText: true,
                            svg: true,
                            image: false,
                            url: selectedTrailerType?.logoName,
                            template: 'trailer',
                            class: ['Tanker', 'Tanker Pneumatic'].includes(
                                selectedTrailerType?.name
                            )
                                ? 'tanker'
                                : selectedTrailerType?.name
                                      ?.toLowerCase()
                                      ?.includes('rgn')
                                ? 'low-boy-rgn'
                                : selectedTrailerType?.name
                                      ?.trim()
                                      .replace(' ', '')
                                      .toLowerCase()
                        },
                        dropdownWidthClass: 'w-col-216',
                        customClass: 'truck-trailer-dropdown',
                        isDisabled: true
                    }"
                ></app-ta-input-dropdown>
            </div>
            <div
                [ngClass]="
                    fuelForm.get('trailerId').value
                        ? 'col-4 no-p-left'
                        : 'col-6'
                "
            >
                <app-ta-input
                    formControlName="driverFullName"
                    [inputConfig]="{
                        name: 'Full name',
                        type: 'text',
                        label: 'Driver',
                        isDisabled: true,
                        textTransform: 'capitalize',
                        minLength: 2,
                        maxLength: 32
                    }"
                ></app-ta-input>
            </div>
        </div>
        <div class="row">
            <div class="col-6">
                <app-ta-input
                    formControlName="transactionDate"
                    [inputConfig]="{
                        name: 'datepicker',
                        type: 'text',
                        label: 'Date',
                        placeholderIcon: 'date',
                        isRequired: true,
                        isDropdown: true,
                        isDisabled:
                            editData?.type === 'edit' &&
                            fuelTransactionType?.name !== 'Manual',
                        customClass: 'datetimeclass'
                    }"
                ></app-ta-input>
            </div>
            <div class="col-6">
                <!-- Time Picker -->
                <app-ta-input
                    formControlName="transactionTime"
                    [inputConfig]="{
                        name: 'timepicker',
                        type: 'text',
                        label: 'Time',
                        placeholderIcon: 'time',
                        isDropdown: true,
                        isDisabled:
                            editData?.type === 'edit' &&
                            fuelTransactionType?.name !== 'Manual',
                        customClass: 'datetimeclass'
                    }"
                ></app-ta-input>
            </div>
        </div>
        <div class="row last-row">
            <div class="col-12">
                <div
                    *ngIf="selectedFuelStop"
                    class="selected-item-container"
                    [ngClass]="{
                        'non-editable':
                            editData?.type === 'edit' &&
                            fuelTransactionType?.name !== 'Manual'
                    }"
                >
                    <div class="selected-item-label">
                        Fuel Stop <span>*</span>
                    </div>
                    <p class="selected-item-name">
                        {{ selectedFuelStop?.businessName }}
                        {{
                            selectedFuelStop?.name &&
                            selectedFuelStop.fuelStopFranchise
                                ? '#'.concat(' ', selectedFuelStop?.name)
                                : ''
                        }}
                    </p>
                    <div class="selected-item-additional">
                        <div
                            *ngIf="selectedFuelStop?.address"
                            class="selected-item-info"
                        >
                            <svg-icon
                                src="assets/svg/common/ic_address.svg"
                            ></svg-icon>
                            <p>
                                {{ selectedFuelStop?.fullAddress }}
                            </p>
                        </div>
                    </div>
                    <div
                        *ngIf="
                            editData?.type !== 'edit' ||
                            fuelTransactionType?.name === 'Manual'
                        "
                        class="clear-selected-item"
                    >
                        <div
                            ngbTooltip
                            mainTooltip="Clear"
                            tooltipBackground="#6c6c6c"
                            position="top"
                            class="clear-x"
                            (click)="
                                selectedFuelStop = null;
                                fuelForm.get('fuelStopStoreId').patchValue(null)
                            "
                        >
                            <svg-icon src="assets/svg/ic_x.svg"></svg-icon>
                        </div>
                    </div>
                </div>
                <app-ta-input-dropdown
                    *ngIf="!selectedFuelStop"
                    formControlName="fuelStopStoreId"
                    [template]="'fuel-franchise'"
                    [inputConfig]="{
                        name: 'Input Dropdown',
                        type: 'text',
                        label: 'Fuel Stop',
                        isRequired: true,
                        isDropdown: true,
                        dropdownWidthClass: 'w-col-456'
                    }"
                    [options]="fuelStops"
                    [activeItem]="selectedFuelStop"
                    (pagination)="paginationFuelStopPage($event)"
                    (activeGroup)="getFuelStoresByFranchiseId($event)"
                    (selectedItem)="onSelectDropDown($event, 'fuel')"
                ></app-ta-input-dropdown>
            </div>
        </div>

        <!-- Fake Table Card -->
        <app-ta-custom-card
            [hasCounter]="fuelItems.length ? fuelItems.length : 0"
            [cardName]="'Item'"
            [headerSvgEnabled]="true"
            [hasActionSvg]="
                editData?.type !== 'edit' ||
                fuelTransactionType?.name === 'Manual'
                    ? 'assets/svg/common/ic_plus.svg'
                    : null
            "
            [isCommentData]="true"
            [isCardOpen]="fuelItems.length > 0"
            [hasBodyData]="fuelItems.length > 0"
            [hasScrollBody]="fuelItems.length > 10"
            [actionText]="'ADD NEW ITEM'"
            [disabledCard]="!fuelItems.length"
            [disableAnimation]="disableCardAnimation"
            (onActionEvent)="addFuelItems($event)"
        >
            <div
                formArrayName="fuelItems"
                class="common-fake-table-modal common-fake-table-modal-fuel-transaction"
                *ngIf="fuelItems.length"
            >
                <div class="common-fake-table-label">
                    <p>#</p>
                    <p>ITEM <span>*</span></p>
                    <p>QTY</p>
                    <p>PRICE</p>
                    <p>SUBTOTAL</p>
                </div>
                <div class="common-fake-table-body">
                    <div
                        *ngFor="
                            let fuelItem of fuelItems.controls;
                            let ind = index
                        "
                    >
                        <div
                            [formGroupName]="ind"
                            class="common-fake-table-card"
                        >
                            <p>
                                {{ fuelItem.get('reorderingNumber').value }}
                            </p>

                            <app-ta-input-dropdown
                                formControlName="itemId"
                                [inputConfig]="{
                                    name: 'Input Dropdown',
                                    type: 'text',
                                    isDropdown: true,
                                    dropdownWidthClass: 'w-col-114',
                                    hideErrorMessage: true,
                                    blackInput: true,
                                    hideRequiredCheck: true,
                                    isDisabled:
                                        editData?.type === 'edit' &&
                                        fuelTransactionType?.name !== 'Manual'
                                }"
                                [options]="fuelItemsDropdown"
                                [activeItem]="selectedFuelItemDropFArray[ind]"
                                (selectedItem)="
                                    onSelectDropDown($event, 'fuel-items', ind)
                                "
                            ></app-ta-input-dropdown>

                            <app-ta-input
                                formControlName="qty"
                                [inputConfig]="{
                                    name: 'QTY',
                                    type: 'text',
                                    hideErrorMessage: true,
                                    blackInput: true,
                                    hideRequiredCheck: true,
                                    isDisabled:
                                        editData?.type === 'edit' &&
                                        fuelTransactionType?.name !== 'Manual'
                                }"
                                (change)="onChange('qty', ind)"
                            ></app-ta-input>
                            <div class="fuel-item-price-container">
                                <span
                                    *ngIf="
                                        fuelItem.get('price').value &&
                                        bluringFuelItemsPrice[index]
                                    "
                                    class="fuel-item-price-dollar"
                                >
                                    $
                                </span>

                                <app-ta-input
                                    formControlName="price"
                                    [inputConfig]="{
                                        name: 'Price',
                                        type: 'text',
                                        minLength: 4,
                                        maxLength: 11,
                                        blackInput: true,
                                        hideClear:
                                            !bluringFuelItemsPrice[index],
                                        hideErrorMessage: true,
                                        thousandSeparator: true,
                                        hideRequiredCheck: true,
                                        isDisabled:
                                            editData?.type === 'edit' &&
                                            fuelTransactionType?.name !==
                                                'Manual'
                                    }"
                                    (blurInput)="
                                        bluringFuelItemsPrice[index] = true
                                    "
                                    (focusInput)="
                                        bluringFuelItemsPrice[index] = false
                                    "
                                    (change)="onChange('price', ind)"
                                ></app-ta-input>
                            </div>

                            <p class="fuel-subtotal">
                                {{ subtotal[ind]?.value | currency }}
                            </p>
                            <div
                                *ngIf="
                                    editData?.type !== 'edit' ||
                                    fuelTransactionType?.name === 'Manual'
                                "
                                ngbTooltip
                                mainTooltip="Delete"
                                position="top"
                                tooltipBackground="#EF5350"
                                class="common-fake-table-delete"
                                (click)="removeFuelItems(ind)"
                            >
                                <svg-icon
                                    src="assets/svg/common/ic_trash.svg"
                                ></svg-icon>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row row-no-mb fuel-total-row">
                <p class="fuel-total">
                    <span class="fuel-total-text">TOTAL</span>
                    {{ subtotal | sumArrays | currency }}
                </p>
            </div>
        </app-ta-custom-card>

        <div class="ta-card-body-overflow-none">
            <app-ta-custom-card
                [hasCounter]="documents.length ? documents.length : 0"
                [cardName]="'Document'"
                [disableAnimation]="disableCardAnimation"
                [isCardOpen]="documents.length > 0"
            >
                <app-ta-upload-files
                    [files]="documents"
                    [showDropzone]="true"
                    (onFileEvent)="onFilesEvent($event)"
                    [customClassName]="'modals'"
                ></app-ta-upload-files>
            </app-ta-custom-card>
        </div>
    </form>
</app-ta-modal>
