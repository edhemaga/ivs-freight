<app-ta-modal
    [modalTitle]="
        !editData?.type?.includes('edit') ? 'Create Load' : 'Edit Load'
    "
    [editData]="editData"
    [editName]="loadNumber"
    [specificCaseModalName]="true"
    [isModalValid]="loadForm.valid && isFormDirty"
    [customClass]="loadModalSize"
    [partClass]="'load-modal-origin-part'"
    [isVisibleHazardous]="isHazardousPicked"
    [isVisibleMap]="true"
    [loadModalTemplate]="true"
    [modalAdditionalPart]="true"
    (additionalPartVisibility)="additionalPartVisibility($event)"
    (action)="onModalAction($event)"
>
    <!-- Origin Tab -->

    <form
        origin
        #originElement
        [formGroup]="loadForm"
        class="form-container form-container-without-mb"
    >
        <div class="m-tab">
            <div class="load-ftl-first-row">
                <!-- FTL-LTL Switcher -->

                <app-ta-tab-switch
                    [tabs]="tabs"
                    (switchClicked)="onTabChange($event, 'ftl-ltl')"
                    [type]="'type2-modal-popup'"
                >
                </app-ta-tab-switch>

                <!-- Load Template Picker -->

                <button
                    class="d-flex justify-content-center align-items-center load-template-switcher"
                    #popover="ngbPopover"
                    autoClose="outside"
                    [ngbPopover]="dropdownPopover"
                    popoverClass="popover-main"
                    placement="bottom-start"
                    container="body"
                >
                    <svg-icon
                        src="assets/svg/common/load/ic_load_template_btn.svg"
                    ></svg-icon>
                </button>

                <ng-template #dropdownPopover>
                    <div
                        class="popover-container load-template-switcher-popover-container"
                    >
                        <div class="popover-item">
                            <p class="m-0">Walmart Monthly Route</p>
                        </div>

                        <div class="popover-item">
                            <p class="m-0">Walmart Monthly Route</p>
                        </div>

                        <div class="popover-item">
                            <p class="m-0">Walmart Monthly Route</p>
                        </div>
                    </div>
                </ng-template>

                <!-- Dispatcher -->

                <app-ta-input-dropdown
                    formControlName="dispatcherId"
                    [template]="'load-dispatcher'"
                    [inputConfig]="{
                        name: 'Input Dropdown',
                        type: 'text',
                        label: 'Dispatcher',
                        isDropdown: true,
                        dropdownImageInput: {
                            withText: true,
                            svg: false,
                            image: true,
                            url: selectedDispatcher?.logoName,
                            nameInitialsInsteadUrl:
                                !selectedDispatcher?.logoName
                                    ? selectedDispatcher?.name
                                    : null,
                            template: 'user'
                        },
                        textTransform: 'capitalize',
                        dropdownWidthClass: 'w-col-230'
                    }"
                    [options]="labelsDispatcher"
                    [activeItem]="selectedDispatcher"
                    (selectedItem)="onSelectDropdown($event, 'dispatcher')"
                ></app-ta-input-dropdown>

                <!------------------ Companies Cassses ------------------>

                <!-- Only One Company -->

                <app-ta-input
                    *ngIf="labelsCompanies.length <= 1"
                    formControlName="companyId"
                    [inputConfig]="{
                        name: 'Company',
                        type: 'text',
                        label: 'Company',
                        isDisabled: true,
                        isRequired: true,
                        textTransform: 'uppercase'
                    }"
                ></app-ta-input>

                <!-- Multiple Companies -->

                <app-ta-input-dropdown
                    *ngIf="labelsCompanies.length > 1"
                    formControlName="companyId"
                    [inputConfig]="{
                        name: 'Input Dropdown',
                        type: 'text',
                        label: 'Company',
                        isDropdown: true,
                        dropdownWidthClass: 'w-col-226'
                    }"
                    [options]="labelsCompanies"
                    [activeItem]="selectedCompany"
                    (selectedItem)="onSelectDropdown($event, 'company')"
                ></app-ta-input-dropdown>
            </div>

            <!-- Broker -->

            <div class="load-ftl-second-row">
                <app-ta-input-dropdown
                    formControlName="brokerId"
                    [template]="'svgtext-template'"
                    [inputConfig]="{
                        name: 'Input Dropdown',
                        type: 'text',
                        label: 'Broker',
                        isDropdown: true,
                        isRequired: true,
                        blackInput: true,
                        textTransform: 'capitalize',
                        dropdownWidthClass: 'w-col-320'
                    }"
                    [canAddNew]="true"
                    [canOpenModal]="true"
                    [options]="labelsBroker"
                    [activeItem]="selectedBroker"
                    (selectedItem)="onSelectDropdown($event, 'broker')"
                ></app-ta-input-dropdown>

                <app-ta-input-dropdown
                    formControlName="brokerContactId"
                    [template]="'load-broker-contact'"
                    [inputConfig]="loadBrokerContactsInputConfig"
                    [canAddNew]="true"
                    [canOpenModal]="true"
                    [options]="labelsBrokerContacts"
                    [activeItem]="selectedBrokerContact"
                    (selectedItem)="onSelectDropdown($event, 'broker-contact')"
                ></app-ta-input-dropdown>
            </div>

            <div class="load-ftl-third-row">
                <app-ta-input
                    formControlName="referenceNumber"
                    [inputConfig]="{
                        name: 'Ref Number',
                        type: 'text',
                        label: 'Reference No.',
                        isRequired: true,
                        textTransform: 'uppercase'
                    }"
                ></app-ta-input>

                <app-ta-input-dropdown
                    formControlName="generalCommodity"
                    [template]="'svgtext-template'"
                    [inputConfig]="{
                        name: 'Input Dropdown',
                        type: 'text',
                        label: 'General Commodity',
                        isDropdown: true,
                        dropdownWidthClass: 'w-col-200',
                        blackInput: true,
                        customClass: 'hazardous-dropdown'
                    }"
                    [options]="labelsGeneralCommodity"
                    [activeItem]="selectedGeneralCommodity"
                    (selectedItem)="
                        onSelectDropdown($event, 'general-commodity')
                    "
                ></app-ta-input-dropdown>

                <app-ta-input
                    formControlName="weight"
                    [inputConfig]="{
                        name: 'Weight',
                        type: 'text',
                        label: 'Weight',
                        placeholderIcon: 'weight',
                        thousandSeparator: true
                    }"
                ></app-ta-input>
            </div>

            <div class="load-ftl-fourth-row">
                <app-ta-input-dropdown
                    formControlName="dispatchId"
                    [template]="'load-dispatches-ttd'"
                    [inputConfig]="loadDispatchesTTDInputConfig"
                    [options]="labelsDispatches"
                    [activeItem]="selectedDispatches"
                    (selectedItem)="onSelectDropdown($event, 'dispatches')"
                ></app-ta-input-dropdown>
            </div>

            <!-- Requirement -->

            <div
                class="d-flex flex-column justify-content-center requirement-container"
            >
                <div
                    class="d-flex align-items-center requirement-container-header"
                >
                    <p class="m-0 ta-font-extra-bold">Requirement</p>
                </div>

                <div class="load-requirements-load-first-row">
                    <app-ta-input-dropdown
                        formControlName="truckTypeId"
                        [template]="'svgtext-template'"
                        [inputConfig]="{
                            name: 'Input Dropdown',
                            type: 'text',
                            label: 'Truck Requirement',
                            isDropdown: true,
                            dropdownImageInput: {
                                withText: true,
                                svg: true,
                                image: false,
                                url: selectedTruckReq?.logoName,
                                template: 'truck',
                                class: selectedTruckReq?.name
                                    ?.trim()
                                    .replace(' ', '')
                                    .toLowerCase()
                            },
                            dropdownWidthClass: 'w-col-302',
                            customClass: 'truck-trailer-dropdown'
                        }"
                        [options]="labelsTruckReq"
                        [activeItem]="selectedTruckReq"
                        (selectedItem)="onSelectDropdown($event, 'truck-req')"
                    ></app-ta-input-dropdown>

                    <app-ta-input-dropdown
                        formControlName="trailerTypeId"
                        [template]="'svgtext-template'"
                        [inputConfig]="{
                            name: 'Input Dropdown',
                            type: 'text',
                            label: 'Trailer Requirement',
                            isDropdown: true,
                            dropdownImageInput: {
                                withText: true,
                                svg: true,
                                image: false,
                                url: selectedTrailerReq?.logoName,
                                template: 'trailer',
                                class: ['Tanker', 'Tanker Pneumatic'].includes(
                                    selectedTrailerReq?.name
                                )
                                    ? 'tanker'
                                    : selectedTrailerReq?.name
                                          ?.toLowerCase()
                                          ?.includes('rgn')
                                    ? 'low-boy-rgn'
                                    : selectedTrailerReq?.name
                                          ?.trim()
                                          .replace(' ', '')
                                          .toLowerCase()
                            },
                            dropdownWidthClass: 'w-col-302',
                            customClass: 'truck-trailer-dropdown'
                        }"
                        [options]="labelsTrailerReq"
                        [activeItem]="selectedTrailerReq"
                        (selectedItem)="onSelectDropdown($event, 'trailer-req')"
                    ></app-ta-input-dropdown>
                </div>

                <div class="load-requirements-load-second-row">
                    <app-ta-input-dropdown
                        formControlName="trailerLengthId"
                        [inputConfig]="{
                            name: 'Input Dropdown',
                            type: 'text',
                            label: 'Length',
                            isDropdown: true,
                            dropdownWidthClass: 'w-col-100'
                        }"
                        [options]="labelsTrailerLength"
                        [activeItem]="selectedTrailerLength"
                        (selectedItem)="onSelectDropdown($event, 'length')"
                    ></app-ta-input-dropdown>

                    <app-ta-input-dropdown
                        formControlName="doorType"
                        [inputConfig]="{
                            name: 'Input Dropdown',
                            type: 'text',
                            label: 'Door Type',
                            isDropdown: true,
                            dropdownWidthClass: 'w-col-120'
                        }"
                        [options]="labelsDoorType"
                        [activeItem]="selectedDoorType"
                        (selectedItem)="onSelectDropdown($event, 'door-type')"
                    ></app-ta-input-dropdown>

                    <app-ta-input-dropdown
                        formControlName="suspension"
                        [inputConfig]="{
                            name: 'Input Dropdown',
                            type: 'text',
                            label: 'Suspension',
                            isDropdown: true,
                            dropdownWidthClass: 'w-col-150'
                        }"
                        [options]="labelsSuspension"
                        [activeItem]="selectedSuspension"
                        (selectedItem)="onSelectDropdown($event, 'suspension')"
                    ></app-ta-input-dropdown>

                    <app-ta-input-dropdown
                        formControlName="year"
                        [inputConfig]="{
                            name: 'Input Dropdown',
                            type: 'text',
                            label: 'Year',
                            isDropdown: true,
                            dropdownWidthClass: 'w-col-90'
                        }"
                        [options]="labelsYear"
                        [activeItem]="selectedYear"
                        (selectedItem)="onSelectDropdown($event, 'year')"
                    ></app-ta-input-dropdown>

                    <div class="d-flex align-items-center justify-content-end">
                        <app-ta-checkbox
                            formControlName="liftgate"
                            [customClass]="'medium'"
                            [label]="'Lifgate'"
                        ></app-ta-checkbox>
                    </div>
                </div>
            </div>

            <!-- Driver Message -->

            <div class="d-flex align-items-center load-driver-message-row">
                <app-ta-custom-card
                    [cardName]="'Driver Message'"
                    [isCardOpen]="false"
                    [hasFormatTextActionButtons]="true"
                >
                    <textarea
                        formControlName="driverMessage"
                        type="text"
                        spellcheck="false"
                        placeholder="Type something..."
                        autofocus
                        rows="3"
                    ></textarea>
                </app-ta-custom-card>
            </div>

            <!-- Stops -->

            <app-ta-custom-card
                [cardName]="'Stops'"
                [capsulaText]="
                    loadExtraStops().length
                        ? loadExtraStops().length + ' ' + 'EXTRA'
                        : null
                "
                [isCardOpen]="true"
                [hasCounter]="2"
                [hasActionSvg]="
                    selectedPickupShipper
                        ? 'assets/svg/common/ic_plus.svg'
                        : null
                "
                [isCardOpen]="true"
                [hasBodyData]="true"
                [disableAnimation]="disableCardAnimation"
                [animationMarginParams]="{
                    marginTop: '10px',
                    marginBottom: '12px'
                }"
                (onActionEvent)="createNewExtraStop()"
            >
                <!-- Stops Header -->

                <div class="stops-header-bar">
                    <p>#</p>
                    <p>SHIPPER, LOCATION</p>
                    <p>DATE & TIME</p>
                    <p>DETAILS</p>
                </div>

                <!-- Pickup Stop  -->
                <app-load-stop
                    [firstOrLast]="true"
                    [stopNumber]="loadForm.get('pickupStopOrder').value"
                    [isDelivery]="false"
                    [shipper]="selectedPickupShipper?.name"
                    [shipperAddress]="selectedPickupShipper?.address"
                    [dateRange]="
                        loadForm.get('pickupDateFrom').value
                            | loadDatetimeRange
                                : loadForm.get('pickupDateTo').value
                    "
                    [timeRange]="
                        loadForm.get('pickupTimeFrom').value
                            | loadTimeType
                            | loadDatetimeRange
                                : (loadForm.get('pickupTimeTo').value
                                      | loadTimeType)
                    "
                    [legMile]="loadForm.get('pickuplegMiles').value"
                    [isEmptyLoad]="true"
                    [shipperContact]="{
                        fullName: selectedPickupShipperContact?.name
                    }"
                    [state]="
                        loadForm.get('pickupShipper').valid &&
                        loadForm.get('pickupDateFrom').valid &&
                        loadForm.get('pickupTimeFrom').valid &&
                        (selectedStopTimePickup === 6
                            ? !loadForm.get('pickupTimeTo').errors
                            : loadForm.get('pickupTimeTo').valid)
                            ? 'valid'
                            : (loadForm.get('pickupShipper').errors &&
                                  loadForm.get('pickupShipper').touched) ||
                              (loadForm.get('pickupDateFrom').errors &&
                                  loadForm.get('pickupDateFrom').touched) ||
                              (loadForm.get('pickupDateTo').errors &&
                                  loadForm.get('pickupDateTo').touched) ||
                              (loadForm.get('pickupTimeFrom').errors &&
                                  loadForm.get('pickupTimeFrom').touched) ||
                              (loadForm.get('pickupTimeTo').errors &&
                                  loadForm.get('pickupTimeTo').touched)
                            ? 'invalid'
                            : null
                    "
                    [isCardOpen]="isActivePickupStop"
                    (toggle)="toggleStopActivity($event, 'first-pickup')"
                >
                    <div class="row row-no-mt">
                        <div class="col-12">
                            <app-ta-input-dropdown
                                formControlName="pickupShipper"
                                [template]="'load-shipper'"
                                [inputConfig]="loadPickupShipperInputConfig"
                                [canAddNew]="true"
                                [canOpenModal]="true"
                                [options]="labelsShippers"
                                [activeItem]="selectedPickupShipper"
                                (selectedItem)="
                                    onSelectDropdown($event, 'shipper-pickup')
                                "
                                (closeDropdown)="
                                    loadForm
                                        .get('pickupShipper')
                                        .markAsTouched()
                                "
                            ></app-ta-input-dropdown>
                        </div>
                    </div>
                    <div class="load-shipper-contact-row">
                        <app-ta-tab-switch
                            [tabs]="stopTimeTabsPickup"
                            (switchClicked)="
                                onTabChange($event, 'stop-time-pickup')
                            "
                            [type]="'type2-modal-popup'"
                        ></app-ta-tab-switch>

                        <app-ta-input-dropdown
                            formControlName="pickupShipperContactId"
                            [template]="'load-broker-contact'"
                            [inputConfig]="loadPickupShipperContactsInputConfig"
                            [canAddNew]="true"
                            [canOpenModal]="true"
                            [options]="labelsShipperContacts"
                            [activeItem]="selectedPickupShipperContact"
                            (selectedItem)="
                                onSelectDropdown(
                                    $event,
                                    'shipper-contact-pickup'
                                )
                            "
                        ></app-ta-input-dropdown>
                    </div>
                    <div
                        class="stop-load-date-time"
                        [ngClass]="{ 'date-range-active': pickupDateRange }"
                    >
                        <app-ta-input
                            formControlName="pickupDateFrom"
                            [inputConfig]="{
                                name: 'datepicker',
                                type: 'text',
                                isDropdown: true,
                                label: pickupDateRange ? 'Date From' : 'Date',
                                placeholderIcon: 'date',
                                isRequired: true,
                                customClass: 'datetimeclass'
                            }"
                            (blurInput)="
                                loadForm.get('pickupDateFrom').markAsTouched()
                            "
                        ></app-ta-input>
                        <div
                            *ngIf="!pickupDateRange"
                            class="load-plus-button"
                            ngbTooltip
                            mainTooltip="Date Range"
                            tooltipBackground="#B7B7B7"
                            position="top"
                            (click)="pickupDateRange = true"
                        >
                            <svg-icon
                                src="assets/svg/common/ic_plus.svg"
                            ></svg-icon>
                        </div>
                        <app-ta-input
                            *ngIf="pickupDateRange"
                            formControlName="pickupDateTo"
                            [inputConfig]="{
                                name: 'datepicker',
                                type: 'text',
                                isDropdown: true,
                                label: 'Date To',
                                placeholderIcon: 'date',
                                customClass: 'datetimeclass'
                            }"
                            (blurInput)="
                                loadForm.get('pickupDateTo').markAsTouched()
                            "
                        ></app-ta-input>

                        <!-- Time Picker -->
                        <app-ta-input
                            formControlName="pickupTimeFrom"
                            [inputConfig]="{
                                name: 'timepicker',
                                type: 'text',
                                label:
                                    selectedStopTimePickup === 8
                                        ? 'At'
                                        : 'From',
                                placeholderIcon: 'time',
                                isDropdown: true,
                                isRequired: true,
                                isFromDate: true,
                                customClass: 'datetimeclass'
                            }"
                            (blurInput)="
                                loadForm.get('pickupTimeFrom').markAsTouched()
                            "
                        ></app-ta-input>

                        <!-- Time Picker -->
                        <app-ta-input
                            formControlName="pickupTimeTo"
                            [inputConfig]="{
                                name: 'timepicker',
                                type: 'text',
                                label: 'To',
                                placeholderIcon: 'time',
                                isDropdown: true,
                                isRequired: true,
                                isDisabled: selectedStopTimePickup === 6,
                                customClass: 'datetimeclass'
                            }"
                            (blurInput)="
                                loadForm.get('pickupTimeTo').markAsTouched()
                            "
                        ></app-ta-input>
                    </div>
                    <div class="stop-items-wrapper">
                        <app-ta-custom-card
                            [cardName]="'Item'"
                            [isCardOpen]="false"
                            [hasCounter]="2"
                            [hasActionSvg]="'assets/svg/common/ic_plus.svg'"
                            [hasBodyData]="true"
                            [hasArrow]="true"
                            [bottomCollapseArrow]="true"
                            [disableAnimation]="disableCardAnimation"
                            [animationMarginParams]="{
                                marginTop: '10px',
                                marginBottom: '12px'
                            }"
                            (onActionEvent)="createNewRowInStopItems('pickup')"
                            (onOpenCard)="showTableModal($event, 'pickup')"
                        >
                            <app-table-modal
                                *ngIf="tableModalOpen === 'pickup'"
                                [columns]="modalColumns"
                                [viewData]="modalViewData"
                                [midSectionWidth]="341"
                                [formGroup]="testControl"
                                [modalScrollStyleOptions]="{
                                    horizontalScrollBarMarginTop: 4,
                                    horizontalScrollBarLeft: 0,
                                    horizontalScrollBarWidth: 606,
                                    additionalWidth: 265,
                                    modalScrollClassActive: true
                                }"
                            ></app-table-modal>
                        </app-ta-custom-card>
                    </div>
                </app-load-stop>

                <!-- Extra Stops -->
                <div formArrayName="extraStops">
                    <div
                        *ngFor="
                            let extraStop of loadExtraStops().controls;
                            let indx = index
                        "
                    >
                        <div [formGroupName]="indx">
                            <!-- Extra Stops -->
                            <app-load-stop
                                *ngIf="loadExtraStops().controls.length"
                                [firstOrLast]="false"
                                [stopNumber]="
                                    loadExtraStops().at(indx).get('stopOrder')
                                        .value
                                "
                                [isDelivery]="
                                    selectExtraStopType[indx]
                                        ?.toString()
                                        ?.startsWith('4')
                                        ? true
                                        : false
                                "
                                [shipper]="selectedExtraStopShipper[indx]?.name"
                                [shipperAddress]="
                                    selectedExtraStopShipper[indx]?.address
                                "
                                [dateRange]="
                                    loadExtraStops().at(indx).get('dateFrom')
                                        .value
                                        | loadDatetimeRange
                                            : loadExtraStops()
                                                  .at(indx)
                                                  .get('dateTo').value
                                "
                                [timeRange]="
                                    loadExtraStops().at(indx).get('timeFrom')
                                        .value
                                        | loadTimeType
                                        | loadDatetimeRange
                                            : (loadExtraStops()
                                                  .at(indx)
                                                  .get('timeTo').value
                                                  | loadTimeType)
                                "
                                [legMile]="
                                    loadExtraStops().at(indx).get('legMiles')
                                        .value
                                "
                                [isEmptyLoad]="false"
                                [shipperContact]="{
                                    fullName:
                                        selectedExtraStopShipperContact[indx]
                                            ?.name
                                }"
                                [isCardOpen]="
                                    loadExtraStops().at(indx).get('openClose')
                                        .value
                                "
                                [state]="
                                    loadExtraStops().at(indx).get('shipperId')
                                        .valid &&
                                    loadExtraStops().at(indx).get('dateFrom')
                                        .valid &&
                                    loadExtraStops().at(indx).get('timeFrom')
                                        .valid &&
                                    loadExtraStops().at(indx).get('timeTo')
                                        .valid
                                        ? 'valid'
                                        : (loadExtraStops()
                                              .at(indx)
                                              .get('shipperId').errors &&
                                              loadExtraStops()
                                                  .at(indx)
                                                  .get('shipperId').touched) ||
                                          (loadExtraStops()
                                              .at(indx)
                                              .get('dateFrom').errors &&
                                              loadExtraStops()
                                                  .at(indx)
                                                  .get('dateFrom').touched) ||
                                          (loadExtraStops()
                                              .at(indx)
                                              .get('dateTo').errors &&
                                              loadExtraStops()
                                                  .at(indx)
                                                  .get('dateTo').touched) ||
                                          (loadExtraStops()
                                              .at(indx)
                                              .get('timeFrom').errors &&
                                              loadExtraStops()
                                                  .at(indx)
                                                  .get('timeFrom').touched) ||
                                          (loadExtraStops()
                                              .at(indx)
                                              .get('timeTo').errors &&
                                              loadExtraStops()
                                                  .at(indx)
                                                  .get('timeTo').touched)
                                        ? 'invalid'
                                        : null
                                "
                                (delete)="removeLoadExtraStop(indx)"
                                (toggle)="
                                    toggleStopActivity(
                                        $event,
                                        'extra-stops',
                                        indx
                                    )
                                "
                            >
                                <!-- Tabs  -->
                                <div class="row">
                                    <div class="col-12">
                                        <app-ta-tab-switch
                                            [tabs]="typeOfExtraStops[indx]"
                                            (switchClicked)="
                                                onTabChange(
                                                    $event,
                                                    'stop-tab',
                                                    indx
                                                )
                                            "
                                            [type]="'type2-modal-popup'"
                                        ></app-ta-tab-switch>
                                    </div>
                                </div>
                                <!-- Stop Information -->
                                <div class="row">
                                    <div class="col-12">
                                        <app-ta-input-dropdown
                                            formControlName="shipperId"
                                            [template]="'load-shipper'"
                                            [inputConfig]="
                                                loadExtraStopsShipperInputConfig[
                                                    indx
                                                ]
                                            "
                                            [canAddNew]="true"
                                            [canOpenModal]="true"
                                            [options]="labelsShippers"
                                            [activeItem]="
                                                selectedExtraStopShipper[indx]
                                            "
                                            (selectedItem)="
                                                onSelectDropdown(
                                                    $event,
                                                    'shipper-extra-stops',
                                                    indx
                                                )
                                            "
                                            (closeDropdown)="
                                                loadExtraStops()
                                                    .at(indx)
                                                    .get('shipperId')
                                                    .markAsTouched()
                                            "
                                        ></app-ta-input-dropdown>
                                    </div>
                                </div>
                                <div class="load-shipper-contact-row">
                                    <app-ta-tab-switch
                                        [tabs]="stopTimeTabsExtraStops[indx]"
                                        (switchClicked)="
                                            onTabChange(
                                                $event,
                                                'extra-stops-time',
                                                indx
                                            )
                                        "
                                        [type]="'type2-modal-popup'"
                                    ></app-ta-tab-switch>

                                    <app-ta-input-dropdown
                                        formControlName="shipperContactId"
                                        [template]="'load-broker-contact'"
                                        [inputConfig]="
                                            loadExtraStopsShipperContactsInputConfig[
                                                indx
                                            ]
                                        "
                                        [canAddNew]="true"
                                        [canOpenModal]="true"
                                        [options]="labelsShipperContacts"
                                        [activeItem]="
                                            selectedExtraStopShipperContact[
                                                indx
                                            ]
                                        "
                                        (selectedItem)="
                                            onSelectDropdown(
                                                $event,
                                                'shipper-contact-extra-stops',
                                                indx
                                            )
                                        "
                                    ></app-ta-input-dropdown>
                                </div>
                                <div
                                    class="stop-load-date-time"
                                    [ngClass]="{
                                        'date-range-active':
                                            loadExtraStopsDateRange[indx]
                                    }"
                                >
                                    <app-ta-input
                                        formControlName="dateFrom"
                                        [inputConfig]="{
                                            name: 'datepicker',
                                            type: 'text',
                                            isDropdown: true,
                                            label: loadExtraStopsDateRange[indx]
                                                ? 'Date From'
                                                : 'Date',
                                            placeholderIcon: 'date',
                                            isRequired: true,
                                            customClass: 'datetimeclass'
                                        }"
                                        (blurInput)="
                                            loadExtraStops()
                                                .at(indx)
                                                .get('dateFrom')
                                                .markAsTouched()
                                        "
                                    ></app-ta-input>
                                    <div
                                        *ngIf="!loadExtraStopsDateRange[indx]"
                                        class="load-plus-button"
                                        ngbTooltip
                                        mainTooltip="Date Range"
                                        tooltipBackground="#B7B7B7"
                                        position="top"
                                        (click)="
                                            loadExtraStopsDateRange[indx] = true
                                        "
                                    >
                                        <svg-icon
                                            src="assets/svg/common/ic_plus.svg"
                                        ></svg-icon>
                                    </div>
                                    <app-ta-input
                                        *ngIf="loadExtraStopsDateRange[indx]"
                                        formControlName="dateTo"
                                        [inputConfig]="{
                                            name: 'datepicker',
                                            type: 'text',
                                            isDropdown: true,
                                            label: 'Date To',
                                            placeholderIcon: 'date',
                                            customClass: 'datetimeclass'
                                        }"
                                        (blurInput)="
                                            loadExtraStops()
                                                .at(indx)
                                                .get('dateTo')
                                                .markAsTouched()
                                        "
                                    ></app-ta-input>

                                    <!-- Time Picker -->
                                    <app-ta-input
                                        formControlName="timeFrom"
                                        [inputConfig]="{
                                            name: 'timepicker',
                                            type: 'text',
                                            label: selectedExtraStopTime[indx]
                                                ?.toString()
                                                ?.startsWith('9')
                                                ? 'At'
                                                : 'From',
                                            placeholderIcon: 'time',
                                            isFromDate: true,
                                            isDropdown: true,
                                            isRequired: true,
                                            customClass: 'datetimeclass'
                                        }"
                                        (blurInput)="
                                            loadExtraStops()
                                                .at(indx)
                                                .get('timeFrom')
                                                .markAsTouched()
                                        "
                                    ></app-ta-input>
                                    <!-- Time Picker -->
                                    <app-ta-input
                                        formControlName="timeTo"
                                        [inputConfig]="{
                                            name: 'timepicker',
                                            type: 'text',
                                            label: 'To',
                                            placeholderIcon: 'time',
                                            isDropdown: true,
                                            isRequired: true,
                                            isDisabled: selectedExtraStopTime[
                                                indx
                                            ]
                                                ?.toString()
                                                ?.startsWith('9'),
                                            customClass: 'datetimeclass'
                                        }"
                                        (blurInput)="
                                            loadExtraStops()
                                                .at(indx)
                                                .get('timeTo')
                                                .markAsTouched()
                                        "
                                    ></app-ta-input>
                                </div>
                                <div class="stop-items-wrapper">
                                    <app-ta-custom-card
                                        [cardName]="'Item'"
                                        [isCardOpen]="false"
                                        [hasCounter]="2"
                                        [hasActionSvg]="
                                            'assets/svg/common/ic_plus.svg'
                                        "
                                        [hasBodyData]="true"
                                        (onActionEvent)="
                                            createNewRowInStopItems(
                                                'delivery'.indx
                                            )
                                        "
                                        (onOpenCard)="
                                            showTableModal(
                                                $event,
                                                'delivery'.indx
                                            )
                                        "
                                        [disableAnimation]="
                                            disableCardAnimation
                                        "
                                        [animationMarginParams]="{
                                            marginTop: '10px',
                                            marginBottom: '12px'
                                        }"
                                    >
                                        <app-table-modal
                                            *ngIf="
                                                tableModalOpen ===
                                                'delivery'.indx
                                            "
                                            [columns]="modalColumns"
                                            [viewData]="modalViewData"
                                            [midSectionWidth]="341"
                                            [formGroup]="testControl"
                                            [modalScrollStyleOptions]="{
                                                horizontalScrollBarMarginTop: 4,
                                                horizontalScrollBarLeft: 0,
                                                horizontalScrollBarWidth: 606,
                                                additionalWidth: 265,
                                                modalScrollClassActive: true
                                            }"
                                        ></app-table-modal>
                                    </app-ta-custom-card>
                                </div>
                            </app-load-stop>
                        </div>
                    </div>
                </div>

                <!-- Delivery Stop -->
                <app-load-stop
                    [firstOrLast]="true"
                    [stopNumber]="loadForm.get('deliveryStopOrder').value"
                    [isDelivery]="true"
                    [shipper]="selectedDeliveryShipper?.name"
                    [shipperAddress]="selectedDeliveryShipper?.address"
                    [dateRange]="
                        loadForm.get('deliveryDateFrom').value
                            | loadDatetimeRange
                                : loadForm.get('deliveryDateTo').value
                    "
                    [timeRange]="
                        loadForm.get('deliveryTimeFrom').value
                            | loadTimeType
                            | loadDatetimeRange
                                : (loadForm.get('deliveryTimeTo').value
                                      | loadTimeType)
                    "
                    [legMile]="loadForm.get('deliverylegMiles').value"
                    [isEmptyLoad]="false"
                    [shipperContact]="{
                        fullName: selectedDeliveryShipperContact?.name
                    }"
                    [disabledCard]="!selectedPickupShipper"
                    [isCardOpen]="isActiveDeliveryStop"
                    [state]="
                        loadForm.get('deliveryShipper').valid &&
                        loadForm.get('deliveryDateFrom').valid &&
                        loadForm.get('deliveryTimeFrom').valid &&
                        (selectedStopTimeDelivery === 6
                            ? !loadForm.get('deliveryTimeTo').errors
                            : loadForm.get('deliveryTimeTo').valid)
                            ? 'valid'
                            : (loadForm.get('deliveryShipper').errors &&
                                  loadForm.get('deliveryShipper').touched) ||
                              (loadForm.get('deliveryDateFrom').errors &&
                                  loadForm.get('deliveryDateFrom').touched) ||
                              (loadForm.get('deliveryDateTo').errors &&
                                  loadForm.get('deliveryDateTo').touched) ||
                              (loadForm.get('deliveryTimeFrom').errors &&
                                  loadForm.get('deliveryTimeFrom').touched) ||
                              (loadForm.get('deliveryTimeTo').errors &&
                                  loadForm.get('deliveryTimeTo').touched)
                            ? 'invalid'
                            : null
                    "
                    (toggle)="toggleStopActivity($event, 'first-delivery')"
                >
                    <div class="row">
                        <div class="col-12">
                            <app-ta-input-dropdown
                                formControlName="deliveryShipper"
                                [template]="'load-shipper'"
                                [inputConfig]="loadDeliveryShipperInputConfig"
                                [canAddNew]="true"
                                [canOpenModal]="true"
                                [options]="labelsShippers"
                                [activeItem]="selectedDeliveryShipper"
                                (selectedItem)="
                                    onSelectDropdown($event, 'shipper-delivery')
                                "
                                (closeDropdown)="
                                    loadForm
                                        .get('deliveryShipper')
                                        .markAsTouched()
                                "
                            ></app-ta-input-dropdown>
                        </div>
                    </div>
                    <div class="load-shipper-contact-row">
                        <app-ta-tab-switch
                            [tabs]="stopTimeTabsDelivery"
                            (switchClicked)="
                                onTabChange($event, 'stop-time-delivery')
                            "
                            [type]="'type2-modal-popup'"
                        ></app-ta-tab-switch>

                        <app-ta-input-dropdown
                            formControlName="deliveryShipperContactId"
                            [template]="'load-broker-contact'"
                            [inputConfig]="
                                loadDeliveryShipperContactsInputConfig
                            "
                            [canAddNew]="true"
                            [canOpenModal]="true"
                            [options]="labelsShipperContacts"
                            [activeItem]="selectedDeliveryShipperContact"
                            (selectedItem)="
                                onSelectDropdown(
                                    $event,
                                    'shipper-contact-delivery'
                                )
                            "
                        ></app-ta-input-dropdown>
                    </div>
                    <div
                        class="stop-load-date-time"
                        [ngClass]="{ 'date-range-active': deliveryDateRange }"
                    >
                        <app-ta-input
                            formControlName="deliveryDateFrom"
                            [inputConfig]="{
                                name: 'datepicker',
                                type: 'text',
                                isDropdown: true,
                                label: deliveryDateRange ? 'Date From' : 'Date',
                                placeholderIcon: 'date',
                                isRequired: true,
                                customClass: 'datetimeclass'
                            }"
                            (blurInput)="
                                loadForm.get('deliveryDateFrom').markAsTouched()
                            "
                        ></app-ta-input>
                        <div
                            *ngIf="!deliveryDateRange"
                            class="load-plus-button"
                            ngbTooltip
                            mainTooltip="Date Range"
                            tooltipBackground="#B7B7B7"
                            position="top"
                            (click)="deliveryDateRange = true"
                        >
                            <svg-icon
                                src="assets/svg/common/ic_plus.svg"
                            ></svg-icon>
                        </div>
                        <app-ta-input
                            *ngIf="deliveryDateRange"
                            formControlName="deliveryDateTo"
                            [inputConfig]="{
                                name: 'datepicker',
                                type: 'text',
                                isDropdown: true,
                                label: 'Date To',
                                placeholderIcon: 'date',
                                customClass: 'datetimeclass'
                            }"
                            (blurInput)="
                                loadForm.get('deliveryDateTo').markAsTouched()
                            "
                        ></app-ta-input>

                        <!-- Time Picker -->
                        <app-ta-input
                            formControlName="deliveryTimeFrom"
                            [inputConfig]="{
                                name: 'timepicker',
                                type: 'text',
                                label:
                                    selectedStopTimeDelivery === 8
                                        ? 'At'
                                        : 'From',
                                placeholderIcon: 'time',
                                isDropdown: true,
                                isFromDate: true,
                                isRequired: true,
                                customClass: 'datetimeclass'
                            }"
                            (blurInput)="
                                loadForm.get('deliveryTimeFrom').markAsTouched()
                            "
                        ></app-ta-input>
                        <!-- Time Picker -->
                        <app-ta-input
                            formControlName="deliveryTimeTo"
                            [inputConfig]="{
                                name: 'timepicker',
                                type: 'text',
                                label: 'To',
                                placeholderIcon: 'time',
                                isDropdown: true,
                                isRequired: true,
                                isDisabled: selectedStopTimeDelivery === 8,
                                customClass: 'datetimeclass'
                            }"
                            (blurInput)="
                                loadForm.get('deliveryTimeTo').markAsTouched()
                            "
                        ></app-ta-input>
                    </div>
                    <div class="stop-items-wrapper">
                        <app-ta-custom-card
                            [cardName]="'Item'"
                            [isCardOpen]="false"
                            [hasCounter]="2"
                            [hasActionSvg]="'assets/svg/common/ic_plus.svg'"
                            [hasBodyData]="true"
                            [disableAnimation]="disableCardAnimation"
                            [animationMarginParams]="{
                                marginTop: '10px',
                                marginBottom: '12px'
                            }"
                            (onActionEvent)="
                                createNewRowInStopItems('delivery')
                            "
                            (onOpenCard)="showTableModal($event, 'delivery')"
                        >
                            <app-table-modal
                                *ngIf="tableModalOpen === 'delivery'"
                                [columns]="modalColumns"
                                [viewData]="modalViewData"
                                [midSectionWidth]="341"
                                [formGroup]="testControl"
                                [modalScrollStyleOptions]="{
                                    horizontalScrollBarMarginTop: 4,
                                    horizontalScrollBarLeft: 0,
                                    horizontalScrollBarWidth: 606,
                                    additionalWidth: 265,
                                    modalScrollClassActive: true
                                }"
                            ></app-table-modal>
                        </app-ta-custom-card>
                    </div>
                </app-load-stop>

                <!-- Stops Footer -->
                <div class="stops-footer-bar">
                    <div class="stops-footer-bar-left-side">
                        <p class="stops-footer-bar-text">LOADED MILES</p>
                        <span class="loaded-miles-value"
                            >{{
                                loadForm.get('loadMiles').value
                                    | number : '1.2-2'
                            }}
                            mi</span
                        >
                    </div>
                    <div class="stops-footer-bar-right-side">
                        <p class="stops-footer-bar-text">TOTAL MILES</p>
                        <span class="total-miles-value"
                            >{{
                                loadForm.get('totalMiles').value
                                    | number : '1.2-2'
                            }}
                            mi</span
                        >
                    </div>
                </div>
            </app-ta-custom-card>

            <app-load-financial
                [firstHeaderTitle]="'Billing'"
                [billing]="
                    loadModalBill | financialCalculation : 'billing' | currency
                "
                [disableBillAction]="
                    !loadForm.get('baseRate').value ||
                    !additionalBillingTypes?.length
                "
                [adjusted]="
                    loadForm.get('adjustedRate').value ||
                    loadForm.get('driverRate').value
                "
                [secondHeaderTitle]="'Payment'"
                [payment]="
                    loadModalPayment
                        | financialCalculation : 'payment'
                        | currency
                "
                [disablePaymentAction]="!loadForm.get('baseRate').value"
                [thirdHeaderTitle]="'Invoice Ageing'"
                [isCardOpen]="true"
                [disableAnimation]="disableCardAnimation"
                [animationMarginParams]="{
                    marginTop: '18px',
                    marginBottom: '22px'
                }"
                (action)="onFinancialAction($event)"
            >
                <div class="load-financial-container">
                    <!-- =============================== Billing =============================== -->
                    <div class="load-financial-billing">
                        <!-- Base Rate -->
                        <app-ta-input
                            formControlName="baseRate"
                            [inputConfig]="{
                                name: 'price-separator',
                                type: 'text',
                                label: 'Base Rate',
                                labelInInput: true,
                                isRequired: true,
                                priceSeparator: true,
                                priceSeparatorLimitation: 6,
                                placeholderIconRightSide: 'dollar',
                                placeholderIconColor: 'green',
                                inputCursorOnRightSide: true,
                                hideErrorMessage: true,
                                hideRequiredCheck: true
                            }"
                        ></app-ta-input>
                        <!-- Driver Rate -->
                        <app-ta-input
                            *ngIf="
                                selectedDispatches &&
                                selectedDispatches.payType === 'Flat Rate'
                            "
                            formControlName="driverRate"
                            [inputConfig]="{
                                name: 'price-separator',
                                type: 'text',
                                label: 'Driver Rate',
                                labelInInput: true,
                                isRequired: true,
                                priceSeparator: true,
                                priceSeparatorLimitation: 6,
                                placeholderIconRightSide: 'dollar',
                                placeholderIconColor: 'purple',
                                inputCursorOnRightSide: true,
                                hideErrorMessage: true,
                                hideRequiredCheck: true
                            }"
                        ></app-ta-input>
                        <!-- Adjusted Rate -->
                        <app-ta-input
                            *ngIf="
                                selectedDispatches &&
                                selectedDispatches.payType !== 'Flat Rate' &&
                                this.selectedAdditionalBillings[0]?.checked &&
                                this.selectedAdditionalBillings[0]?.id === 6
                            "
                            formControlName="adjustedRate"
                            [inputConfig]="{
                                name: 'price-separator',
                                type: 'text',
                                label: 'Adjusted',
                                labelInInput: true,
                                priceSeparator: true,
                                priceSeparatorLimitation: 6,
                                placeholderIconRightSide: 'dollar',
                                placeholderIconColor: 'purple',
                                inputCursorOnRightSide: true,
                                removeInput: true,
                                hideErrorMessage: true,
                                hideRequiredCheck: true,
                                hideDangerMark: true
                            }"
                            (clear)="removeAdditionalBilling('adjusted')"
                        ></app-ta-input>
                        <div formArrayName="additionalBillings">
                            <div
                                *ngFor="
                                    let additional of additionalBillings()
                                        .controls;
                                    let indx = index
                                "
                                [ngStyle]="{ 'margin-bottom': '4px' }"
                            >
                                <div [formGroupName]="indx">
                                    <app-ta-input
                                        formControlName="billingValue"
                                        [inputConfig]="{
                                            name: 'price-separator',
                                            type: 'text',
                                            label: additional.get('name').value,
                                            labelInInput: true,
                                            priceSeparator: true,
                                            priceSeparatorLimitation: 6,
                                            placeholderIconRightSide:
                                                'dollar-additional-load',
                                            placeholderIconColor: 'blue',
                                            inputCursorOnRightSide: true,
                                            removeInput: true,
                                            isRequired: true,
                                            hideErrorMessage: true,
                                            hideRequiredCheck: true,
                                            hideDangerMark: true
                                        }"
                                        (clear)="
                                            removeAdditionalBilling(
                                                'billing',
                                                indx
                                            )
                                        "
                                    ></app-ta-input>
                                </div>
                            </div>
                        </div>
                        <app-ta-input-dropdown
                            *ngIf="isVisibleBillDropdown"
                            formControlName="billingDropdown"
                            [inputConfig]="{
                                name: 'Input Dropdown',
                                type: 'text',
                                label: 'Additional',
                                isDropdown: true,
                                labelInInput: true,
                                autoFocus: true,
                                dropdownWidthClass: 'w-col-198',
                                readOnly: true
                            }"
                            [options]="additionalBillingTypes"
                            [activeItem]="null"
                            (selectedItem)="addAdditionalBilling($event)"
                        ></app-ta-input-dropdown>
                    </div>
                    <div class="load-financial-payment">
                        <app-ta-input
                            *ngIf="isVisiblePayment"
                            formControlName="advancePay"
                            [inputConfig]="{
                                name: 'price-separator',
                                type: 'text',
                                label: 'Advance',
                                labelInInput: true,
                                isRequired: true,
                                priceSeparator: true,
                                priceSeparatorLimitation: 6,
                                placeholderIconRightSide: 'dollar',
                                placeholderIconColor: 'purple',
                                inputCursorOnRightSide: true,
                                hideErrorMessage: true,
                                hideRequiredCheck: true,
                                hideDangerMark: true,
                                removeInput: true
                            }"
                            (clear)="removeAdditionalPayment()"
                        ></app-ta-input>
                    </div>
                    <div class="load-financial-invoice">
                        <app-ta-input
                            formControlName="invoiced"
                            [inputConfig]="{
                                name: 'datepicker',
                                type: 'text',
                                isDropdown: true,
                                label: 'Invoiced',
                                isDisabled: true,
                                placeholderIcon: 'date',
                                isRequired: true,
                                customClass: 'datetimeclass'
                            }"
                        ></app-ta-input>
                    </div>
                </div>
            </app-load-financial>

            <!-- Comments -->
            <app-ta-custom-card
                [hasCounter]="comments.length ? comments.length : 0"
                [cardName]="'Comment'"
                [isCardOpen]="comments.length > 0"
                [isCommentData]="true"
                [hasBodyData]="comments.length > 0"
                [hasScrollBody]="comments.length > 4"
                [disabledCard]="editData?.type !== 'edit'"
                [hasActionSvg]="
                    editData?.type === 'edit'
                        ? 'assets/svg/common/ic_plus.svg'
                        : ''
                "
                [disableAnimation]="disableCardAnimation"
                [animationMarginParams]="{
                    marginTop: '10px',
                    marginBottom: '12px'
                }"
                (onActionEvent)="createComment()"
            >
                <app-ta-user-review
                    *ngIf="comments.length"
                    [reviewData]="comments"
                    [isNewReview]="comments[0].isNewReview"
                    (changeReviewsEvent)="changeCommentsEvent($event)"
                ></app-ta-user-review>
            </app-ta-custom-card>

            <!-- Documents -->
            <app-ta-custom-card
                [hasCounter]="documents.length ? documents.length : 0"
                [cardName]="'Document'"
                [disableAnimation]="disableCardAnimation"
                [isCardOpen]="documents.length > 0"
            >
                <app-ta-upload-files
                    [files]="documents"
                    [size]="'medium'"
                    [showDropzone]="true"
                    (onFileEvent)="onFilesEvent($event)"
                    [customClassName]="'modals'"
                    [hasTagsDropdown]="true"
                    [tags]="tags"
                ></app-ta-upload-files>
            </app-ta-custom-card>

            <!-- Note -->
            <app-ta-input-note
                formControlName="note"
                [isVisibleNote]="
                    loadForm.get('note').value &&
                    loadForm.get('note').value != 'null'
                        ? loadForm.get('note').value
                        : false
                "
                [note]="
                    loadForm.get('note').value &&
                    loadForm.get('note').value != 'null'
                        ? loadForm.get('note').value
                        : ''
                "
            ></app-ta-input-note>
        </div>
    </form>

    <!-- Additional Tab Part -->

    <div
        additional
        class="load-map-container"
        [ngClass]="{
            'load-hazardous-container': isHazardousVisible
        }"
        [ngStyle]="{
            overflow: 'hidden',
            'owerflow-y': 'scroll',
            height: originHeight + 130 + 'px'
        }"
    >
        <!-- Hazardous -->
        <app-load-modal-hazardous
            *ngIf="isHazardousVisible"
        ></app-load-modal-hazardous>

        <!-- Map -->
        <app-maps
            *ngIf="!isHazardousVisible"
            [mapType]="'routing'"
            [routes]="loadStopRoutes"
            [ngStyle]="{ width: '100%', height: '100%' }"
        ></app-maps>
    </div>
</app-ta-modal>
