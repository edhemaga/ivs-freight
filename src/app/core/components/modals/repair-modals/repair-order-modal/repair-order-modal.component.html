<app-ta-modal
    (action)="onModalAction($event)"
    (onTabHeaderChange)="onModalHeaderTabChange($event)"
    [customClass]="'modal-container-L'"
    [disableDelete]="editData?.type?.includes('edit-fo')"
    [editData]="editData"
    [editName]="editData?.data?.textUnit"
    [isModalValid]="repairOrderForm.valid && isFormDirty"
    [modalTitle]="
        !editData?.type?.includes('edit')
            ? 'Add Repair'
            : editData?.type?.includes('fo')
            ? 'Finish Order'
            : 'Edit Repair'
    "
    [saveAndAddNew]="editData?.type !== 'edit'"
    [tabChangePosition]="'right'"
    [tabChange]="
        (editData?.type?.includes('edit') && selectedRepairType === 'Bill') ||
        editData?.type?.includes('edit-fo')
            ? null
            : headerTabs
    "
>
    <form
        [formGroup]="repairOrderForm"
        class="form-container form-container-without-mb"
        origin
    >
        <div class="repair-modal-bill-first-row">
            <app-ta-tab-switch
                (switchClicked)="onTypeOfRepair($event)"
                [tabs]="typeOfRepair"
                [type]="'type2-modal-popup'"
            ></app-ta-tab-switch>

            <app-ta-input-dropdown
                formControlName="unit"
                [inputConfig]="{
                    name: 'Input Dropdown vehicle-unit',
                    type: 'text',
                    label: 'Unit',
                    isDropdown: true,
                    isRequired: true,
                    textTransform: 'uppercase',
                    minLength: 1,
                    maxLength: 8,
                    dropdownWidthClass: 'w-col-119',
                    autoFocus:
                        !editData?.type?.includes('edit') &&
                        !editData?.storageData?.unit
                }"
                [options]="labelsUnit"
                [activeItem]="selectedUnit"
                [canAddNew]="true"
                [canOpenModal]="true"
                (selectedItem)="onSelectDropDown($event, 'repair-unit')"
            ></app-ta-input-dropdown>
            <app-ta-input
                [inputConfig]="{
                    name: 'repair-odometer',
                    type: 'text',
                    label: 'Odometer',
                    isRequired: selectedPM[selectedPMIndex]?.id,
                    isDisabled: selectedHeaderTab !== 2,
                    thousandSeparator: true,
                    minLength: 1,
                    maxLength: 9
                }"
                formControlName="odometer"
            ></app-ta-input>
            <app-ta-input
                [inputConfig]="{
                    name: 'datepicker',
                    type: 'text',
                    isDropdown: true,
                    label: 'Date',
                    placeholderIcon: 'date',
                    isRequired: true,
                    isDisabled: selectedHeaderTab !== 2,
                    customClass: 'datetimeclass'
                }"
                formControlName="date"
            ></app-ta-input>
            <app-ta-input
                [inputConfig]="{
                    name: 'Invoice',
                    type: 'text',
                    label: 'Invoice',
                    isDisabled: selectedHeaderTab !== 2,
                    textTransform: 'uppercase',
                    minLength: 1,
                    maxLength: 22
                }"
                formControlName="invoice"
            ></app-ta-input>
        </div>
        <div class="row last-row">
            <div class="col-12">
                <div *ngIf="selectedRepairShop" class="selected-item-container">
                    <div class="selected-item-label">
                        Repair Shop
                        <span *ngIf="selectedHeaderTab === 2">*</span>
                    </div>
                    <p class="selected-item-name">
                        {{ selectedRepairShop?.name }}
                        <svg-icon
                            [ngClass]="{ active: selectedRepairShop?.pinned }"
                            class="selected-item-star"
                            src="assets/svg/common/ic_star.svg"
                        ></svg-icon>
                    </p>
                    <div class="selected-item-additional">
                        <div
                            *ngIf="selectedRepairShop?.phone"
                            class="selected-item-info"
                        >
                            <svg-icon
                                src="assets/svg/common/ic_phone.svg"
                            ></svg-icon>
                            <p>
                                {{ selectedRepairShop?.phone | formatPhoneP }}
                            </p>
                        </div>

                        <div
                            *ngIf="selectedRepairShop?.email"
                            class="selected-item-info"
                        >
                            <svg-icon
                                src="assets/svg/common/ic_email.svg"
                            ></svg-icon>
                            <p>{{ selectedRepairShop?.email }}</p>
                        </div>

                        <div
                            *ngIf="selectedRepairShop?.address"
                            class="selected-item-info"
                        >
                            <svg-icon
                                src="assets/svg/common/ic_address.svg"
                            ></svg-icon>
                            <p>
                                {{ selectedRepairShop?.address }}
                            </p>
                        </div>
                    </div>
                    <div class="clear-selected-item">
                        <div
                            (click)="
                                selectedRepairShop = null;
                                repairOrderForm
                                    .get('repairShopId')
                                    .patchValue(null)
                            "
                            class="clear-x"
                            mainTooltip="Clear"
                            ngbTooltip
                            position="top"
                            tooltipBackground="#6c6c6c"
                        >
                            <svg-icon src="assets/svg/ic_x.svg"></svg-icon>
                        </div>
                    </div>
                </div>
                <app-ta-input-dropdown
                    (selectedItem)="onSelectDropDown($event, 'repair-shop')"
                    *ngIf="!selectedRepairShop"
                    [activeItem]="selectedRepairShop"
                    [canAddNew]="true"
                    [canOpenModal]="true"
                    [inputConfig]="{
                        name: 'Input Dropdown',
                        type: 'text',
                        label: 'Repair Shop',
                        isDropdown: true,
                        isRequired: selectedHeaderTab === 2,
                        dropdownWidthClass: 'w-col-686'
                    }"
                    [options]="labelsRepairShop"
                    formControlName="repairShopId"
                ></app-ta-input-dropdown>
            </div>
        </div>
        <!-- Fake Table Card -->
        <div [ngClass]="{ 'repair-order': selectedHeaderTab !== 2 }">
            <app-ta-custom-card
                (onActionEvent)="addItems($event)"
                [cardName]="'Item'"
                [disableAnimation]="disableCardAnimation"
                [disabledCard]="!items.length"
                [hasActionSvg]="'assets/svg/common/ic_plus.svg'"
                [hasArrow]="false"
                [hasBodyData]="items.length > 0"
                [hasCounter]="items.length ? items.length : 0"
                [hasScrollBody]="items.length > 10"
                [isCardOpen]="items.length > 0"
                [isCommentData]="true"
            >
                <div
                    *ngIf="items.length"
                    [ngClass]="
                        selectedHeaderTab === 2
                            ? 'common-fake-table-modal-repair-bill-item'
                            : 'common-fake-table-modal-repair-order-item'
                    "
                    class="common-fake-table-modal"
                    formArrayName="items"
                >
                    <div class="common-fake-table-label">
                        <p></p>
                        <p>
                            DESCRIPTION
                            <span *ngIf="headerTabs[1].checked">*</span>
                        </p>
                        <p>PM</p>
                        <p *ngIf="selectedHeaderTab === 2">
                            PRICE <span>*</span>
                        </p>
                        <p>QTY <span *ngIf="headerTabs[1].checked">*</span></p>
                        <p *ngIf="selectedHeaderTab === 2">SUBTOTAL</p>
                    </div>
                    <div class="common-fake-table-body">
                        <div
                            *ngFor="let item of items.controls; let ind = index"
                        >
                            <div
                                [formGroupName]="ind"
                                [ngClass]="{
                                    'card-item-active':
                                        selectedPM[ind]?.logoName &&
                                        selectedPM[ind]?.logoName !==
                                            'assets/svg/common/repair-pm/ic_custom_pm.svg'
                                }"
                                class="common-fake-table-card"
                            >
                                <p>
                                    {{ item.get('orderingId').value }}
                                </p>
                                <div class="desc-pm-container">
                                    <app-ta-input
                                        [inputConfig]="{
                                            id: 'Description' + ind,
                                            name: 'Description',
                                            type: 'text',
                                            minLength: 2,
                                            maxLength: 160,
                                            textTransform: 'capitalize',
                                            blueInputColor:
                                                selectedPM[ind]?.logoName &&
                                                !selectedPM[
                                                    ind
                                                ]?.logoName?.includes(
                                                    'ic_custom_pm'
                                                ),
                                            customClass: 'repair-m-pm',
                                            hideRequiredCheck: true,
                                            hideErrorMessage: true,
                                            blackInput: true
                                        }"
                                        formControlName="description"
                                        (blurInput)="onBlurDescription(ind)"
                                    ></app-ta-input>
                                    <!-- PMs -->
                                    <div
                                        #t2="ngbPopover"
                                        [container]="'body'"
                                        [ngbPopover]="pmDropdownPopover"
                                        [placement]="['bottom-right']"
                                        popoverClass="ta-dropdown-popover"
                                    >
                                        <svg-icon
                                            [class.active]="
                                                selectedPM.length
                                                    ? !selectedPM[
                                                          ind
                                                      ]?.logoName?.includes(
                                                          'ic_custom_pm'
                                                      ) &&
                                                      selectedPM[ind]?.logoName
                                                    : false
                                            "
                                            [src]="
                                                selectedPM[ind]?.logoName
                                                    ? selectedPM[ind]?.logoName
                                                    : 'assets/svg/common/repair-pm/ic_custom_pm.svg'
                                            "
                                            class="pm-svg"
                                        ></svg-icon>
                                    </div>

                                    <ng-template #pmDropdownPopover>
                                        <div
                                            *ngIf="pmOptions?.length"
                                            [ngClass]="{
                                                scroll: pmOptions?.length > 6
                                            }"
                                            class="options"
                                        >
                                            <div
                                                (click)="
                                                    onAction(pmOption, ind)
                                                "
                                                *ngFor="
                                                    let pmOption of pmOptions
                                                "
                                                [ngClass]="{
                                                    'add-option':
                                                        pmOption.title ===
                                                        'Add New'
                                                }"
                                                class="option"
                                            >
                                                <svg-icon
                                                    [src]="pmOption.logoName"
                                                    class="option-svg"
                                                ></svg-icon>
                                                <div class="option-text">
                                                    {{ pmOption.title }}
                                                </div>
                                            </div>
                                        </div>
                                    </ng-template>
                                    <!-- End -->
                                </div>

                                <app-ta-input
                                    (change)="onChange('price', ind)"
                                    *ngIf="selectedHeaderTab === 2"
                                    [inputConfig]="{
                                        id: 'Price' + ind,
                                        name: 'Price',
                                        type: 'text',
                                        priceSeparator: true,
                                        blueInputColor:
                                            selectedPM[ind]?.logoName &&
                                            !selectedPM[
                                                ind
                                            ]?.logoName?.includes(
                                                'ic_custom_pm'
                                            ),
                                        minLength: 4,
                                        maxLength: 13,
                                        hideRequiredCheck: true,
                                        hideErrorMessage: true,
                                        blackInput: true
                                    }"
                                    formControlName="price"
                                ></app-ta-input>

                                <app-ta-input
                                    (change)="onChange('quantity', ind)"
                                    [inputConfig]="{
                                        id: 'QTY' + ind,
                                        name: 'QTY',
                                        type: 'text',
                                        blueInputColor:
                                            selectedPM[ind]?.logoName &&
                                            !selectedPM[
                                                ind
                                            ]?.logoName?.includes(
                                                'ic_custom_pm'
                                            ),
                                        hideRequiredCheck: true,
                                        hideErrorMessage: true,
                                        blackInput: true
                                    }"
                                    formControlName="quantity"
                                ></app-ta-input>

                                <p
                                    *ngIf="selectedHeaderTab === 2"
                                    class="item-subtotal"
                                >
                                    {{ subtotal[ind].value | currency }}
                                </p>

                                <div
                                    (click)="removeItems(ind)"
                                    class="common-fake-table-delete"
                                    mainTooltip="Delete"
                                    ngbTooltip
                                    position="top"
                                    tooltipBackground="#EF5350"
                                >
                                    <svg-icon
                                        src="assets/svg/common/ic_trash.svg"
                                    ></svg-icon>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div *ngIf="selectedHeaderTab === 2" class="row item-total-row">
                    <p class="item-total">
                        <span class="item-total-text">TOTAL</span>
                        {{ subtotal | priceCalculationArray }}
                    </p>
                </div>
            </app-ta-custom-card>
        </div>

        <app-ta-custom-card
            [cardName]="'Service'"
            [disableAnimation]="disableCardAnimation"
            [hasCounter]="services | activeItems"
            [isCardOpen]="true"
        >
            <div class="repair-shop-services">
                <div
                    *ngFor="let repair of services; trackBy: identity"
                    (click)="activeRepairService(repair)"
                    [ngClass]="{ active: repair.active }"
                    class="repair-shop-service"
                >
                    <svg-icon src="{{ repair.svg }}"></svg-icon>
                    <p>{{ repair.serviceType }}</p>
                </div>
            </div>
        </app-ta-custom-card>
        <div *ngIf="selectedHeaderTab === 2" class="ta-card-body-overflow-none">
            <app-ta-custom-card
                [cardName]="'Documents'"
                [disableAnimation]="disableCardAnimation"
                [hasCounter]="documents.length ? documents.length : 0"
                [isCardOpen]="documents.length > 0"
            >
                <app-ta-upload-files
                    (onFileEvent)="onFilesEvent($event)"
                    [customClassName]="'modals'"
                    [files]="documents"
                    [showDropzone]="true"
                    [size]="'large'"
                ></app-ta-upload-files>
            </app-ta-custom-card>
        </div>
        <!-- Note -->
        <app-ta-input-note
            [isVisibleNote]="
                repairOrderForm.get('note').value &&
                repairOrderForm.get('note').value != 'null'
                    ? repairOrderForm.get('note').value
                    : false
            "
            [note]="
                repairOrderForm.get('note').value &&
                repairOrderForm.get('note').value != 'null'
                    ? repairOrderForm.get('note').value
                    : ''
            "
            formControlName="note"
        ></app-ta-input-note>
    </form>
</app-ta-modal>
