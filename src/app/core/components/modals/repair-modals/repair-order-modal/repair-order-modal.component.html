<app-ta-modal
  [modalTitle]="
    !editData?.type?.includes('edit') ? 'Add Repair' : 'Edit Repair'
  "
  [editData]="editData"
  [editName]="editData?.id"
  [isModalValid]="
    editData ? repairOrderForm.valid && isDirty : repairOrderForm.valid
  "
  [tabChange]="headerTabs"
  [customClass]="'modal-container-L'"
  (onTabHeaderChange)="onModalHeaderTabChange($event)"
  (modalActionTypeEmitter)="onModalAction($event)"
>
  <form [formGroup]="repairOrderForm" class="form-container">
    <div
      [ngClass]="
        selectedTab === 1
          ? 'repair-modal-bill-first-row'
          : 'repair-modal-order-first-row'
      "
    >
      <app-ta-input-radiobuttons
        [buttons]="typeOfRepair"
        (changedValue)="onTypeOfRepair($event)"
      ></app-ta-input-radiobuttons>
      <app-ta-input-dropdown
        formControlName="unit"
        [inputConfig]="{
          name: 'Input Dropdown',
          type: 'text',
          label: 'Unit',
          isDropdown: true,
          isRequired: true,
          dropdownWidthClass:
            selectedTab === 2
              ? 'w-col-repair-m-unit-order'
              : 'w-col-repair-m-unit-bill'
        }"
        [options]="labelsUnit"
        [activeItem]="selectedUnit"
        (selectedItem)="onSelectDropDown($event, 'repair-unit')"
      ></app-ta-input-dropdown>
      <app-ta-input
        formControlName="odometer"
        [inputConfig]="{
          name: 'Odometer',
          type: 'text',
          label: 'Odometer',
          isRequired: selectedPM[selectedPMIndex]?.id,
          thousandSeparator: true
        }"
      ></app-ta-input>
      <app-ta-input
        formControlName="date"
        [inputConfig]="{
          name: 'datepicker',
          type: 'text',
          isDropdown: true,
          label: 'Date',
          placeholderIcon: 'date',
          isRequired: true,
          customClass: 'datetimeclass'
        }"
      ></app-ta-input>
      <app-ta-input
        *ngIf="selectedTab === 1"
        formControlName="invoice"
        [inputConfig]="{
          name: 'Invoice',
          type: 'text',
          label: 'Invoice',
          textTransform: 'capitalize'
        }"
      ></app-ta-input>
    </div>
    <div class="row last-row">
      <div class="col-12">
        <div *ngIf="selectedRepairShop" class="selected-repair-shop">
          <div class="repair-shop-label">
            Repair Shop <span *ngIf="selectedTab === 1">*</span>
          </div>
          <p class="repair-shop-name">
            {{ selectedRepairShop?.name }}
            <svg-icon
              class="repair-shop-star"
              [ngClass]="{ active: selectedRepairShop?.pinned }"
              src="assets/svg/common/ic_star.svg"
            ></svg-icon>
          </p>
          <div class="repair-shop-additional">
            <div class="repair-shop-info">
              <svg-icon src="assets/svg/common/ic_phone.svg"></svg-icon>
              <p>{{ selectedRepairShop?.phone | formatPhoneP }}</p>
            </div>

            <div class="repair-shop-info">
              <svg-icon src="assets/svg/common/ic_email.svg"></svg-icon>
              <p>{{ selectedRepairShop?.email }}</p>
            </div>

            <div class="repair-shop-info">
              <svg-icon src="assets/svg/common/ic_address.svg"></svg-icon>
              <p>
                {{ selectedRepairShop?.address }}
              </p>
            </div>
          </div>
          <div class="clear-repair-shop">
            <svg-icon
              src="assets/svg/ic_x.svg"
              class="clear-x"
              (click)="
                selectedRepairShop = null;
                repairOrderForm.get('repairShopId').patchValue(null)
              "
            ></svg-icon>
          </div>
        </div>
        <app-ta-input-dropdown
          *ngIf="!selectedRepairShop"
          formControlName="repairShopId"
          [inputConfig]="{
            name: 'Input Dropdown',
            type: 'text',
            label: 'Repair Shop',
            isDropdown: true,
            isRequired: selectedTab === 1,
            dropdownWidthClass: 'w-col-repair-m-shop'
          }"
          [options]="labelsRepairShop"
          [activeItem]="selectedRepairShop"
          (selectedItem)="onSelectDropDown($event, 'repair-shop')"
        ></app-ta-input-dropdown>
      </div>
    </div>
    <!-- Fake Table Card -->
    <div [ngClass]="{ 'repair-order': selectedTab !== 1 }">
      <app-ta-custom-card
        [hasCounter]="items.length ? items.length : '0'"
        [cardName]="'Item'"
        [hasActionSvg]="'assets/svg/common/ic_plus.svg'"
        [hasArrow]="false"
        [isCommentData]="true"
        [isCardOpen]="items.length"
        [hasBodyData]="items.length"
        [hasScrollBody]="items.length > 10"
        (onActionEvent)="addItems($event)"
      >
        <div
          formArrayName="items"
          class="common-fake-table-modal"
          [ngClass]="
            selectedTab === 1
              ? 'common-fake-table-modal-repair-bill-item'
              : 'common-fake-table-modal-repair-order-item'
          "
          *ngIf="items.length"
        >
          <div class="common-fake-table-label">
            <p></p>
            <p>DESCRIPTION</p>
            <p>PM</p>
            <p *ngIf="selectedTab === 1">PRICE</p>
            <p>QTY</p>
            <p *ngIf="selectedTab === 1">SUBTOTAL</p>
          </div>
          <div *ngFor="let item of items.controls; let ind = index">
            <div
              [formGroupName]="ind"
              class="common-fake-table-card"
              [ngClass]="{
                'card-item-active':
                  !selectedPM[ind]?.logoName.includes('default_pm')
              }"
            >
              <p>
                {{ item.controls.id.value }}
              </p>
              <div class="desc-pm-container">
                <app-ta-input
                  formControlName="description"
                  [inputConfig]="{
                    name: 'Description',
                    type: 'text',
                    textTransform: 'capitalize',
                    hideRequiredCheck: true,
                    blueInputColor:
                      !selectedPM[ind]?.logoName?.includes('ic_custom_pm'),
                    customClass: 'repair-m-pm'
                  }"
                ></app-ta-input>
                <!-- PMs -->
                <div
                  #t2="ngbPopover"
                  [ngbPopover]="pmDropdownPopover"
                  [placement]="['bottom-right']"
                  popoverClass="ta-dropdown-popover"
                  [container]="'body'"
                >
                  <svg-icon
                    class="pm-svg"
                    [class.active]="
                      selectedPM
                        ? !selectedPM[ind]?.logoName?.includes('ic_custom_pm')
                        : false
                    "
                    [src]="selectedPM[ind]?.logoName"
                  ></svg-icon>
                </div>

                <ng-template #pmDropdownPopover>
                  <div
                    class="options"
                    [ngClass]="{ scroll: pmOptions.length > 6 }"
                  >
                    <div
                      *ngFor="let action of pmOptions"
                      class="option"
                      [ngClass]="{ 'add-option': action.title === 'Add New' }"
                      (click)="onAction(action, ind)"
                    >
                      <svg-icon
                        class="option-svg"
                        [src]="action.logoName"
                      ></svg-icon>
                      <div class="option-text">{{ action.title }}</div>
                    </div>
                  </div>
                </ng-template>
                <!-- End -->
              </div>

              <app-ta-input
                *ngIf="selectedTab === 1"
                formControlName="price"
                [inputConfig]="{
                  name: 'Price',
                  type: 'text',
                  textTransform: 'capitalize',
                  thousandSeparator: true,
                  hideRequiredCheck: true,
                  blueInputColor:
                    !selectedPM[ind]?.logoName?.includes('ic_custom_pm')
                }"
                (change)="onChange('price', ind)"
              ></app-ta-input>

              <app-ta-input
                formControlName="quantity"
                [inputConfig]="{
                  name: 'QTY',
                  type: 'text',
                  textTransform: 'capitalize',
                  hideRequiredCheck: true,
                  blueInputColor:
                    !selectedPM[ind]?.logoName?.includes('ic_custom_pm')
                }"
                (change)="onChange('quantity', ind)"
              ></app-ta-input>

              <p *ngIf="selectedTab === 1" class="item-subtotal">
                {{ subtotal[ind].value | currency }}
              </p>

              <div
                ngbTooltip
                mainTooltip="Delete"
                position="top"
                tooltipBackground="#EF5350"
                class="common-fake-table-delete"
                (click)="removeItems(ind, item.controls)"
              >
                <svg-icon src="assets/svg/common/ic_trash.svg"></svg-icon>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="selectedTab === 1" class="row item-total-row">
          <p class="item-total">
            <span class="item-total-text">TOTAL</span>
            {{ subtotal | sumArrays | currency }}
          </p>
        </div>
      </app-ta-custom-card>
    </div>

    <app-ta-custom-card
      [hasCounter]="pickedServices() ? pickedServices() : '0'"
      [cardName]="'Service'"
      [isCardOpen]="true"
    >
      <div class="repair-shop-services">
        <div
          *ngFor="let repair of services; trackBy: identity"
          class="repair-shop-service"
          [ngClass]="{ active: repair.active }"
          (click)="repair.active = !repair.active"
        >
          <svg-icon src="{{ repair.svg }}"></svg-icon>
          <p>{{ repair.serviceType }}</p>
        </div>
      </div>
    </app-ta-custom-card>
    <div *ngIf="selectedTab === 1" class="ta-card-body-overflow-none">
      <app-ta-custom-card
        [hasCounter]="documents.length ? documents.length : '0'"
        [cardName]="'Documents'"
        [isCardOpen]="documents.length"
      >
        <app-ta-modal-upload
          [files]="documents"
          [modalSize]="'modal-large'"
          (onFileEvent)="onFilesEvent($event)"
        ></app-ta-modal-upload>
      </app-ta-custom-card>
    </div>
    <!-- Note -->
    <app-ta-input-note
      formControlName="note"
      [isVisibleNote]="repairOrderForm.get('note').value"
    ></app-ta-input-note>
  </form>
</app-ta-modal>
