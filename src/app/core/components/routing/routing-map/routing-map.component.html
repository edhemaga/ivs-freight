<div class="table-container">
  <div class="table-toolbar-container toolbar-relative">
    <app-map-toolbar
      #mapToolbar
      (toolBarAction)="onToolBarAction($event)"
      [options]="tableOptions"
      [tableData]="tableData"
      [selectedTab]="selectedTab"
      [stopPickerActive]="stopPickerActive"
      [isTollRoadsActive]="isTollRoadsActive"
      [isTimeZoneActive]="isTimeZoneActive"
      [isDopplerOn]="isDopplerOn"
      [trafficLayerShow]="trafficLayerShow"
    ></app-map-toolbar>
  </div>

  <div class="customer-map-container">
    <div class="route-card-container">
      <div
        class="route-card-scroll"
        cdkDropList
        (cdkDropListDropped)="dropRoutes($event, routes)"
        [ngStyle]="{
          'padding-right': tooltip?.isOpen() ? '126px' : '13px',
          'padding-bottom': tooltip?.isOpen() ? '113px' : '13px'
        }"
      >
        <div
          class="route-info-card"
          cdkDrag
          *ngFor="let route of routes; let i = index"
          (click)="!route.hidden ? focusRoute(i) : showHideRoute($event, route)"
          (mouseenter)="hoverRoute(route)"
          (mouseleave)="leaveRouteHover(route)"
          [ngClass]="{
            'route-hidden': route.hidden,
            'expanded-card': route.expanded
          }"
          [ngStyle]="{
            width: route.width ? route.width : '312px',
            'padding-right': route.hover && !route.hidden ? '14px' : '4px'
          }"
        >
          <div class="route-info-header">
            <div class="header-content-container">
              <div
                cdkDragHandle
                class="route-card-svg"
                [tooltipBackground]="'#616161'"
                ngbTooltip
                [mainTooltip]="'Route Reorder'"
                position="right"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 18 18"
                  *ngIf="!route.hidden"
                >
                  <g
                    id="Drag"
                    transform="translate(-935.139 -1357)"
                    opacity="0.7"
                  >
                    <rect
                      id="Rectangle_63459"
                      data-name="Rectangle 63459"
                      width="18"
                      height="18"
                      rx="2"
                      transform="translate(935.139 1357)"
                      fill="#f27b8e"
                      opacity="0"
                    />
                    <path
                      id="grip-vertical"
                      d="M3,0H1A1,1,0,0,0,0,1V3A1,1,0,0,0,1,4H3A1,1,0,0,0,4,3V1A1,1,0,0,0,3,0ZM3,5H1A1,1,0,0,0,0,6V8A1,1,0,0,0,1,9H3A1,1,0,0,0,4,8V6A1,1,0,0,0,3,5Zm0,5H1a1,1,0,0,0-1,1v2a1,1,0,0,0,1,1H3a1,1,0,0,0,1-1V11A1,1,0,0,0,3,10ZM9,0H7A1,1,0,0,0,6,1V3A1,1,0,0,0,7,4H9a1,1,0,0,0,1-1V1A1,1,0,0,0,9,0ZM9,5H7A1,1,0,0,0,6,6V8A1,1,0,0,0,7,9H9a1,1,0,0,0,1-1V6A1,1,0,0,0,9,5Zm0,5H7a1,1,0,0,0-1,1v2a1,1,0,0,0,1,1H9a1,1,0,0,0,1-1V11A1,1,0,0,0,9,10Z"
                      transform="translate(951.139 1361) rotate(90)"
                      [ngStyle]="{
                        fill: route.isFocused ? '#fff' : route.color
                      }"
                      stroke="rgba(0,0,0,0)"
                      stroke-width="1"
                    />
                  </g>
                </svg>
                <svg-icon
                  [ngClass]="{ 'svg-hover': route.nameHover }"
                  [src]="
                    !route.nameHover
                      ? 'assets/svg/common/routing/ic_route_hidden.svg'
                      : 'assets/svg/common/ic_eye-visible.svg'
                  "
                  [svgStyle]="{ 'width.px': 18, 'height.px': 18 }"
                  *ngIf="route.hidden"
                ></svg-icon>
              </div>
              <div
                class="route-name marker-info-text marker-bold-text mg-left-8"
                [ngStyle]="{
                  color: route.nameHover
                    ? route.color
                    : route.hidden
                    ? '#B7B7B7'
                    : '#3C3C3C'
                }"
                (click)="showHideRoute($event, route)"
                (mouseenter)="route.nameHover = true"
                (mouseleave)="route.nameHover = false"
              >
                {{ route.name }}

                <div
                  class="route-name-tooltip"
                  [ngStyle]="{
                    width: !route.nameHover
                      ? '0px'
                      : route.hidden
                      ? '82px'
                      : '77px',
                    'margin-left': route.nameHover ? '12px' : '0px',
                    opacity: route.nameHover ? '1' : '0'
                  }"
                >
                  {{ route.hidden ? "Show Route" : "Hide Route" }}
                </div>
              </div>
              <div class="header-properties-container">
                <div
                  class="route-type-text mg-left-12"
                  *ngIf="
                    route.truckId &&
                    route.expanded &&
                    route.expandFinished &&
                    !route.hidden
                  "
                >
                  Unit:
                  <span class="marker-bold-text">{{ route.truckId }}</span>
                </div>
                <div
                  class="route-type-text"
                  [ngClass]="{
                    'mg-left-12': !route.truckId || !route.expanded
                  }"
                  *ngIf="!route.hidden"
                >
                  {{ route.routeType }}
                </div>
                <div class="route-type-text mg-left-12" *ngIf="route.hidden">
                  {{ route.stops.length }} Stops
                </div>
                <div
                  class="route-type-text"
                  *ngIf="route.hidden && route.stops.length"
                >
                  {{ route.stops[route.stops.length - 1].total }}
                  {{ tableData[selectedMapIndex].distanceUnit }}
                </div>
                <div
                  class="route-type-text"
                  *ngIf="
                    route.stopTime &&
                    route.expanded &&
                    route.expandFinished &&
                    !route.hidden
                  "
                >
                  Stop Time:
                  <span class="marker-bold-text">{{ route.stopTime }} min</span>
                </div>
                <div
                  class="route-type-text"
                  *ngIf="
                    route.mpg &&
                    route.expanded &&
                    route.expandFinished &&
                    !route.hidden
                  "
                >
                  MPG: <span class="marker-bold-text">{{ route.mpg }} mi</span>
                </div>
                <div
                  class="route-type-text"
                  *ngIf="
                    route.fuelPrice &&
                    route.expanded &&
                    route.expandFinished &&
                    !route.hidden
                  "
                >
                  PPG:
                  <span class="marker-bold-text">${{ route.fuelPrice }}</span>
                </div>
                <div
                  class="route-card-header-divider"
                  *ngIf="route.stopTime && !route.expanded && !route.hidden"
                ></div>
                <svg-icon
                  class="route-card-icon"
                  src="assets/svg/common/ic_time.svg"
                  [svgStyle]="{ 'width.px': 18, 'height.px': 18 }"
                  *ngIf="route.stopTime && !route.expanded && !route.hidden"
                ></svg-icon>
                <div
                  class="route-card-header-divider"
                  *ngIf="route.fuelPrice && !route.expanded && !route.hidden"
                ></div>
                <svg-icon
                  class="route-card-icon"
                  src="assets/svg/common/ic_dollar.svg"
                  [svgStyle]="{ 'width.px': 18, 'height.px': 18 }"
                  *ngIf="route.fuelPrice && !route.expanded && !route.hidden"
                ></svg-icon>
              </div>
            </div>
            <div
              #t2="ngbPopover"
              (click)="toggleDropdown($event, t2, route)"
              [autoClose]="true"
              [ngbPopover]="dropdownPopover"
              [placement]="'right-top right-bottom'"
              class="show-more table-dropdown-container"
              [ngClass]="{
                'active-drop': dropDownActive === route.id && t2.isOpen()
              }"
              popoverClass="table-dropdown-popover drop-down-route"
              triggers="manual"
            >
              <svg-icon
                class="dropdown-dots"
                src="assets/svg/common/ic_horizontal_dots_details.svg"
              ></svg-icon>
            </div>
          </div>
          <div
            class="route-card-content"
            cdkDropList
            [cdkDropListDisabled]="route.stops.length < 2"
            (cdkDropListDropped)="dropStops($event, route.stops, i)"
          >
            <div
              class="route-card-row"
              *ngFor="let stop of route.stops; let b = index"
              cdkDrag
              cdkDragBoundary=".route-card-content"
              [ngClass]="{ 'focused-route': route.isFocused }"
              [ngStyle]="{ cursor: route.stops.length == 1 ? 'pointer' : '' }"
              (click)="focusStop($event, i, b)"
            >
              <div
                class="focused-route-number-background"
                [ngClass]="['route-color-' + (i + 1)]"
                [ngStyle]="{
                  display: stop.deleteHover ? 'flex' : '',
                  backgroundColor: stop.deleteHover ? '#00000033' : '#0000001A'
                }"
                *ngIf="route.isFocused"
              ></div>
              <svg-icon
                src="assets/svg/truckassist-table/dropdown/content/delete.svg"
                class="delete-button"
                [svgStyle]="{ 'width.px': 14, 'height.px': 14 }"
                (click)="deleteRouteStop($event, route, b)"
                (mouseenter)="stop.deleteHover = true"
                (mouseleave)="stop.deleteHover = false"
              ></svg-icon>
              <div class="delete-button drag-arrows">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="14"
                  height="14"
                  viewBox="0 0 14 14"
                >
                  <g id="Height" transform="translate(-648 761) rotate(-90)">
                    <rect
                      id="Rectangle_62626"
                      data-name="Rectangle 62626"
                      width="14"
                      height="14"
                      transform="translate(747 648)"
                      fill="#fff"
                      opacity="0"
                    />
                    <path
                      id="arrows-alt-h"
                      d="M8.581,146.725v1.594H4.639v-1.594a.831.831,0,0,0-1.418-.587L.243,149.116a.831.831,0,0,0,0,1.175l2.979,2.979a.831.831,0,0,0,1.418-.587v-1.594H8.581v1.594A.831.831,0,0,0,10,153.27l2.979-2.979a.831.831,0,0,0,0-1.175L10,146.138a.831.831,0,0,0-1.418.587Z"
                      transform="translate(747.39 505.296)"
                      [ngStyle]="{
                        fill: route.isFocused ? '#fff' : route.color
                      }"
                    />
                  </g>
                </svg>
              </div>
              <div
                class="route-row-number marker-like-text marker-bold-text"
                [ngStyle]="{ color: route.isFocused ? '#fff' : route.color }"
              >
                {{ b + 1 }}
              </div>
              <div
                class="delete-stop-text"
                [ngStyle]="{
                  width: !stop.deleteHover ? '0px' : '50px',
                  'min-width': !stop.deleteHover ? '0px' : '50px',
                  padding: !stop.deleteHover ? '0px' : '2px 6px',
                  opacity: stop.deleteHover ? '1' : '0'
                }"
              >
                Delete
              </div>
              <div
                class="route-row-location marker-like-text"
                [ngClass]="{
                  'full-address':
                    tableData[selectedMapIndex].addressType == 'address'
                }"
                [ngStyle]="{
                  'font-weight': stop.isSelected ? '700' : '400',
                  'min-width': stop.deleteHover ? '90px' : '',
                  width: stop.deleteHover ? '90px' : ''
                }"
              >
                {{
                  tableData[selectedMapIndex].addressType == "address" &&
                  stop.address.address
                    ? stop.address.address
                    : stop.cityAddress
                }}
              </div>

              <div *ngFor="let item of routeProperties | keyvalue: sortKeys">
                <div
                  [class]="item.value.class"
                  [ngClass]="{ 'marker-bold-text gray-text': b === 0 }"
                  [ngStyle]="{
                    width: item.value.width,
                    'margin-right': '18px',
                    color:
                      b == route.stops.length - 1 && item.value.boldValue
                        ? route.color
                        : '',
                    'font-weight': item.value.boldValue ? '800' : ''
                  }"
                  *ngIf="
                    ((item.value.checkMainValue &&
                      route[item.value.checkMainValue]) ||
                      !item.value.checkMainValue) &&
                    stop[item.value.value] != null &&
                    ((item.value.expandedOnly &&
                      route.expanded && route.expandFinished) ||
                      !item.value.expandedOnly)
                  "
                >
                  {{
                    b === 0
                      ? route.expanded && route.expandFinished
                        ? item.value.expandedText +
                          (item.value.insertExpandedText &&
                          item.value.insertExpandedText == "distanceUnit"
                            ? " " + tableData[selectedMapIndex].distanceUnit
                            : "")
                        : item.value.text
                      : stop[item.value.value]
                  }}
                </div>
              </div>
            </div>

            <div
              class="route-card-row m-0"
              [formGroup]="$any(addressInputs)"
              [ngClass]="{ 'focused-route': route.isFocused }"
              (click)="focusStop($event, i, b)"
            >
              <div
                class="focused-route-number-background"
                [ngStyle]="{ backgroundColor: '#0000001A' }"
              ></div>
              <svg-icon
                src="assets/svg/common/ic_plus.svg"
                class="delete-button plus-button"
                [ngClass]="['route-color-' + (i + 1)]"
                [svgStyle]="{
                  'width.px': 14,
                  'height.px': 14,
                  fill: route.isFocused ? '#fff' : route.color
                }"
              ></svg-icon>
              <div
                class="route-row-number marker-like-text marker-bold-text"
              ></div>
              <div
                class="route-row-location marker-like-text marker-bold-text gray-text add-new-stop"
                [formGroupName]="i"
                [ngClass]="{
                  'full-address':
                    tableData[selectedMapIndex].addressType == 'address'
                }"
              >
                <!-- Add New Stop -->
                <app-ta-input-address
                  formControlName="address"
                  [inputConfig]="{
                    name: 'Address',
                    type: 'text',
                    label: 'Add New Stop',
                    textTransform: 'capitalize',
                    addressFlag: addressFlag,
                    blackInput: true,
                    hideErrorMessage: true,
                    customClass: 'input-22',
                    commands: {
                      active: true,
                      type: 'confirm-cancel',
                      firstCommand: {
                        popup: {
                          name: 'Confirm',
                          backgroundColor: '#6C6C6C'
                        },
                        name: 'confirm',
                        svg: 'assets/svg/ic_spec-confirm.svg'
                      },
                      secondCommand: {
                        popup: {
                          name: 'Cancel',
                          backgroundColor: '#6C6C6C'
                        },
                        name: 'cancel',
                        svg: 'assets/svg/ic_x.svg'
                      }
                    }
                  }"
                  (commandEvent)="onHandleAddress($event, route, i)"
                  (changeFlag)="
                    $event === true
                      ? (addressFlag = 'Loaded')
                      : (addressFlag = 'Empty')
                  "
                ></app-ta-input-address>
              </div>
            </div>
          </div>
          <div
            class="selected-route"
            *ngIf="route.isFocused"
            [ngStyle]="{ backgroundColor: route.color }"
          ></div>
          <div
            class="route-card-resize-button"
            (click)="resizeCard($event, route)"
            *ngIf="
              !route.hidden &&
              route.hover &&
              !t2.isOpen() &&
              (route.stops.length ||
                route.truckId ||
                route.stopTime ||
                route.mpg ||
                route.fuelPrice)
            "
          >
            <svg-icon
              src="assets/svg/common/fill_arrow_down.svg"
              class="map-list-resize-svg"
              [ngClass]="{ rotate: route.expanded }"
              [svgStyle]="{ 'width.px': 12, 'height.px': 12 }"
            ></svg-icon>
          </div>
        </div>
      </div>
    </div>

    <div class="map-zoom-controls">
      <div class="map-zoom-container">
        <div class="map-zoom-button" (click)="zoomMap('plus')">
          <svg-icon
            src="assets/svg/common/ic_plus.svg"
            [svgStyle]="{ 'width.px': 12, 'height.px': 12 }"
          ></svg-icon>
        </div>
        <div class="map-zoom-button" (click)="zoomMap('minus')">
          <svg-icon
            src="assets/svg/common/ic_zoom_minus.svg"
            [svgStyle]="{ 'width.px': 12, 'height.px': 12 }"
          ></svg-icon>
        </div>
      </div>
    </div>

    <agm-map
      [latitude]="mapLatitude"
      [longitude]="mapLongitude"
      [restriction]="mapRestrictions"
      [streetViewControl]="false"
      [styles]="styles"
      [zoom]="mapZoom"
      [usePanning]="true"
      [keyboardShortcuts]="false"
      [zoomControl]="false"
      (zoomChange)="zoomChange($event)"
      (mapReady)="getMapInstance($event)"
      (mouseover)="mapHover = true"
      (mouseleave)="mapHover = false"
    >
      <div *ngFor="let route of routes; let i = index">
        <div *ngIf="route.stops?.length">
          <div
            *ngFor="let e of [].constructor(route.stops.length); let j = index"
          >
            <agm-marker
              [agmFitBounds]="true"
              [latitude]="route.stops[j].lat"
              [longitude]="route.stops[j].long"
              [visible]="false"
            >
              <agm-snazzy-info-window
                [closeOnMapClick]="false"
                [closeWhenOthersOpen]="false"
                [isOpen]="route.hidden ? false : true"
                [latitude]="route.stops[j].lat"
                [longitude]="route.stops[j].long"
                [maxHeight]="32"
                [maxWidth]="26"
                [openOnMarkerClick]="false"
                placement="bottom"
                [showCloseButton]="false"
                [pointer]="false"
              >
                <ng-template>
                  <div
                    (mouseenter)="route.stops[j].hovered = true"
                    (mouseleave)="route.stops[j].hovered = false"
                    class="marker-container marker-icon"
                    *ngIf="route.isFocused"
                    [ngStyle]="{
                      visibility:
                        focusedRouteIndex == i &&
                        stopPickerLocation.editIndex == j
                          ? 'hidden'
                          : 'visible'
                    }"
                    (click)="stopMarkerClick($event, i, j)"
                  >
                    <svg
                      [tooltipBackground]="route.color"
                      ngbTooltip
                      [disableTooltip]="true"
                      [mainTooltip]="
                        tableData[selectedMapIndex].addressType == 'address' &&
                        route.stops[j].address.address
                          ? route.stops[j].address.address
                          : route.stops[j].cityAddress
                      "
                      position="right"
                      xmlns="http://www.w3.org/2000/svg"
                      xmlns:xlink="http://www.w3.org/1999/xlink"
                      width="34"
                      height="37"
                      viewBox="0 0 34 37"
                    >
                      <defs>
                        <filter
                          id="Path_33651"
                          x="0"
                          y="0"
                          width="34"
                          height="37"
                          filterUnits="userSpaceOnUse"
                        >
                          <feOffset input="SourceAlpha" />
                          <feGaussianBlur stdDeviation="2" result="blur" />
                          <feFlood flood-opacity="0.149" />
                          <feComposite operator="in" in2="blur" />
                          <feComposite in="SourceGraphic" />
                        </filter>
                      </defs>
                      <g
                        transform="matrix(1, 0, 0, 1, 0, 0)"
                        filter="url(#Path_33651)"
                      >
                        <path
                          id="Path_33651-2"
                          data-name="Path 33651"
                          d="M22,10.974a10.97,10.97,0,0,1-4.852,9.1c-.024.018-.379.237-.519.329-3.367,2.14-4.718,3.585-5.262,4.4a.441.441,0,0,1-.609.124.457.457,0,0,1-.124-.124c-.544-.811-1.9-2.256-5.262-4.4-.153-.095-.494-.311-.519-.329A10.983,10.983,0,1,1,22,10.974"
                          transform="translate(6 6)"
                          fill="#fff"
                        />
                      </g>
                      <circle
                        id="Ellipse_6005"
                        data-name="Ellipse 6005"
                        cx="9"
                        cy="9"
                        r="9"
                        transform="translate(8 8)"
                        [ngStyle]="{ fill: route.color }"
                      />
                      <text
                        x="50%"
                        y="48.5%"
                        dominant-baseline="middle"
                        text-anchor="middle"
                        id="_1"
                        data-name="1"
                        fill="#fff"
                        font-size="11"
                        font-family="Montserrat-Bold, Montserrat"
                        font-weight="700"
                      >
                        <tspan>{{ j + 1 }}</tspan>
                      </text>
                    </svg>
                  </div>
                  <div
                    [ngStyle]="{
                      visibility:
                        focusedRouteIndex == i &&
                        stopPickerLocation.editIndex == j
                          ? 'hidden'
                          : 'visible'
                    }"
                    class="marker-container circle-marker"
                    (click)="stopMarkerClick($event, i, j)"
                  >
                    <svg
                      *ngIf="j == 0 || j == route.stops.length - 1"
                      (mouseenter)="route.stops[j].hovered = true"
                      (mouseleave)="route.stops[j].hovered = false"
                      xmlns="http://www.w3.org/2000/svg"
                      width="12"
                      height="12"
                      viewBox="0 0 12 12"
                    >
                      <circle
                        id="Ellipse_6245"
                        data-name="Ellipse 6245"
                        cx="6"
                        cy="6"
                        r="6"
                        [ngStyle]="{
                          fill: route.color
                        }"
                      />
                      <circle
                        id="Ellipse_6246"
                        data-name="Ellipse 6246"
                        cx="2"
                        cy="2"
                        r="2"
                        transform="translate(4 4)"
                        fill="#fff"
                      />
                    </svg>
                    <svg
                      *ngIf="j > 0 && j < route.stops.length - 1"
                      (mouseenter)="route.stops[j].hovered = true"
                      (mouseleave)="route.stops[j].hovered = false"
                      xmlns="http://www.w3.org/2000/svg"
                      width="12"
                      height="12"
                      viewBox="0 0 12 12"
                    >
                      <g
                        id="Group_98622"
                        data-name="Group 98622"
                        transform="translate(-1111 -981)"
                      >
                        <circle
                          id="Ellipse_6245"
                          data-name="Ellipse 6245"
                          cx="6"
                          cy="6"
                          r="6"
                          transform="translate(1111 981)"
                          [ngStyle]="{
                            fill: route.color
                          }"
                        />
                        <circle
                          id="Ellipse_6246"
                          data-name="Ellipse 6246"
                          cx="4"
                          cy="4"
                          r="4"
                          transform="translate(1113 983)"
                          fill="#fff"
                        />
                      </g>
                    </svg>
                  </div>
                  <div
                    class="stop-picker-address smaller-marker-address"
                    [ngClass]="{ 'small-marker-tooltip': !route.isFocused }"
                    [ngStyle]="{
                      backgroundColor: route.color,
                      visibility:
                        focusedRouteIndex == i &&
                        stopPickerLocation.editIndex == j
                          ? 'hidden'
                          : 'visible'
                    }"
                    *ngIf="route.stops[j].isSelected || route.stops[j].hovered"
                  >
                    <div class="stop-picker-address-text">
                      {{
                        tableData[selectedMapIndex].addressType == "address" &&
                        route.stops[j].address.address
                          ? route.stops[j].address.address
                          : route.stops[j].cityAddress
                      }}
                    </div>
                  </div>
                </ng-template>
              </agm-snazzy-info-window>
            </agm-marker>
          </div>
          <div
            *ngFor="
              let e of [].constructor(route.stops.length - 1);
              let j = index
            "
          >
            <agm-direction
              [renderOptions]="{
                preserveViewport: true,
                polylineOptions: {
                  strokeColor: route.color,
                  strokeWeight: 6,
                  zIndex: 1
                },
                suppressMarkers: true
              }"
              [optimizeWaypoints]="false"
              [origin]="{ lat: route.stops[j].lat, lng: route.stops[j].long }"
              [destination]="{
                lat: route.stops[j + 1].lat,
                lng: route.stops[j + 1].long
              }"
              [visible]="!route.hidden"
            ></agm-direction>
            <agm-direction
              *ngIf="route.stops[j + 1].empty"
              [renderOptions]="{
                preserveViewport: true,
                polylineOptions: {
                  strokeColor: '#fff',
                  strokeWeight: 3,
                  zIndex: 2
                },
                suppressMarkers: true
              }"
              [optimizeWaypoints]="false"
              [origin]="{ lat: route.stops[j].lat, lng: route.stops[j].long }"
              [destination]="{
                lat: route.stops[j + 1].lat,
                lng: route.stops[j + 1].long
              }"
              [visible]="!route.hidden"
            ></agm-direction>
          </div>
        </div>
      </div>

      <agm-marker
        *ngIf="focusedRouteIndex != null && stopPickerLocation.lat"
        [agmFitBounds]="true"
        [latitude]="stopPickerLocation.lat"
        [longitude]="stopPickerLocation.long"
        [visible]="false"
      >
        <agm-snazzy-info-window
          [closeOnMapClick]="false"
          [closeWhenOthersOpen]="false"
          [isOpen]="true"
          [latitude]="stopPickerLocation.lat"
          [longitude]="stopPickerLocation.long"
          [maxHeight]="32"
          [maxWidth]="26"
          [openOnMarkerClick]="false"
          placement="bottom"
          [showCloseButton]="false"
          [pointer]="false"
        >
          <ng-template>
            <div
              (mouseenter)="stopPickerLocation.hover = true"
              (mouseleave)="stopPickerLocation.hover = false"
            >
              <div class="marker-container marker-icon stop-picker-icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  xmlns:xlink="http://www.w3.org/1999/xlink"
                  width="56"
                  height="62"
                  viewBox="0 0 56 62"
                >
                  <defs>
                    <filter
                      id="Path_33651"
                      x="0"
                      y="0"
                      width="56"
                      height="62"
                      filterUnits="userSpaceOnUse"
                    >
                      <feOffset input="SourceAlpha" />
                      <feGaussianBlur stdDeviation="2" result="blur" />
                      <feFlood flood-opacity="0.149" />
                      <feComposite operator="in" in2="blur" />
                      <feComposite in="SourceGraphic" />
                    </filter>
                  </defs>
                  <g
                    id="Group_99491"
                    data-name="Group 99491"
                    transform="translate(-619 -2257.999)"
                  >
                    <g
                      id="Group_99449"
                      data-name="Group 99449"
                      transform="translate(-470 1327)"
                    >
                      <circle
                        id="Ellipse_6245"
                        data-name="Ellipse 6245"
                        cx="4"
                        cy="4"
                        r="4"
                        transform="translate(1113 983)"
                        [ngStyle]="{
                          fill: routes[focusedRouteIndex].color
                        }"
                      />
                    </g>

                    <!-- Show stop number -->
                    <g
                      *ngIf="!stopPickerLocation.hover"
                      id="Group_94110"
                      data-name="Group 94110"
                      transform="translate(-11 -26)"
                    >
                      <g
                        transform="matrix(1, 0, 0, 1, 630, 2284)"
                        [ngStyle]="{
                          filter: 'drop-shadow(0 0 4px rgba(0, 0, 0, 0.15)'
                        }"
                      >
                        <!-- filter="url(#Path_33651)" -->
                        <path
                          id="Path_33651-2"
                          data-name="Path 33651"
                          d="M44,21.948a21.94,21.94,0,0,1-9.7,18.208c-.048.036-.758.474-1.038.658-6.734,4.28-9.436,7.17-10.524,8.792a.881.881,0,0,1-1.218.248.915.915,0,0,1-.248-.248c-1.088-1.622-3.8-4.512-10.524-8.792-.306-.19-.988-.622-1.038-.658A21.966,21.966,0,1,1,44,21.948"
                          transform="translate(6 6)"
                          fill="#fff"
                        />
                      </g>
                      <circle
                        id="Ellipse_6005"
                        data-name="Ellipse 6005"
                        cx="18"
                        cy="18"
                        r="18"
                        transform="translate(640 2294)"
                        [ngStyle]="{
                          fill: routes[focusedRouteIndex].color
                        }"
                      />
                      <text
                        dominant-baseline="middle"
                        text-anchor="middle"
                        id="_5"
                        data-name="5"
                        transform="translate(658 2318)"
                        fill="#fff"
                        font-size="18"
                        font-family="Montserrat-Bold, Montserrat"
                        font-weight="700"
                      >
                        <tspan y="-5">
                          {{
                            focusedStopIndex != null 
                              ? focusedStopIndex+2 
                              :
                            stopPickerLocation.editIndex != null
                              ? stopPickerLocation.editIndex + 1
                              : routes[focusedRouteIndex].stops.length + 1
                          }}
                        </tspan>
                      </text>
                    </g>

                    <!-- Show delete icon on hover -->
                    <g
                      *ngIf="stopPickerLocation.hover"
                      (click)="deleteStopPickerLocation($event)"
                      (mouseover)="stopPickerLocation.deleteHover = true"
                      (mouseleave)="stopPickerLocation.deleteHover = false"
                      id="Group_94110"
                      data-name="Group 94110"
                      transform="translate(-11 -26)"
                    >
                      <g
                        transform="matrix(1, 0, 0, 1, 630, 2284)"
                        [ngStyle]="{
                          filter: 'drop-shadow(0 0 4px rgba(0, 0, 0, 0.15)'
                        }"
                      >
                        <!-- filter="url(#Path_33651)" -->
                        <path
                          id="Path_33651-2"
                          data-name="Path 33651"
                          d="M44,21.948a21.94,21.94,0,0,1-9.7,18.208c-.048.036-.758.474-1.038.658-6.734,4.28-9.436,7.17-10.524,8.792a.881.881,0,0,1-1.218.248.915.915,0,0,1-.248-.248c-1.088-1.622-3.8-4.512-10.524-8.792-.306-.19-.988-.622-1.038-.658A21.966,21.966,0,1,1,44,21.948"
                          transform="translate(6 6)"
                          fill="#fff"
                        />
                      </g>
                      <circle
                        id="Ellipse_6005"
                        data-name="Ellipse 6005"
                        cx="18"
                        cy="18"
                        r="18"
                        transform="translate(640 2294)"
                        [ngStyle]="{
                          fill: routes[focusedRouteIndex].color
                        }"
                      />
                      <g
                        id="Delete"
                        transform="translate(283 1759)"
                        [ngStyle]="{
                          opacity: stopPickerLocation.deleteHover ? '1' : '0.7'
                        }"
                      >
                        <rect
                          id="Rectangle_55464"
                          data-name="Rectangle 55464"
                          width="18"
                          height="18"
                          transform="translate(366 544)"
                          fill="#fff"
                          opacity="0"
                        />
                        <path
                          id="Path_7317"
                          data-name="Path 7317"
                          d="M32.675,106.988,32,96H44.222l-.675,10.988a1.486,1.486,0,0,1-1.525,1.333H34.2a1.486,1.486,0,0,1-1.524-1.333Z"
                          transform="translate(336.889 452.68)"
                          fill="#fff"
                        />
                        <path
                          id="Path_7318"
                          data-name="Path 7318"
                          d="M0,2.5v-1A.5.5,0,0,1,.508,1h3.81l.3-.585A.754.754,0,0,1,5.3,0H8.924a.763.763,0,0,1,.683.416L9.9,1h3.81a.5.5,0,0,1,.508.5v1a.5.5,0,0,1-.508.5H.508A.5.5,0,0,1,0,2.5Z"
                          transform="translate(367.889 545)"
                          fill="#fff"
                        />
                      </g>
                    </g>
                  </g>
                </svg>
              </div>
              <div
                class="stop-picker-window"
                *ngIf="!stopPickerLocation.deleteHover"
              >
                <div
                  class="stop-picker-button"
                  (click)="addNewStop('empty')"
                  [ngClass]="{
                    active:
                      addressFlag == 'Empty'
                  }"
                >
                  <div class="stop-picker-button-text">Empty</div>
                </div>
                <div
                  class="stop-picker-button"
                  (click)="addNewStop('loaded')"
                  [ngClass]="{ active: addressFlag == 'Loaded' }"
                >
                  <div class="stop-picker-button-text">Loaded</div>
                </div>
              </div>
              <div
                class="stop-picker-address stop-picker-delete"
                *ngIf="stopPickerLocation.deleteHover"
              >
                <div class="stop-picker-address-text">Delete</div>
              </div>
              <div
                class="stop-picker-address"
                [ngStyle]="{
                  backgroundColor: routes[focusedRouteIndex].color
                }"
              >
                <div class="stop-picker-address-text">
                  {{
                    tableData[selectedMapIndex].addressType == "address"
                      ? stopPickerLocation.address.address
                      : stopPickerLocation.cityAddress
                  }}
                </div>
              </div>
            </div>
          </ng-template>
        </agm-snazzy-info-window>
      </agm-marker>
    </agm-map>

    <div
      id="stopPickerCursor"
      class="stop-picker-cursor"
      *ngIf="stopPickerActive && focusedRouteIndex != null && mapHover"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink"
        width="34"
        height="34"
        viewBox="0 0 34 34"
      >
        <defs>
          <filter
            id="Ellipse_9150"
            x="0"
            y="0"
            width="34"
            height="34"
            filterUnits="userSpaceOnUse"
          >
            <feOffset input="SourceAlpha" />
            <feGaussianBlur stdDeviation="2" result="blur" />
            <feFlood flood-opacity="0.149" />
            <feComposite operator="in" in2="blur" />
            <feComposite in="SourceGraphic" />
          </filter>
        </defs>
        <g transform="matrix(1, 0, 0, 1, 0, 0)" filter="url(#Ellipse_9150)">
          <circle
            id="Ellipse_9150-2"
            data-name="Ellipse 9150"
            cx="11"
            cy="11"
            r="11"
            transform="translate(6 6)"
            fill="#fff"
          />
        </g>
        <circle
          id="Ellipse_9149"
          data-name="Ellipse 9149"
          cx="9"
          cy="9"
          r="9"
          transform="translate(8 8)"
          [ngStyle]="{ fill: routes[focusedRouteIndex].color }"
        />
        <text
          dominant-baseline="middle"
          text-anchor="middle"
          id="_6"
          data-name="6"
          transform="translate(17 21.5)"
          fill="#fff"
          font-size="12"
          font-family="Montserrat-Bold, Montserrat"
          font-weight="700"
        >
          <tspan y="-3">{{ focusedStopIndex != null 
                            ? focusedStopIndex+2 
                            : routes[focusedRouteIndex].stops.length + 1 }}
          </tspan>
        </text>
      </svg>
    </div>
  </div>
</div>

<ng-template #dropdownPopover let-data="data">
  <div class="table-dropdown">
    <div
      (click)="action.disabled ? $event.stopPropagation() : callDropDownAction($event, action)"
      *ngFor="let action of data"
      class="table-dropdown-content"
      [class]="action.class"
      [ngStyle]="{ 'background': action.disabled ? 'gray !important' : '' }"
    >
      <svg-icon
        [ngClass]="{
          'activate-header': action.activate,
          'deactivate-header': action.deactivate
        }"
        class="action-svg"
        src="{{ action.svg }}"
        [svgStyle]="{ 'width.px': 18, 'height.px': 18 }"
      ></svg-icon>
      <div class="dropdown-content-text">{{ action.title }}</div>
    </div>
  </div>
</ng-template>
