<div class="table-container">
    <div class="table-toolbar-container toolbar-relative">
      <app-map-toolbar
        #mapToolbar
        (toolBarAction)="onToolBarAction($event)"
        [options]="tableOptions"
        [tableData]="tableData"
        [selectedTab]="selectedTab"
        [stopPickerActive]="stopPickerActive"
        [isTollRoadsActive]="isTollRoadsActive"
        [isTimeZoneActive]="isTimeZoneActive"
        [isDopplerOn]="isDopplerOn"
        [trafficLayerShow]="trafficLayerShow"
      ></app-map-toolbar>
    </div>
    
    <div class="customer-map-container">
        <div class="route-card-container">
            <div 
                class="route-card-scroll" 
                cdkDropList 
                (cdkDropListDropped)="dropRoutes($event, routes)" 
                [ngStyle]="{ 'padding-right': tooltip?.isOpen() ? '126px' : '13px', 'padding-bottom': tooltip?.isOpen() ? '113px' : '13px' }"
            >
                <div 
                    class="route-info-card" 
                    cdkDrag 
                    *ngFor="let route of routes; let i = index;" 
                    (click)="!route.hidden ? focusRoute(i) : showHideRoute($event, route)"
                    (mouseenter)="hoverRoute(route)"
                    (mouseleave)="leaveRouteHover(route)"
                    [ngClass]="{ 
                        'route-hidden': route.hidden, 
                        'expanded-card': route.expanded
                    }"
                    [ngStyle]="{ 
                        'width': 
                            route.width ? route.width : '312px',
                        'padding-right': route.hover && !route.hidden ? '14px' : '4px'
                    }">
                    <div class="route-info-header">
                        <div class="header-content-container">
                            <div 
                                cdkDragHandle
                                class="route-card-svg"
                                [tooltipBackground]="'#616161'"
                                ngbTooltip
                                [mainTooltip]="'Route Reorder'"
                                position="right"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" *ngIf="!route.hidden">
                                    <g id="Drag" transform="translate(-935.139 -1357)" opacity="0.7">
                                        <rect id="Rectangle_63459" data-name="Rectangle 63459" width="18" height="18" rx="2" transform="translate(935.139 1357)" fill="#f27b8e" opacity="0"/>
                                        <path id="grip-vertical" d="M3,0H1A1,1,0,0,0,0,1V3A1,1,0,0,0,1,4H3A1,1,0,0,0,4,3V1A1,1,0,0,0,3,0ZM3,5H1A1,1,0,0,0,0,6V8A1,1,0,0,0,1,9H3A1,1,0,0,0,4,8V6A1,1,0,0,0,3,5Zm0,5H1a1,1,0,0,0-1,1v2a1,1,0,0,0,1,1H3a1,1,0,0,0,1-1V11A1,1,0,0,0,3,10ZM9,0H7A1,1,0,0,0,6,1V3A1,1,0,0,0,7,4H9a1,1,0,0,0,1-1V1A1,1,0,0,0,9,0ZM9,5H7A1,1,0,0,0,6,6V8A1,1,0,0,0,7,9H9a1,1,0,0,0,1-1V6A1,1,0,0,0,9,5Zm0,5H7a1,1,0,0,0-1,1v2a1,1,0,0,0,1,1H9a1,1,0,0,0,1-1V11A1,1,0,0,0,9,10Z" transform="translate(951.139 1361) rotate(90)" [ngStyle]="{ fill: route.isFocused ? '#fff' : routeColors[i] }" stroke="rgba(0,0,0,0)" stroke-width="1"/>
                                    </g>
                                </svg>
                                <svg-icon
                                    [ngClass]="{ 'svg-hover': route.nameHover }"
                                    [src]="!route.nameHover ? 'assets/svg/common/routing/ic_route_hidden.svg' : 'assets/svg/common/ic_eye-visible.svg'"
                                    [svgStyle]="{ 'width.px': 18, 'height.px': 18 }"
                                    *ngIf="route.hidden"
                                ></svg-icon>
                            </div>
                            <div 
                                class="route-name marker-info-text marker-bold-text mg-left-8"
                                [ngStyle]="{ color: route.nameHover ? routeFocusColors[i] : route.hidden ? '#B7B7B7' : '#6c6c6c' }"
                                (click)="showHideRoute($event, route)"
                                (mouseenter)="route.nameHover = true"
                                (mouseleave)="route.nameHover = false">
                                {{ route.name }}

                                <div 
                                    class="route-name-tooltip"
                                    [ngStyle]="{
                                        'width': !route.nameHover ? '0px' : route.hidden ? '82px' : '77px',
                                        'opacity': route.nameHover ? '1' : '0'
                                    }">
                                    {{ route.hidden ? 'Show Route' : 'Hide Route' }}
                                </div>
                            </div>
                            <div class="route-type-text mg-left-12" *ngIf="route.truckId && route.expanded && route.expandFinished">Unit: <span class="marker-bold-text">{{ route.truckId }}</span></div>
                            <div class="route-type-text" [ngClass]="{ 'mg-left-12': !route.truckId || !route.expanded }" *ngIf="!route.hidden">{{ route.routeType }}</div>
                            <div class="route-type-text mg-left-12" *ngIf="route.hidden && !route.nameHover">{{ route.stops.length }} Stops</div>
                            <div class="route-type-text" *ngIf="route.hidden && !route.nameHover && route.stops.length">{{ route.stops[route.stops.length-1].total }} {{ tableData[selectedMapIndex].distanceUnit }}</div>
                            <div class="route-type-text" *ngIf="route.stopTime && route.expanded && route.expandFinished">Stop Time: <span class="marker-bold-text">{{ route.stopTime }} min</span></div>
                            <div class="route-type-text" *ngIf="route.mpg && route.expanded && route.expandFinished">MPG: <span class="marker-bold-text">{{ route.mpg }} mi</span></div>
                            <div class="route-type-text" *ngIf="route.fuelPrice && route.expanded && route.expandFinished">PPG: <span class="marker-bold-text">${{ route.fuelPrice }}</span></div>
                            <div class="route-card-header-divider" *ngIf="route.stopTime && !route.expanded"></div>
                            <svg-icon
                                class="route-card-icon"
                                src="assets/svg/common/ic_time.svg"
                                [svgStyle]="{ 'width.px': 18, 'height.px': 18 }"
                                *ngIf="route.stopTime && !route.expanded"
                            ></svg-icon>
                            <div class="route-card-header-divider" *ngIf="route.fuelPrice && !route.expanded"></div>
                            <svg-icon
                                class="route-card-icon"
                                src="assets/svg/common/ic_dollar.svg"
                                [svgStyle]="{ 'width.px': 18, 'height.px': 18 }"
                                *ngIf="route.fuelPrice && !route.expanded"
                            ></svg-icon>
                        </div>
                        <div 
                            #t2="ngbPopover"
                            (click)="toggleDropdown($event, t2, route)"
                            [autoClose]="true"
                            [ngbPopover]="dropdownPopover"
                            [placement]="'right-top right-bottom'"
                            class="show-more table-dropdown-container"
                            [ngClass]="{
                                'active-drop': dropDownActive === route.id && t2.isOpen()
                            }"
                            popoverClass="table-dropdown-popover drop-down-route"
                            triggers="manual"
                            >
                            <svg-icon
                                class="dropdown-dots"
                                src="assets/svg/common/ic_horizontal_dots_details.svg"
                            ></svg-icon>
                            <!-- <app-details-page-dropdown
                                [customClassDropDown]="'drop-down-route'"
                                [options]="dropdownActions"
                                [placement]="'right-top right-bottom'"
                                [hasVericalDots]="true"
                                [id]="route?.id"
                                (dropDownActions)="callDropDownAction($event)"
                            ></app-details-page-dropdown> -->
                        </div>
                    </div>
                    <div class="route-card-content" cdkDropList (cdkDropListDropped)="dropStops($event, route.stops, i)">
                        <!-- <div class="route-card-row">
                            <div class="route-row-number marker-like-text marker-bold-text" [ngStyle]="{ color: routeColors[i] }">1</div>
                            <div class="route-row-location marker-like-text" [ngClass]="{ 'full-address': route.fullAddressView }">{{ route.startPoint.fullAddress ? route.startPoint.fullAddress : route.startPoint.address }}</div>
                            <div class="route-row-leg marker-like-text marker-bold-text gray-text" *ngIf="!route.expanded">Leg</div>
                            <div class="route-row-leg shorter-leg-text marker-like-text marker-bold-text gray-text" *ngIf="route.expanded">Leg t</div>
                            <div class="route-row-leg marker-like-text marker-bold-text gray-text" *ngIf="route.expanded">Total t</div>
                            <div class="route-row-leg marker-like-text marker-bold-text gray-text" *ngIf="route.expanded">Leg mi</div>
                            <div class="route-row-total marker-like-text marker-bold-text gray-text" *ngIf="!route.expanded">Total</div>
                            <div class="route-row-total marker-like-text marker-bold-text gray-text" *ngIf="route.expanded">Total mi</div>
                        </div> -->
                        <div 
                            class="route-card-row" 
                            *ngFor="let stop of route.stops; let b = index;" 
                            cdkDrag 
                            cdkDragBoundary=".route-card-content"
                            [ngClass]="{ 'focused-route': route.isFocused, 'selected-stop': stop.isSelected }"
                            (click)="focusStop($event, i, b)">
                            <div 
                                class="focused-route-number-background" 
                                [ngStyle]="{ backgroundColor: routeFocusColors[i]+'B3' }"
                                *ngIf="route.isFocused || stop.isSelected"
                            ></div>
                            <svg-icon
                                src="assets/svg/truckassist-table/dropdown/content/delete.svg"
                                class="delete-button"
                                [svgStyle]="{ 'width.px': 14, 'height.px': 14 }"
                                (click)="deleteRouteStop($event, route, b)"
                            ></svg-icon>
                            <div class="delete-button drag-arrows">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 14 14">
                                    <g id="Height" transform="translate(-648 761) rotate(-90)">
                                        <rect id="Rectangle_62626" data-name="Rectangle 62626" width="14" height="14" transform="translate(747 648)" fill="#fff" opacity="0"/>
                                        <path id="arrows-alt-h" d="M8.581,146.725v1.594H4.639v-1.594a.831.831,0,0,0-1.418-.587L.243,149.116a.831.831,0,0,0,0,1.175l2.979,2.979a.831.831,0,0,0,1.418-.587v-1.594H8.581v1.594A.831.831,0,0,0,10,153.27l2.979-2.979a.831.831,0,0,0,0-1.175L10,146.138a.831.831,0,0,0-1.418.587Z" transform="translate(747.39 505.296)" [ngStyle]="{ fill: route.isFocused ? '#fff' : routeColors[i] }" />
                                    </g>
                                </svg>
                            </div>
                            <div class="delete-stop-text">Delete</div>
                            <div class="route-row-number marker-like-text marker-bold-text" [ngStyle]="{ color: route.isFocused ? '#fff' : routeColors[i] }">{{ b + 1 }}</div>
                            <div class="route-row-location marker-like-text" [ngClass]="{ 'full-address': tableData[selectedMapIndex].addressType == 'address' }">
                                {{ tableData[selectedMapIndex].addressType == 'address' && stop.address.address ? stop.address.address : stop.cityAddress }}
                            </div>

                            <div *ngFor="let item of routeProperties | keyvalue: sortKeys">
                                <div 
                                    [class]="item.value.class"
                                    [ngClass]="{ 'marker-bold-text gray-text': b === 0 }"
                                    [ngStyle]="{ 
                                        'width': item.value.width,
                                        'margin-right': '18px',
                                        'color': (b == route.stops.length-1 && item.value.boldValue ) ? route.isFocused ? routeFocusColors[i] : routeColors[i] : ''
                                    }"
                                    *ngIf="
                                        (item.value.checkMainValue && route[item.value.checkMainValue] || !item.value.checkMainValue) && 
                                        stop[item.value.value] != null && 
                                        ( (item.value.expandedOnly && 
                                        (route.expanded && route.expandFinished)) || !item.value.expandedOnly )">
                                        {{ b === 0 ? (route.expanded && route.expandFinished) ? item.value.expandedText + (item.value.insertExpandedText && item.value.insertExpandedText == 'distanceUnit' ? ' '+tableData[selectedMapIndex].distanceUnit : '') : item.value.text : stop[item.value.value] }}
                                    </div>
                            </div>

                            <!-- <div class="route-row-leg shorter-leg-text marker-like-text" [ngClass]="{ 'marker-bold-text gray-text': b === 0 }" *ngIf="route.expanded && route.expandFinished">{{ b === 0 ? 'Leg t' : stop.time }}</div>
                            <div class="route-row-total marker-like-text marker-semibold-text" [ngClass]="{ 'marker-bold-text gray-text': b === 0 }" [ngStyle]="{ color: (b == route.stops.length-1 && route.isFocused) ? routeFocusColors[i] : (b == route.stops.length-1 && !route.isFocused) ? routeColors[i] : '' }" *ngIf="route.expanded && route.expandFinished">{{ b === 0 ? 'Total t' : stop.totalTime }}</div>
                            <div class="route-row-leg shorter-leg-text marker-like-text" [ngStyle]="{ 'width': '56px' }" [ngClass]="{ 'marker-bold-text gray-text': b === 0 }" *ngIf="route.expanded && route.expandFinished && route.fuelPrice">{{ b === 0 ? 'Leg $' :  '$' + route.fuelPrice }}</div>
                            <div class="route-row-total marker-like-text marker-semibold-text" [ngClass]="{ 'marker-bold-text gray-text': b === 0 }" [ngStyle]="{ 'width': '60px', color: (b == route.stops.length-1 && route.isFocused) ? routeFocusColors[i] : (b == route.stops.length-1 && !route.isFocused) ? routeColors[i] : '' }" *ngIf="route.expanded && route.expandFinished && route.fuelPrice">{{ b === 0 ? 'Total $' : '$' + route.fuelPrice }}</div>
                            <div class="route-row-leg marker-like-text" [ngClass]="{ 'marker-bold-text gray-text': b === 0 }">
                                {{ b === 0 && route.expanded && route.expandFinished ? 'Leg ' + tableData[selectedMapIndex].distanceUnit : b === 0 && !route.expanded ? 'Leg' : (stop.leg) }}</div>
                            <div class="route-row-total marker-like-text marker-semibold-text" [ngClass]="{ 'marker-bold-text gray-text': b === 0 }" [ngStyle]="{ color: (b == route.stops.length-1 && route.isFocused) ? routeFocusColors[i] : (b == route.stops.length-1 && !route.isFocused) ? routeColors[i] : '' }">{{ b === 0 && route.expanded && route.expandFinished ? 'Total ' + tableData[selectedMapIndex].distanceUnit : b === 0 && !route.expanded ? 'Total' : (stop.total) }}</div> -->
                        </div>
                        <!-- <div class="empty-miles"></div> -->
                        <div class="route-card-row m-0" [formGroup]="$any(addressInputs)" [ngClass]="{ 'focused-route': route.isFocused }">
                            <svg-icon
                                src="assets/svg/common/ic_plus.svg"
                                class="delete-button plus-button"
                                [svgStyle]="{ 'width.px': 14, 'height.px': 14, fill: route.isFocused ? '#fff' : routeColors[i] }"
                            ></svg-icon>
                            <div class="route-row-number marker-like-text marker-bold-text"></div>
                            <div 
                                class="route-row-location marker-like-text marker-bold-text gray-text add-new-stop" 
                                [formGroupName]="i"
                                [ngClass]="{ 'full-address': tableData[selectedMapIndex].addressType == 'address' }">
                                <!-- Add New Stop -->
                                <app-ta-input-address
                                    formControlName="address"
                                    [inputConfig]="{
                                        name: 'Address',
                                        type: 'text',
                                        label: 'Add New Stop',
                                        textTransform: 'capitalize',
                                        addressFlag: addressFlag,
                                        blackInput: true,
                                        hideErrorMessage: true,
                                        customClass: 'input-22',
                                        commands: {
                                            active: true,
                                            type: 'confirm-cancel',
                                            firstCommand: {
                                                popup: {
                                                    name: 'Confirm',
                                                    backgroundColor: '#6C6C6C'
                                                },
                                                name: 'confirm',
                                                svg: 'assets/svg/ic_spec-confirm.svg'
                                            },
                                            secondCommand: {
                                                popup: {
                                                    name: 'Cancel',
                                                    backgroundColor: '#6C6C6C'
                                                },
                                                name: 'cancel',
                                                svg: 'assets/svg/ic_x.svg'
                                            }
                                        }
                                    }"
                                    (commandEvent)="onHandleAddress($event, route, i)"
                                    (changeFlag)="
                                        $event === true ? (addressFlag = 'Loaded') : (addressFlag = 'Empty')
                                    "
                                ></app-ta-input-address>
                            </div>
                        </div>
                    </div>
                    <div class="selected-route" *ngIf="route.isFocused" [ngStyle]="{ backgroundColor: routeFocusColors[i] }"></div>
                    <div 
                        class="route-card-resize-button" 
                        (click)="resizeCard($event, route)" 
                        *ngIf="(!route.hidden && route.hover && !t2.isOpen()) && 
                               (route.stops.length || route.truckId || route.stopTime || route.mpg || route.fuelPrice)">
                        <svg-icon
                            src="assets/svg/common/fill_arrow_down.svg"
                            class="map-list-resize-svg"
                            [ngClass]="{ 'rotate': route.expanded}"
                            [svgStyle]="{ 'width.px': 12, 'height.px': 12 }"
                        ></svg-icon>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-zoom-controls">
            <div class="map-zoom-container">
                <div class="map-zoom-button" (click)="zoomMap('plus')">
                    <svg-icon
                        src="assets/svg/common/ic_plus.svg"
                        [svgStyle]="{ 'width.px': 12, 'height.px': 12 }"
                    ></svg-icon>
                </div>
                <div class="map-zoom-button" (click)="zoomMap('minus')">
                    <svg-icon
                        src="assets/svg/common/ic_zoom_minus.svg"
                        [svgStyle]="{ 'width.px': 12, 'height.px': 12 }"
                    ></svg-icon>
                </div>
            </div>
        </div>

        <agm-map
            [latitude]="mapLatitude"
            [longitude]="mapLongitude"
            [restriction]="mapRestrictions"
            [streetViewControl]="false"
            [styles]="styles"
            [zoom]="mapZoom"
            [usePanning]="true"
            [keyboardShortcuts]="false"
            [zoomControl]="false"
            (zoomChange)="zoomChange($event)"
            (mapReady)="getMapInstance($event)"
            (mouseenter)="mapHover = true"
            (mouseleave)="mapHover = false">

            <div *ngFor="let route of routes; let i = index;">
                <div *ngIf="route.stops?.length">
                    <div *ngFor="let e of [].constructor(route.stops.length); let j = index">
                        <agm-marker
                            [agmFitBounds]="true"
                            [latitude]="route.stops[j].lat"
                            [longitude]="route.stops[j].long"
                            [visible]="false"
                            >
                            <agm-snazzy-info-window
                                [closeOnMapClick]="false"
                                [closeWhenOthersOpen]="false"
                                [isOpen]="route.hidden ? false : true"
                                [latitude]="route.stops[j].lat"
                                [longitude]="route.stops[j].long"
                                [maxHeight]="32"
                                [maxWidth]="26"
                                [openOnMarkerClick]="false"
                                placement="bottom"
                                [showCloseButton]="false"
                                [pointer]="false"
                            >
                                <ng-template>
                                    <div 
                                        (mouseenter)="route.stops[j].hovered = true" 
                                        (mouseleave)="route.stops[j].hovered = false"   
                                        class="marker-container marker-icon" 
                                        *ngIf="route.isFocused" 
                                        (click)="stopMarkerClick($event, i, j)"
                                    >
                                        <svg
                                            [tooltipBackground]="routeFocusColors[i]"
                                            ngbTooltip
                                            [disableTooltip]="true"
                                            [mainTooltip]="tableData[selectedMapIndex].addressType == 'address' && route.stops[j].address.address ? route.stops[j].address.address : route.stops[j].cityAddress"
                                            position="right" 
                                            xmlns="http://www.w3.org/2000/svg" 
                                            xmlns:xlink="http://www.w3.org/1999/xlink" 
                                            width="34" 
                                            height="37" 
                                            viewBox="0 0 34 37">
                                            <defs>
                                            <filter id="Path_33651" x="0" y="0" width="34" height="37" filterUnits="userSpaceOnUse">
                                                <feOffset input="SourceAlpha"/>
                                                <feGaussianBlur stdDeviation="2" result="blur"/>
                                                <feFlood flood-opacity="0.149"/>
                                                <feComposite operator="in" in2="blur"/>
                                                <feComposite in="SourceGraphic"/>
                                            </filter>
                                            </defs>
                                            <g transform="matrix(1, 0, 0, 1, 0, 0)" filter="url(#Path_33651)">
                                            <path id="Path_33651-2" data-name="Path 33651" d="M22,10.974a10.97,10.97,0,0,1-4.852,9.1c-.024.018-.379.237-.519.329-3.367,2.14-4.718,3.585-5.262,4.4a.441.441,0,0,1-.609.124.457.457,0,0,1-.124-.124c-.544-.811-1.9-2.256-5.262-4.4-.153-.095-.494-.311-.519-.329A10.983,10.983,0,1,1,22,10.974" transform="translate(6 6)" fill="#fff"/>
                                            </g>
                                            <circle id="Ellipse_6005" data-name="Ellipse 6005" cx="9" cy="9" r="9" transform="translate(8 8)" [ngStyle]="{ fill: routeFocusColors[i] }" />
                                            <text x="50%" y="48.5%" dominant-baseline="middle" text-anchor="middle" id="_1" data-name="1" fill="#fff" font-size="11" font-family="Montserrat-Bold, Montserrat" font-weight="700"><tspan>{{ j+1 }}</tspan></text>
                                        </svg>
                                    </div>
                                    <div class="marker-container circle-marker" (click)="stopMarkerClick($event, i, j)">
                                        <svg 
                                            *ngIf="j == 0 || j == route.stops.length-1" 
                                            (mouseenter)="route.stops[j].hovered = true" 
                                            (mouseleave)="route.stops[j].hovered = false" 
                                            xmlns="http://www.w3.org/2000/svg" 
                                            width="12" 
                                            height="12" 
                                            viewBox="0 0 12 12">
                                            <circle id="Ellipse_6245" data-name="Ellipse 6245" cx="6" cy="6" r="6" [ngStyle]="{ fill: (route.isFocused || route.stops[j].hovered) ? routeFocusColors[i] : routeColors[i] }" />
                                            <circle id="Ellipse_6246" data-name="Ellipse 6246" cx="2" cy="2" r="2" transform="translate(4 4)" fill="#fff"/>
                                        </svg>
                                        <svg 
                                            *ngIf="j > 0 && j < route.stops.length-1" 
                                            (mouseenter)="route.stops[j].hovered = true" 
                                            (mouseleave)="route.stops[j].hovered = false" 
                                            xmlns="http://www.w3.org/2000/svg" 
                                            width="12" 
                                            height="12" 
                                            viewBox="0 0 12 12">
                                            <g id="Group_98622" data-name="Group 98622" transform="translate(-1111 -981)">
                                              <circle id="Ellipse_6245" data-name="Ellipse 6245" cx="6" cy="6" r="6" transform="translate(1111 981)"  [ngStyle]="{ fill: (route.isFocused || route.stops[j].hovered) ? routeFocusColors[i] : routeColors[i] }" />
                                              <circle id="Ellipse_6246" data-name="Ellipse 6246" cx="4" cy="4" r="4" transform="translate(1113 983)" fill="#fff"/>
                                            </g>
                                        </svg>
                                    </div>
                                    <div 
                                        class="stop-picker-address smaller-marker-address" 
                                        [ngStyle]="{ backgroundColor: routeFocusColors[i] }" 
                                        *ngIf="route.isFocused && (route.stops[j].isSelected || route.stops[j].hovered)"
                                    >
                                        <div class="stop-picker-address-text">{{ tableData[selectedMapIndex].addressType == 'address' && route.stops[j].address.address ? route.stops[j].address.address : route.stops[j].cityAddress }}</div>
                                    </div>
                                </ng-template>
                            </agm-snazzy-info-window>
                        </agm-marker>
                    </div>
                    <div *ngFor="let e of [].constructor(route.stops.length-1); let j = index">
                        <agm-direction
                            [renderOptions]="{ preserveViewport: true, polylineOptions: { strokeColor: route.isFocused ? routeFocusColors[i] : routeColors[i], strokeWeight: 6, zIndex: 1 }, suppressMarkers: true }"
                            [optimizeWaypoints]="false"
                            [origin]="{ lat: route.stops[j].lat, lng: route.stops[j].long }"
                            [destination]="{ lat: route.stops[j+1].lat, lng: route.stops[j+1].long }"
                            [visible]="!route.hidden"
                        ></agm-direction>
                        <agm-direction
                            *ngIf="route.stops[j+1].empty"
                            [renderOptions]="{ preserveViewport: true, polylineOptions: { strokeColor: '#fff', strokeWeight: 3, zIndex: 2 }, suppressMarkers: true }"
                            [optimizeWaypoints]="false"
                            [origin]="{ lat: route.stops[j].lat, lng: route.stops[j].long }"
                            [destination]="{ lat: route.stops[j+1].lat, lng: route.stops[j+1].long }"
                            [visible]="!route.hidden"
                        ></agm-direction>
                    </div>
                </div>
            </div>

            <agm-marker
                *ngIf="focusedRouteIndex != null && stopPickerLocation.lat"
                [agmFitBounds]="true"
                [latitude]="stopPickerLocation.lat"
                [longitude]="stopPickerLocation.long"
                [visible]="false"
            >
                <agm-snazzy-info-window
                    [closeOnMapClick]="false"
                    [closeWhenOthersOpen]="false"
                    [isOpen]="true"
                    [latitude]="stopPickerLocation.lat"
                    [longitude]="stopPickerLocation.long"
                    [maxHeight]="32"
                    [maxWidth]="26"
                    [openOnMarkerClick]="false"
                    placement="bottom"
                    [showCloseButton]="false"
                    [pointer]="false"
                >
                    <ng-template>
                        <div>
                            <div class="marker-container marker-icon ">
                                <svg 
                                    xmlns="http://www.w3.org/2000/svg" 
                                    xmlns:xlink="http://www.w3.org/1999/xlink" 
                                    width="34" 
                                    height="37" 
                                    viewBox="0 0 34 37">
                                    <defs>
                                    <filter id="Path_33651" x="0" y="0" width="34" height="37" filterUnits="userSpaceOnUse">
                                        <feOffset input="SourceAlpha"/>
                                        <feGaussianBlur stdDeviation="2" result="blur"/>
                                        <feFlood flood-opacity="0.149"/>
                                        <feComposite operator="in" in2="blur"/>
                                        <feComposite in="SourceGraphic"/>
                                    </filter>
                                    </defs>
                                    <g transform="matrix(1, 0, 0, 1, 0, 0)" filter="url(#Path_33651)">
                                    <path id="Path_33651-2" data-name="Path 33651" d="M22,10.974a10.97,10.97,0,0,1-4.852,9.1c-.024.018-.379.237-.519.329-3.367,2.14-4.718,3.585-5.262,4.4a.441.441,0,0,1-.609.124.457.457,0,0,1-.124-.124c-.544-.811-1.9-2.256-5.262-4.4-.153-.095-.494-.311-.519-.329A10.983,10.983,0,1,1,22,10.974" transform="translate(6 6)" fill="#fff"/>
                                    </g>
                                    <circle id="Ellipse_6005" data-name="Ellipse 6005" cx="9" cy="9" r="9" transform="translate(8 8)" [ngStyle]="{ fill: routeFocusColors[focusedRouteIndex] }" />
                                    <text x="50%" y="48.5%" dominant-baseline="middle" text-anchor="middle" id="_1" data-name="1" fill="#fff" font-size="11" font-family="Montserrat-Bold, Montserrat" font-weight="700"><tspan>{{ stopPickerLocation.editIndex ? stopPickerLocation.editIndex+1 : routes[focusedRouteIndex].stops.length + 1 }}</tspan></text>
                                </svg>
                            </div>
                            <div class="stop-picker-window">
                                <div class="stop-picker-button" (click)="addNewStop('empty')" [ngClass]="{ 'active': stopPickerLocation.empty == true }">
                                    <div class="stop-picker-button-text">Empty</div>
                                </div>
                                <div class="stop-picker-button" (click)="addNewStop('loaded')" [ngClass]="{ 'active': stopPickerLocation.empty == false }">
                                    <div class="stop-picker-button-text">Loaded</div>
                                </div>
                            </div>
                            <div class="stop-picker-address" [ngStyle]="{ backgroundColor: routeFocusColors[focusedRouteIndex] }">
                                <div class="stop-picker-address-text">{{ stopPickerLocation.address }}</div>
                            </div>
                        </div>
                    </ng-template>
                </agm-snazzy-info-window>
            </agm-marker>
        </agm-map>

        <div id="stopPickerCursor" class="stop-picker-cursor" *ngIf="stopPickerActive && focusedRouteIndex && mapHover">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="34" height="34" viewBox="0 0 34 34">
                <defs>
                  <filter id="Ellipse_9150" x="0" y="0" width="34" height="34" filterUnits="userSpaceOnUse">
                    <feOffset input="SourceAlpha"/>
                    <feGaussianBlur stdDeviation="2" result="blur"/>
                    <feFlood flood-opacity="0.149"/>
                    <feComposite operator="in" in2="blur"/>
                    <feComposite in="SourceGraphic"/>
                  </filter>
                </defs>
                <g transform="matrix(1, 0, 0, 1, 0, 0)" filter="url(#Ellipse_9150)">
                  <circle id="Ellipse_9150-2" data-name="Ellipse 9150" cx="11" cy="11" r="11" transform="translate(6 6)" fill="#fff"/>
                </g>
                <circle id="Ellipse_9149" data-name="Ellipse 9149" cx="9" cy="9" r="9" transform="translate(8 8)" fill="#fd952d"/>
                <text id="_6" data-name="6" transform="translate(17 21.5)" fill="#fff" font-size="12" font-family="Montserrat-Bold, Montserrat" font-weight="700">
                    <tspan x="-3.822" y="0"> {{ routes[focusedRouteIndex].stops.length + 1 }} </tspan>
                </text>
            </svg>
        </div>
    </div>
  </div>
  
  <ng-template #dropdownPopover let-data="data">
    <div class="table-dropdown">
      <div
        (click)="callDropDownAction($event, action)"
        *ngFor="let action of data"
        class="table-dropdown-content"
        [class]="action.class"
      >
        <svg-icon
          [ngClass]="{'activate-header':action.activate,'deactivate-header':action.deactivate}"
          class="action-svg"
          src="{{action.svg}}"
          [svgStyle]="{ 'width.px': 18, 'height.px': 18 }"
        ></svg-icon>
        <div class="dropdown-content-text">{{ action.title }}</div>
      </div>
    </div>
  </ng-template>